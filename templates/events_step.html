<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Events â€” {{ bio_name }}</title>
  <link rel="stylesheet" href="/static/styles.css">
  <style>
    body{ background:#f2f2f2; font-family:sans-serif; padding:30px; }
    .box{ background:#fff; max-width:1000px; margin:auto; padding:24px; border-radius:12px; box-shadow:0 2px 12px rgba(0,0,0,.08); }
    h1{ margin:0 0 6px; }
    .subheading{ color:#555; margin-bottom:16px; }
    .grid{ display:grid; grid-template-columns: 1fr 1fr; gap:16px; }
    @media (max-width:900px){ .grid{ grid-template-columns:1fr; } }
    .card{ background:#fff; border:1px solid #e7e9f2; border-radius:12px; padding:16px; }
    .row{ display:flex; gap:8px; align-items:center; margin-bottom:8px; flex-wrap:wrap; }
    .btn{ padding:8px 14px; border-radius:8px; border:0; cursor:pointer; font-weight:700; }
    .btn.primary{ background:#6c63ff; color:#fff; }
    .btn.outline{ background:#fff; color:#6c63ff; border:1px solid #6c63ff; }
    .small{ font-size:12px; color:#6b7280; }
    .event-row{ border-left:4px solid #e5e7eb; background:#fafafa; border-radius:8px; padding:10px; margin-bottom:10px; }
    select,input[type="text"],input[type="date"]{ padding:8px; border:1px solid #dfe3ee; border-radius:8px; }
  </style>
  <script>
    function buildBioOptionsForTypePayload() {
      try { return JSON.parse(document.getElementById('linkable_payload').textContent || '{}'); }
      catch(e){ return {}; }
    }
    function bioOptionsHtml(type, bag) {
      const arr = bag[type] || [];
      return ['<option value="">(none)</option>'].concat(
        arr.map(b => `<option value="${b.id}">${(b.name||b.id)}</option>`)
      ).join('');
    }
    function addRowFromSelected() {
      const bag = buildBioOptionsForTypePayload();

      const optSel = document.getElementById('option_id');
      const optId  = optSel ? (optSel.value||'') : '';
      const optTxt = optSel ? (optSel.options[optSel.selectedIndex]?.text || optId) : optId;

      const allowedTypeSel = document.getElementById('linkTypeTemplate');
      const firstType = allowedTypeSel?.options[0]?.value || '';

      const timeKindsTemplate = document.getElementById('timeKindsTemplate');

      const wrap = document.getElementById('rows');
      const row  = document.createElement('div');
      row.className = 'event-row';
      row.innerHTML = `
        <div class="row">
          <strong style="min-width:120px">Option:</strong> <span>${optTxt || '(pick above)'}</span>
          <input type="hidden" name="row_option_id[]" value="${optId}">
          <input type="hidden" name="row_option_display[]" value="${optTxt}">
        </div>

        <div class="row">
          <label>Link type</label>
          <select name="row_link_type[]">
            ${Array.from(allowedTypeSel.options).map(o => `<option value="${o.value}">${o.text}</option>`).join('')}
          </select>

          <label>Target</label>
          <select name="row_link_bio[]">${bioOptionsHtml(firstType, bag)}</select>

          <label>Confidence</label>
          <input type="range" name="row_confidence[]" min="0" max="100" value="100" oninput="this.nextElementSibling.textContent=this.value + '%'">
          <span class="small">100%</span>
        </div>

        <div class="row">
          <strong>Time</strong>
          <select name="row_time_kind[]">
            ${Array.from(timeKindsTemplate.options).map(o => `<option value="${o.value}">${o.text}</option>`).join('')}
          </select>
          <input type="date" name="row_date_value[]" placeholder="YYYY-MM-DD">
          <input type="text" name="row_start_date[]" placeholder="start (YYYY|YYYY-MM|YYYY-MM-DD)">
          <input type="text" name="row_end_date[]" placeholder="end (optional)">
          <input type="text" name="row_time_subvalue[]" placeholder="subvalue (e.g. 1920s)">
          <label>Conf</label>
          <input type="range" name="row_time_confidence[]" min="0" max="100" value="100" oninput="this.nextElementSibling.textContent=this.value + '%'">
          <span class="small">100%</span>

          <button type="button" class="btn outline" onclick="this.closest('.event-row').remove()">Remove</button>
        </div>
      `;
      wrap.appendChild(row);

      // wire type->bios for this row
      const tSel = row.querySelector('select[name="row_link_type[]"]');
      const bSel = row.querySelector('select[name="row_link_bio[]"]');
      tSel.addEventListener('change', () => { bSel.innerHTML = bioOptionsHtml(tSel.value, bag); });
    }
  </script>
</head>
<body>
<div class="box">
  <h1>ðŸ§© Events</h1>
  <div class="subheading">
    <strong>{{ bio_name }}</strong> â€¢ {{ type_name|replace('_',' ')|title }}
  </div>

  <script id="linkable_payload" type="application/json">{{ linkable|tojson }}</script>

  <div class="grid">
    <div class="card">
      <h3>Build Events</h3>
      <form method="POST">
        <input type="hidden" name="do_save" value="1">

        <div class="row">
          <label>Group</label>
          <select id="group_key" name="group_key" onchange="this.form.submit()">
            {% for g in groups %}
              <option value="{{ g.key }}" {% if g.key==chosen_group %}selected{% endif %}>{{ g.label }}</option>
            {% endfor %}
          </select>
        </div>

        <div class="row">
          <label>Option</label>
          <select id="option_id" name="option_id" onchange="this.form.submit()">
            <option value="">â€” choose â€”</option>
            {% for o in group_doc.options %}
              <option value="{{ o.id }}" {% if o.id==chosen_option %}selected{% endif %}>{{ o.display or o.id }}</option>
            {% endfor %}
          </select>
          <button type="button" class="btn outline" onclick="addRowFromSelected()">+ Add Row</button>
        </div>

        <!-- hidden templates -->
        <select id="linkTypeTemplate" style="display:none">
          {% for t in allowed_types %}
            <option value="{{ t }}">{{ t|replace('_',' ')|title }}</option>
          {% endfor %}
        </select>

        <select id="timeKindsTemplate" style="display:none">
          <option value="">â€” none â€”</option>
          {% for cat in time_categories %}
            <option value="{{ cat.key }}">{{ cat.desc or cat.key }}</option>
          {% endfor %}
        </select>

        <div id="rows"></div>

        <div style="margin-top:10px">
          <button type="submit" class="btn primary">âœ… Save Events & Continue</button>
        </div>
      </form>
    </div>

    <div class="card">
      <h3>Current Entry â€” Events</h3>
      {% if current_events %}
        <ul class="small" style="margin:0 0 0 16px">
          {% for ev in current_events %}
            <li>
              <strong>{{ ev.option_display or ev.option_id }}</strong>
              {% if ev.linked_type and ev.linked_bio %} â€” <em>{{ ev.linked_type }}</em> â†’ <code>{{ ev.linked_bio }}</code>{% endif %}
              {% if ev.time and ev.time.label_type=='date' %} â€¢ {{ ev.time.date_value }}
              {% elif ev.time and ev.time.label_type=='range' %} â€¢ {{ ev.time.start_date }}â€¦{{ ev.time.end_date }}
              {% elif ev.time and ev.time.subvalue %} â€¢ {{ ev.time.subvalue|replace('_',' ')|title }}
              {% endif %}
              {% if ev.confidence is not none %} ({{ ev.confidence }}%){% endif %}
            </li>
          {% endfor %}
        </ul>
      {% else %}
        <div class="small">No events yet.</div>
      {% endif %}

      <div style="margin-top:10px">
        <a class="btn outline" target="_top"
           href="{{ url_for('general_iframe_wizard', type=type_name, bio_id=bio_id, step='review') }}">Skip to Review</a>
      </div>
    </div>
  </div>
</div>
</body>
</html>

