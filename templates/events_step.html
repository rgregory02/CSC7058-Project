<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Events â€” {{ bio_name }}</title>
  <link rel="stylesheet" href="/static/styles.css">
  <style>
    body{ background:#f2f2f2; font-family:sans-serif; padding:30px; }
    .box{ background:#fff; max-width:1000px; margin:auto; padding:24px; border-radius:12px; box-shadow:0 2px 12px rgba(0,0,0,.08); }
    h1{ margin:0 0 6px; }
    .subheading{ color:#555; margin-bottom:16px; }
    .grid{ display:grid; grid-template-columns: 1fr 1fr; gap:16px; }
    @media (max-width:900px){ .grid{ grid-template-columns:1fr; } }
    .card{ background:#fff; border:1px solid #e7e9f2; border-radius:12px; padding:16px; }
    .row{ display:flex; gap:8px; align-items:center; margin-bottom:8px; flex-wrap:wrap; }
    .btn{ padding:8px 14px; border-radius:8px; border:0; cursor:pointer; font-weight:700; }
    .btn.primary{ background:#6c63ff; color:#fff; }
    .btn.outline{ background:#fff; color:#6c63ff; border:1px solid #6c63ff; }
    .small{ font-size:12px; color:#6b7280; }
    .event-row{ border-left:4px solid #e5e7eb; background:#fafafa; border-radius:8px; padding:10px; margin-bottom:10px; }
    select,input[type="text"],input[type="date"]{ padding:8px; border:1px solid #dfe3ee; border-radius:8px; }
    .hidden{ display:none; }
  </style>

  <script>
    // ---------- helpers ----------
    function parseJSONFromScript(id){
      try{ return JSON.parse(document.getElementById(id).textContent || '{}'); }
      catch(e){ return {}; }
    }
    function biosForTypeOptionHtml(type, bag){
      const arr = bag[type] || [];
      return ['<option value="">(none)</option>']
        .concat(arr.map(b => `<option value="${b.id}">${(b.name||b.id)}</option>`))
        .join('');
    }
    function wireTimeVisibility(row){
      const kindSel = row.querySelector('select[name="row_time_kind[]"]');
      const dateBox = row.querySelector('[data-time="date"]');
      const rangeBox= row.querySelector('[data-time="range"]');
      const subBox  = row.querySelector('[data-time="sub"]');
      const update = () => {
        const k = (kindSel.value||'').trim();
        dateBox.classList.toggle('hidden', k!=='date');
        rangeBox.classList.toggle('hidden', k!=='range');
        subBox.classList.toggle('hidden', !(k && k!=='date' && k!=='range'));
      };
      kindSel.addEventListener('change', update);
      update();
    }

    // OPTIONS is the single source of truth for the "Option" select
    let OPTIONS = [];

    function refreshChildSelect(){
      const optSel = document.getElementById('option_id');
      const childWrap = document.getElementById('child_wrap');
      const childSel  = document.getElementById('child_option_id');
      childSel.innerHTML = '';
      childWrap.classList.add('hidden');

      if(!optSel) return;
      const id = optSel.value;
      const opt = OPTIONS.find(o => o.id === id);
      if(opt && Array.isArray(opt.children) && opt.children.length){
        childWrap.classList.remove('hidden');
        childSel.appendChild(new Option('â€” choose â€”', ''));
        opt.children.forEach(c => {
          childSel.appendChild(new Option(c.label || c.display || c.id, c.id));
        });
      }
    }

    function addRowFromSelected(){
      const linkable = parseJSONFromScript('linkable_payload');

      const optSel   = document.getElementById('option_id');
      const childSel = document.getElementById('child_option_id');
      const optId    = optSel?.value || '';
      const optText  = optSel?.options[optSel.selectedIndex]?.text || optId;

      const childShown = childSel && !childSel.closest('.hidden');
      const childId    = childShown ? (childSel.value || '') : '';
      const childText  = childShown ? (childSel.options[childSel.selectedIndex]?.text || childId) : '';

      const linkTypesTmpl = document.getElementById('linkTypeTemplate');
      const timeKindsTmpl = document.getElementById('timeKindsTemplate');

      const row  = document.createElement('div');
      row.className = 'event-row';
      row.innerHTML = `
        <div class="row">
          <strong style="min-width:120px">Option:</strong>
          <span>${optText || '(pick above)'}${childText ? ' â†’ ' + childText : ''}</span>
          <input type="hidden" name="row_option_id[]" value="${optId}">
          <input type="hidden" name="row_option_display[]" value="${(childText||optText)}">
          <input type="hidden" name="row_child_option_id[]" value="${childId}">
        </div>

        <div class="row">
          <label>Link type</label>
          <select name="row_link_type[]">
            ${Array.from(linkTypesTmpl.options).map(o => `<option value="${o.value}">${o.text}</option>`).join('')}
          </select>

          <label>Target</label>
          <select name="row_link_bio[]">
            ${biosForTypeOptionHtml(linkTypesTmpl.options[0]?.value || '', linkable)}
          </select>

          <label>Confidence</label>
          <input type="range" name="row_confidence[]" min="0" max="100" value="100"
                 oninput="this.nextElementSibling.textContent=this.value + '%'">
          <span class="small">100%</span>

          <button type="button" class="btn outline" onclick="this.closest('.event-row').remove()">Remove</button>
        </div>

        <div class="row">
          <strong>Time</strong>
          <select name="row_time_kind[]">
            ${Array.from(timeKindsTmpl.options).map(o => `<option value="${o.value}">${o.text}</option>`).join('')}
          </select>

          <span data-time="date" class="hidden">
            <input type="date" name="row_date_value[]" placeholder="YYYY-MM-DD">
          </span>

          <span data-time="range" class="hidden">
            <input type="text" name="row_start_date[]" placeholder="start (YYYY|YYYY-MM|YYYY-MM-DD)">
            <input type="text" name="row_end_date[]"   placeholder="end (optional)">
          </span>

          <span data-time="sub" class="hidden">
            <input type="text" name="row_time_subvalue[]" placeholder="e.g. 1920s / ww2 / toddler">
          </span>

          <label>Conf</label>
          <input type="range" name="row_time_confidence[]" min="0" max="100" value="100"
                 oninput="this.nextElementSibling.textContent=this.value + '%'">
          <span class="small">100%</span>
        </div>
      `;
      document.getElementById('rows').appendChild(row);

      const tSel = row.querySelector('select[name="row_link_type[]"]');
      const bSel = row.querySelector('select[name="row_link_bio[]"]');
      tSel.addEventListener('change', () => { bSel.innerHTML = biosForTypeOptionHtml(tSel.value, linkable); });

      wireTimeVisibility(row);
    }

    document.addEventListener('DOMContentLoaded', () => {
      // single source of truth for options
      OPTIONS = {{ (options | default([], true)) | tojson }};
      refreshChildSelect();
      document.getElementById('option_id')?.addEventListener('change', refreshChildSelect);
    });
  </script>
</head>
<body>
<div class="box">
  <h1>ðŸ§© Events</h1>
  <div class="subheading">
    <strong>{{ bio_name }}</strong> â€¢ {{ type_name|replace('_',' ')|title }}
  </div>

  <!-- Linkable biographies payload: { "<type>":[{id,name,description,updated},...] } -->
  <script id="linkable_payload" type="application/json">{{ (linkable or {})|tojson }}</script>

  <div class="grid">
    <div class="card">
      <h3>Build Events</h3>
      <form method="POST">
        <input type="hidden" name="do_save" value="1">

        <div class="row">
          <label>Group</label>
          <select id="group_key" name="group_key" onchange="this.form.submit()">
            {% for g in groups %}
              <option value="{{ g.key }}" {% if g.key==chosen_group %}selected{% endif %}>{{ g.label }}</option>
            {% endfor %}
          </select>
        </div>

        <div class="row">
          <label>Option</label>
          <select id="option_id" name="option_id">
            <option value="">â€” choose â€”</option>
            {% for o in (options or []) %}
              <option value="{{ o.id }}" {% if o.id==chosen_option %}selected{% endif %}>
                {{ o.display or o.label or o.id }}
              </option>
            {% endfor %}
          </select>

          <span id="child_wrap" class="hidden" style="display:inline-flex;gap:8px;align-items:center">
            <label>Child</label>
            <select id="child_option_id" name="child_option_id"></select>
          </span>

          <button type="button" class="btn outline" onclick="addRowFromSelected()">+ Add Row</button>
        </div>

        <!-- hidden templates -->
        <select id="linkTypeTemplate" class="hidden">
          {% for t in allowed_types %}
            <option value="{{ t }}">{{ t|replace('_',' ')|title }}</option>
          {% endfor %}
        </select>

        <select id="timeKindsTemplate" class="hidden">
          <option value="">â€” none â€”</option>
          {% for cat in time_categories %}
            <option value="{{ cat.key }}">{{ cat.desc or cat.key }}</option>
          {% endfor %}
        </select>

        <div id="rows"></div>

        <div style="margin-top:10px">
          <button type="submit" class="btn primary">âœ… Save Events & Continue</button>
        </div>
      </form>
    </div>

    <div class="card">
      <h3>Current Entry â€” Events</h3>
      {% if current_events %}
        <ul class="small" style="margin:0 0 0 16px">
          {% for ev in current_events %}
            <li>
              <strong>{{ ev.option_display or ev.option_id }}</strong>
              {% if ev.link_type and ev.linked_bio %}
                â€” <em>{{ ev.link_type }}</em> â†’ <code>{{ ev.linked_bio }}</code>
              {% endif %}
              {% if ev.time and ev.time.label_type=='date' %} â€¢ {{ ev.time.date_value }}
              {% elif ev.time and ev.time.label_type=='range' %} â€¢ {{ ev.time.start_date }}â€¦{{ ev.time.end_date }}
              {% elif ev.time and ev.time.subvalue %} â€¢ {{ ev.time.subvalue|replace('_',' ')|title }}
              {% endif %}
              {% if ev.confidence is not none %} ({{ ev.confidence }}%){% endif %}
            </li>
          {% endfor %}
        </ul>
      {% else %}
        <div class="small">No events yet.</div>
      {% endif %}

      <div style="margin-top:10px">
        <a class="btn outline" target="_top"
           href="{{ url_for('general_iframe_wizard', type=type_name, bio_id=bio_id, step='review') }}">Skip to Review</a>
      </div>
    </div>
  </div>
</div>
</body>
</html>


