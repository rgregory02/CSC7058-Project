<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>{{ type_name|replace('_',' ')|title }} ‚Äì Biographies</title>
  <link rel="stylesheet" href="/static/styles.css">
  <style>
    body { background:#f6f7fb; font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial; }
    .box { max-width: 1100px; margin: 40px auto; background:#fff; padding:28px; border-radius:14px; box-shadow:0 8px 24px rgba(0,0,0,.06); }
    h1 { margin: 0 0 14px; }
    .toolbar { display:flex; flex-wrap:wrap; gap:10px; align-items:center; margin:12px 0 18px; }
    .toolbar .spacer { flex:1; }
    .btn{display:inline-block;padding:9px 14px;border-radius:10px;background:#6c63ff;color:#fff;text-decoration:none;font-weight:600}
    .btn.secondary{background:#eef0f7;color:#333}
    .btn.ghost{background:transparent;color:#6c63ff;border:1px solid #6c63ff}
    .btn.mini{ padding:6px 10px; font-size:12px; border-radius:8px; }
    .controls { display:flex; flex-wrap:wrap; gap:10px; margin:8px 0 18px; }
    .controls input[type="search"], .controls select {
      padding:10px 12px; border:1px solid #dfe3ee; border-radius:10px; background:#fff; min-width:220px;
    }
    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:14px}

    /* clickable cards */
    .card-link{ display:block; text-decoration:none; color:inherit; }
    .card{background:#fff;border:1px solid #e7e9f2;border-radius:12px;padding:16px; transition:transform .12s ease, box-shadow .12s ease; cursor:pointer; position:relative;}
    .card-link:hover .card{ transform:translateY(-2px); box-shadow:0 8px 18px rgba(0,0,0,.07); }
    .card h3{margin:0 0 6px;font-size:18px}
    .muted{color:#657085;font-size:12px}
    .desc{color:#3a3f4c;font-size:13px;margin:6px 0 10px}
    .quick{display:flex;flex-wrap:wrap;gap:6px}
    .empty{padding:24px;border:1px dashed #dfe3ee;border-radius:12px;text-align:center;color:#657085;background:#fafbff}

    .badge { position:absolute; top:10px; right:10px; font-size:11px; padding:3px 8px; border-radius:999px; background:#f3f4f6; color:#374151; border:1px solid #e5e7eb; }
    .badge.archived { background:#fff1f2; color:#b91c1c; border-color:#fecdd3; }
    .actions-row { margin-top:10px; display:flex; gap:8px; flex-wrap:wrap; }
    .action-form { display:inline; }
  </style>
</head>
<body>
  <div class="box">
    <h1>{{ type_name|replace('_',' ')|title }} ‚Äì Biographies</h1>

    <div class="toolbar">
      <a class="btn ghost" href="{{ url_for('dashboard') }}">‚¨ÖÔ∏è Back to Dashboard</a>
      <!-- Launch the General Wizard, pre-selecting this type on Start -->
      <a class="btn" href="{{ url_for('general_iframe_wizard', step='start', type=type_name) }}">‚ûï New Biography</a>
      <a class="btn secondary" href="{{ url_for('create_subfolder', type_name=type_name, return_url=request.url) }}">üè∑Ô∏è Add Label Group</a>
      <span class="spacer"></span>
      <!-- View toggles -->
      <a class="btn secondary{% if show=='' %} ghost{% endif %}"
         href="{{ url_for('type_browse', type_name=type_name) }}">Active</a>
      <a class="btn secondary{% if show=='archived' %} ghost{% endif %}"
         href="{{ url_for('type_browse', type_name=type_name, show='archived') }}">Archived</a>
      <a class="btn secondary{% if show=='all' %} ghost{% endif %}"
         href="{{ url_for('type_browse', type_name=type_name, show='all') }}">All</a>
    </div>

    <div class="controls">
      <input type="search" id="searchInput" placeholder="Search {{ type_name|replace('_',' ')|title }} biographies‚Ä¶"
             oninput="filterCards()">
      <select id="sortSelect" onchange="sortAllGrids()">
        <option value="updated_desc">Sort: Recent first</option>
        <option value="updated_asc">Sort: Oldest first</option>
        <option value="name_asc">Sort: Name A‚ÄìZ</option>
        <option value="name_desc">Sort: Name Z‚ÄìA</option>
      </select>
    </div>

    {% set have_split = active_bios is defined or archived_bios is defined %}
    {% if have_split %}
      {# ---------------- Active ---------------- #}
      {% if show != 'archived' %}
        <h3 style="margin:8px 0 6px">üìö Active</h3>
        {% if active_bios and active_bios|length %}
          <div id="grid_active" class="grid">
            {% for b in active_bios %}
              {% set _id = b.get('id') %}
              {% set _name = b.get('name') or _id.replace('_',' ')|title %}
              {% set _desc = b.get('description') %}
              {% set _stamp = b.get('updated') or b.get('created') %}
              <div class="card-wrap" data-name="{{ _name|lower }}" data-updated="{{ _stamp or '' }}">
                <a class="card-link" href="{{ url_for('biography_view', type_name=type_name, bio_id=_id) }}">
                  <div class="card" role="button" aria-label="View {{ _name }}">
                    <h3>{{ _name }}</h3>
                    {% if _desc %}<div class="desc">{{ _desc }}</div>{% endif %}
                    <div class="muted">
                      {% if _stamp %}
                        <span class="updated" data-iso="{{ _stamp }}">{{ _stamp }}</span>
                      {% else %}
                        No timestamp
                      {% endif %}
                    </div>
                  </div>
                </a>
                <div class="actions-row">
                  <a class="btn mini secondary" href="{{ url_for('biography_view', type_name=type_name, bio_id=_id) }}">üîé View</a>
                  <form class="action-form" method="post" action="{{ url_for('api_archive_bio', type_name=type_name, bio_id=_id) }}">
                    <button class="btn mini secondary" type="submit" onclick="return confirm('Archive this biography? You can unarchive later.')">üóÑÔ∏è Archive</button>
                  </form>
                </div>
              </div>
            {% endfor %}
          </div>
        {% else %}
          <div class="empty">No active biographies.</div>
        {% endif %}
      {% endif %}

      {# ---------------- Archived ---------------- #}
      {% if show in ['archived','all'] %}
        <h3 style="margin:18px 0 6px">üóÑÔ∏è Archived</h3>
        {% if archived_bios and archived_bios|length %}
          <div id="grid_archived" class="grid">
            {% for b in archived_bios %}
              {% set _id = b.get('id') %}
              {% set _name = b.get('name') or _id.replace('_',' ')|title %}
              {% set _desc = b.get('description') %}
              {% set _stamp = b.get('updated') or b.get('archived_at') or b.get('created') %}
              <div class="card-wrap" data-name="{{ _name|lower }}" data-updated="{{ _stamp or '' }}">
                <a class="card-link" href="{{ url_for('biography_view', type_name=type_name, bio_id=_id) }}">
                  <div class="card" role="button" aria-label="View {{ _name }}">
                    <span class="badge archived">Archived</span>
                    <h3>{{ _name }}</h3>
                    {% if _desc %}<div class="desc">{{ _desc }}</div>{% endif %}
                    <div class="muted">
                      {% if _stamp %}
                        <span class="updated" data-iso="{{ _stamp }}">{{ _stamp }}</span>
                      {% else %}
                        No timestamp
                      {% endif %}
                    </div>
                  </div>
                </a>
                <div class="actions-row">
                  <a class="btn mini secondary" href="{{ url_for('biography_view', type_name=type_name, bio_id=_id) }}">üîé View</a>
                  <form class="action-form" method="post" action="{{ url_for('api_unarchive_bio', type_name=type_name, bio_id=_id) }}">
                    <button class="btn mini secondary" type="submit">‚Ü©Ô∏è Unarchive</button>
                  </form>
                </div>
              </div>
            {% endfor %}
          </div>
        {% else %}
          <div class="empty">No archived biographies.</div>
        {% endif %}
      {% endif %}
    {% else %}
      {# Fallback when only 'bios' is provided #}
      {% if bios and bios|length > 0 %}
        <div id="grid_fallback" class="grid">
          {% for b in bios %}
            {% set _id = b.get('id') %}
            {% set _name = b.get('name') or _id.replace('_',' ')|title %}
            {% set _desc = b.get('description') %}
            {% set _stamp = b.get('updated') or b.get('created') %}
            {% set _arch = b.get('archived') %}
            <div class="card-wrap" data-name="{{ _name|lower }}" data-updated="{{ _stamp or '' }}">
              <a class="card-link" href="{{ url_for('biography_view', type_name=type_name, bio_id=_id) }}">
                <div class="card" role="button" aria-label="View {{ _name }}">
                  {% if _arch %}<span class="badge archived">Archived</span>{% endif %}
                  <h3>{{ _name }}</h3>
                  {% if _desc %}<div class="desc">{{ _desc }}</div>{% endif %}
                  <div class="muted">
                    {% if _stamp %}
                      <span class="updated" data-iso="{{ _stamp }}">{{ _stamp }}</span>
                    {% else %}
                      No timestamp
                    {% endif %}
                  </div>
                </div>
              </a>
              <div class="actions-row">
                <a class="btn mini secondary" href="{{ url_for('biography_view', type_name=type_name, bio_id=_id) }}">üîé View</a>
                {% if _arch %}
                  <form class="action-form" method="post" action="{{ url_for('api_unarchive_bio', type_name=type_name, bio_id=_id) }}">
                    <button class="btn mini secondary" type="submit">‚Ü©Ô∏è Unarchive</button>
                  </form>
                {% else %}
                  <form class="action-form" method="post" action="{{ url_for('api_archive_bio', type_name=type_name, bio_id=_id) }}">
                    <button class="btn mini secondary" type="submit" onclick="return confirm('Archive this biography? You can unarchive later.')">üóÑÔ∏è Archive</button>
                  </form>
                {% endif %}
              </div>
            </div>
          {% endfor %}
        </div>
      {% else %}
        <div class="empty">
          No biographies yet for <strong>{{ type_name|replace('_',' ')|title }}</strong>.<br>
          Click <em>New Biography</em> to create your first one.
        </div>
      {% endif %}
    {% endif %}
  </div>

  <script>
    function filterCards() {
      const q = (document.getElementById('searchInput').value || '').trim().toLowerCase();
      document.querySelectorAll('[id^="grid_"] .card-wrap, #grid_fallback .card-wrap').forEach(c => {
        const name = c.getAttribute('data-name') || '';
        c.style.display = name.includes(q) ? '' : 'none';
      });
    }

    function sortGrid(gridId) {
      const grid = document.getElementById(gridId);
      if (!grid) return;
      const mode = document.getElementById('sortSelect').value;
      const cards = Array.from(grid.querySelectorAll('.card-wrap'));
      cards.sort((a, b) => {
        const nameA = (a.getAttribute('data-name') || '');
        const nameB = (b.getAttribute('data-name') || '');
        const dateA = Date.parse(a.getAttribute('data-updated') || '') || 0;
        const dateB = Date.parse(b.getAttribute('data-updated') || '') || 0;

        switch (mode) {
          case 'updated_asc':  return dateA - dateB;
          case 'name_asc':     return nameA.localeCompare(nameB);
          case 'name_desc':    return nameB.localeCompare(nameA);
          case 'updated_desc':
          default:             return dateB - dateA;
        }
      });
      cards.forEach(c => grid.appendChild(c));
    }

    function sortAllGrids() {
      sortGrid('grid_active');
      sortGrid('grid_archived');
      sortGrid('grid_fallback');
    }

    // Format timestamps to UK time (Europe/London) once the DOM is ready
    function formatUKTimes() {
      const nodes = document.querySelectorAll('.updated[data-iso]');
      nodes.forEach(n => {
        const iso = n.getAttribute('data-iso') || '';
        const d = new Date(iso);
        if (!isNaN(d)) {
          const uk = d.toLocaleString('en-GB', {
            timeZone: 'Europe/London',
            dateStyle: 'medium',
            timeStyle: 'short'
          });
          n.textContent = `Last updated: ${uk}`;
        }
      });
    }

    document.addEventListener('DOMContentLoaded', () => {
      sortAllGrids();
      formatUKTimes();
    });
  </script>
</body>
</html>




