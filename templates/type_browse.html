<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>{{ type_name|replace('_',' ')|title }} ‚Äì Biographies</title>
  <link rel="stylesheet" href="/static/styles.css">
<style>
  :root{
    --bg:#f6f7fb; --card:#fff; --ink:#111827; --muted:#657085; --line:#e7e9f2;
    --brand:#6c63ff; --pill:#eef0f7;
    --danger:#c62828; --success:#0b6230; --warn:#7a4b00;
    --arch:#f8fafc;
  }
  body{background:var(--bg);font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;color:var(--ink)}
  .box{max-width:1100px;margin:36px auto;background:var(--card);padding:24px;
       border-radius:14px;box-shadow:0 8px 24px rgba(0,0,0,.06);border:1px solid var(--line)}
  h1{margin:0 0 8px;font-size:28px;font-weight:750}
  h2{margin:0 0 6px;font-size:22px;font-weight:730}
  h3{margin:0 0 6px;font-size:16px;font-weight:700}
  .muted{color:var(--muted)}

  /* toolbar */
  .toolbar{display:flex;gap:10px;align-items:center;flex-wrap:wrap;justify-content:space-between;margin:12px 0 16px}
  .toolbar .left,.toolbar .right{display:flex;gap:10px;align-items:center}
  .toolbar .spacer{flex:1}

  /* inputs */
  .search,.select{padding:10px 12px;border:1px solid var(--line);border-radius:10px;background:#fff;min-width:220px}
  .search{flex:1}

  /* buttons */
  .btn{display:inline-flex;align-items:center;justify-content:center;gap:6px;
       padding:9px 14px;border-radius:10px;font-weight:600;text-decoration:none;cursor:pointer;
       background:var(--brand);color:#fff;border:1px solid var(--brand)}
  .btn.secondary{background:var(--pill);color:#333;border-color:var(--line)}
  .btn.ghost{background:transparent;color:var(--brand);border:1px solid var(--brand)}
  .btn.danger{background:var(--danger);color:#fff;border-color:var(--danger)}
  .btn.archive{background:#f5f7ff;color:#2b2f5e;border:1px solid #d9ddff}
  .btn.restore{background:#e9fbf0;color:var(--success);border:1px solid #b9efcc}
  .btn.mini{padding:6px 10px;font-size:12px;border-radius:8px}

  /* grid & cards */
  .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(300px,1fr));gap:14px;align-items:start}

  .card{
    border:1px solid var(--line);border-radius:12px;padding:14px;background:#fff;
    display:flex;flex-direction:column;gap:10px;position:relative;
    transition:transform .12s,box-shadow .12s;
  }
  .card:hover{transform:translateY(-2px);box-shadow:0 8px 18px rgba(0,0,0,.07)}
  .card.archived{background:var(--arch);border-style:dashed;opacity:.85}
  .title{margin:0;font-size:16px;font-weight:800;line-height:1.2}
  .desc{color:#4b5563;font-size:13px;line-height:1.35}
  .actions{display:flex;gap:8px;margin-top:auto;flex-wrap:wrap}

  /* chips & badges */
  .chips{display:flex;flex-wrap:wrap;gap:6px;margin-top:4px}
  .chip{font-size:11px;border-radius:999px;padding:3px 8px;background:#f3f4f9;border:1px solid #e6e8f2;color:#445}
  .chip.badge{background:#fafbff;border-color:#e7e9f2}
  .chip.path{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,monospace}
  .chip.archived{background:#fff4e6;border-color:#ffd8a8;color:var(--warn)}
  .card > .badge {
    position: absolute;top: 10px;right: 10px;font-size: 11px;
    padding: 3px 8px;border-radius: 999px;background: #f3f4f6;color: #374151;
    border: 1px solid #e5e7eb;
  }
  .card > .badge.archived { background: #fff1f2; color: #b91c1c; border-color: #fecdd3; }

  /* special case: folder <details> */
  details.card { border:1px solid var(--line); border-radius:12px; background:#fff; padding:0; }
  details.card > summary { list-style:none; padding:12px 14px; border-radius:12px; cursor:pointer; }
  details.card > summary::-webkit-details-marker { display:none; }
  details.card[open] > summary { border-bottom:1px dashed var(--line); border-bottom-left-radius:0; border-bottom-right-radius:0; }
  details.card .title { display:flex; align-items:center; gap:8px; }
  details.card .chip.badge { margin-left:auto; }
  details.card > div { padding:12px 14px; }

  /* tip banners */
  .tip-banner{
    display:flex;align-items:flex-start;gap:10px;
    background:linear-gradient(270deg,#e0e7ff,#f3e8ff,#e0e7ff);
    background-size:600% 600%;
    border:1px solid #c7d2fe;
    color:#1e1b4b;
    padding:12px 14px;
    border-radius:10px;
    animation: shimmer 8s ease infinite, tipEnter .6s ease;
  }
  @keyframes shimmer{
    0%{background-position:0% 50%}
    50%{background-position:100% 50%}
    100%{background-position:0% 50%}
  }
  .tip-dot{
    width:10px;height:10px;border-radius:999px;background:#6366f1;margin-top:4px;
    box-shadow:0 0 0 0 rgba(99,102,241,.6);animation:tipPulse 1.8s ease-in-out infinite;flex:0 0 auto;
  }
  .muted-small{color:#6b7280;font-size:12px;}
  @keyframes tipEnter{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:translateY(0)}}
  @keyframes tipPulse{
    0%{box-shadow:0 0 0 0 rgba(59,130,246,.6)}
    70%{box-shadow:0 0 0 10px rgba(59,130,246,0)}
    100%{box-shadow:0 0 0 0 rgba(59,130,246,0)}
  }

  /* ====== Card robustness overrides (fight global link styles) ====== */
  .card-link{display:block}
  a.card-link, .card-link * { text-decoration:none !important; color:inherit !important; }
  .card-link:hover .card { transform:translateY(-2px); box-shadow:0 8px 18px rgba(0,0,0,.07); }

  /* Optional: neat button row below each card */
  .actions-row{ display:flex; gap:8px; flex-wrap:wrap; padding:10px 0 2px; }

  /* Make the title-link behave like plain text inside the card */
.title-link { text-decoration: none; color: inherit; }
.title-link:focus-visible { outline: 2px solid #c7d2fe; border-radius: 6px; }

/* Spacing for actions row when it's inside the card */
.card .actions-row { display:flex; gap:8px; flex-wrap:wrap; margin-top:8px; }

/* Normalise anchors + buttons that use .btn */
.btn {
  appearance: none;
  -webkit-appearance: none;
  font: inherit;            /* kill default button font */
  line-height: 1.15;        /* consistent height */
  display: inline-flex;
  align-items: center;
  justify-content: center;
  gap: 6px;
  padding: 9px 14px;
  border-radius: 10px;
  text-decoration: none;
  cursor: pointer;
  border-width: 1px;
  border-style: solid;
}

/* Make the mini buttons equal width and neatly centered in the card */
.card .actions-row {
  display: flex;
  gap: 8px;
  flex-wrap: wrap;
  justify-content: center;  /* center inside the card */
  margin-top: 8px;
}

.actions-row .btn.mini {
  padding: 8px 12px;        /* same vertical rhythm */
  min-width: 110px;         /* equal visual width */
  text-align: center;
}

/* Remove default form margins that push things around */
.action-form { margin: 0; }

/* --- Equalize size & center the two action buttons inside cards --- */
.card .actions-row{
  display:flex;
  gap:8px;
  flex-wrap:wrap;
  justify-content:center;
  margin-top:12px;
}

/* One rule for *both* buttons so they are identical size */
.actions-row > a.btn.mini.secondary,
.actions-row form .btn.mini.secondary{
  font: inherit;                 /* kill UA button font */
  line-height: 1.15;
  display:inline-flex;
  align-items:center;
  justify-content:center;
  gap:6px;

  /* hard-size so they match exactly */
  height: 44px;
  min-width: 120px;
  padding: 0 14px;

  border-radius:12px;
  border-width:1px;
  border-style:solid;
  text-decoration:none;
}

/* View (anchor) ‚Äì indigo tint */
.actions-row > a.btn.mini.secondary{
  background:#eef2ff;
  border-color:#c7d2fe;
  color:#3730a3;
}
.actions-row > a.btn.mini.secondary:hover{
  background:#e0e7ff;
}

/* Archive (button in form) ‚Äì warm amber tint */
.actions-row form .btn.mini.secondary{
  background:#fff7ed;
  border-color:#fed7aa;
  color:#7c2d12;
}
.actions-row form .btn.mini.secondary:hover{
  background:#ffedd5;
}

/* Remove any stray spacing from the form wrapper */
.action-form{ margin:0; }

/* Center the row and align items on the same baseline */
.card .actions-row{
  display:flex;
  justify-content:center;
  align-items:center;     /* <- keep both buttons on the same vertical line */
  gap:12px;
  margin-top:12px;
}

/* Make both the anchor and the button share the exact same box model */
.actions-row > a.btn.mini.secondary,
.actions-row form .btn.mini.secondary{
  box-sizing:border-box;  /* identical sizing */
  display:inline-flex;
  align-items:center;
  justify-content:center;
  gap:6px;

  height:44px;            /* identical height */
  min-width:120px;        /* identical width */
  padding:0 14px;         /* identical padding */
  line-height:1;          /* kill text baseline differences */
  vertical-align:middle;  /* belt-and-braces for inline-flex */
  border-radius:12px;
  border-width:1px;
  border-style:solid;
  text-decoration:none;
  font: inherit;          /* same font metrics */
}

/* View ‚Äì indigo tint */
.actions-row > a.btn.mini.secondary{
  background:#eef2ff;
  border-color:#c7d2fe;
  color:#3730a3;
}
.actions-row > a.btn.mini.secondary:hover{ background:#e0e7ff; }

/* Archive ‚Äì warm amber tint */
.actions-row form .btn.mini.secondary{
  background:#fff7ed;
  border-color:#fed7aa;
  color:#7c2d12;
}
.actions-row form .btn.mini.secondary:hover{ background:#ffedd5; }

/* Ensure the wrapper form doesn't introduce offset */
.action-form{ margin:0; padding:0; }

/* === Biography card buttons ‚Äî match Properties/Labels === */
/* Keep size/centering from your current rules, but recolor to:
   - View  -> solid brand (same as Edit)
   - Archive -> white background with soft red outline (same as Archive)
*/

/* VIEW (anchor) -> solid brand button */
.actions-row > a.btn.mini.secondary{
  background: var(--brand) !important;
  border-color: var(--brand) !important;
  color: #fff !important;
}
.actions-row > a.btn.mini.secondary:hover{
  background: #5a52ff !important; /* slightly darker brand on hover */
}

/* ARCHIVE (button in form) -> soft red outline */
.actions-row form .btn.mini.secondary{
  background: #fff !important;
  border-color: #f3c7cd !important;   /* soft red outline */
  color: #8b2c2c !important;          /* warm red text */
}
.actions-row form .btn.mini.secondary:hover{
  background: #fff5f6 !important;
  border-color: #eaa6af !important;
}
/* === Unified Archive Button Style === */
.btn.archive,
.actions-row form .btn.mini.secondary,   /* bios archive buttons */
.card .actions .btn.archive,             /* property cards */
.card .actions .btn.action.archive {     /* label cards */
  background: #f5f7ff;        /* pale blue background */
  color: #2b2f5e;             /* dark neutral text */
  border: 1px solid #d9ddff;  /* light indigo/blue border */
  box-sizing: border-box;
  display: inline-flex;
  align-items: center;
  justify-content: center;
  gap: 6px;
  height: 40px;               /* consistent height */
  min-width: 120px;           /* consistent width */
  padding: 0 14px;
  border-radius: 10px;
  font-weight: 600;
  cursor: pointer;
  transition: background-color .15s ease, border-color .15s ease;
}

.btn.archive:hover,
.actions-row form .btn.mini.secondary:hover,
.card .actions .btn.archive:hover,
.card .actions .btn.action.archive:hover {
  background: #e0e7ff;        /* slightly darker blue on hover */
  border-color: #c7d2fe;
}

/* FINAL OVERRIDE: make all Archive buttons light blue */
.actions-row form button.btn.mini.secondary {
  background: #f5f7ff !important;     /* pale blue */
  border-color: #d9ddff !important;
  color: #2b2f5e !important;
}
.actions-row form button.btn.mini.secondary:hover {
  background: #e0e7ff !important;
  border-color: #c7d2fe !important;
}

</style>
</head>
<body>
  <div class="box">
{# ---- reusable biography card ---- #}
{% macro bio_card(b, type_name, is_archived=None) %}
  {# Extract fields regardless of shape (tree item vs flat bio) #}
  {% set _id    = b.get('id') or b.get('key') %}
  {% set _name  = b.get('title') or b.get('name') or (_id and _id.replace('_',' ')|title) %}
  {% set _desc  = b.get('description') %}
  {% set _stamp = b.get('updated') or b.get('archived_at') or b.get('created') %}
  {% set _arch  = (is_archived if is_archived is not none else b.get('archived')) %}
  {% set _path  = b.get('path_rel') %}

  {# Build URLs: folder tree uses bio_path; flat lists use bio_id #}
  {% if _path %}
    {% set view_url      = url_for('biography_view_path', type_name=type_name, bio_path=_path) %}
    {% set archive_url   = url_for('api_archive_bio_path',   type_name=type_name) %}
    {% set unarchive_url = url_for('api_unarchive_bio_path', type_name=type_name) %}
  {% else %}
    {% set view_url      = url_for('biography_view', type_name=type_name, bio_id=_id) %}
    {% set archive_url   = url_for('api_archive_bio',   type_name=type_name, bio_id=_id) %}
    {% set unarchive_url = url_for('api_unarchive_bio', type_name=type_name, bio_id=_id) %}
  {% endif %}

  <div class="card-wrap"
       data-key="{{ (_name ~ ' ' ~ (_id or '') ~ ' ' ~ (b.get('path_rel') or ''))|lower }}"
       data-status="{{ 'archived' if _arch else 'active' }}"
       data-updated="{{ _stamp or '' }}">
    <a class="card-link" href="{{ view_url }}">
      <div class="card {% if _arch %}archived{% endif %}" role="button" aria-label="View {{ _name }}">
        {% if _arch %}<span class="badge archived">Archived</span>{% endif %}
        <h3 class="title">{{ _name }}</h3>
        {% if _desc %}<div class="desc">{{ _desc }}</div>{% endif %}
        <div class="muted">
          {% if _stamp %}
            <span class="updated" data-iso="{{ _stamp }}">{{ _stamp }}</span>
          {% else %}No timestamp{% endif %}
        </div>
      </div>
    </a>
    <div class="actions-row">
      <a class="btn mini secondary" href="{{ view_url }}">üîé View</a>

      {% if not _arch %}
        <form class="action-form" method="post" action="{{ archive_url }}">
          {% if _path %}<input type="hidden" name="bio_path" value="{{ _path }}">{% endif %}
          <input type="hidden" name="next" value="{{ request.full_path or url_for('type_browse', type_name=type_name, show=show) }}">
          <button class="btn mini secondary" type="submit"
                  onclick="return confirm('Archive this biography? You can unarchive later.')">üóÑÔ∏è Archive</button>
        </form>
      {% else %}
        <form class="action-form" method="post" action="{{ unarchive_url }}">
          {% if _path %}<input type="hidden" name="bio_path" value="{{ _path }}">{% endif %}
          <input type="hidden" name="next" value="{{ request.full_path or url_for('type_browse', type_name=type_name, show=show) }}">
          <button class="btn mini secondary" type="submit">‚Ü©Ô∏è Unarchive</button>
        </form>
      {% endif %}
    </div>
  </div>
{% endmacro %}

{% macro render_folder(node, prefix="") %}
  {# 1) Render biographies in this folder (render ALL; filter in JS) #}
  {% if node['items'] %}
    <div class="grid">
  {% for it in node['items'] %}
  {% set is_archived = it.archived %}
  <div class="card-wrap"
       data-key="{{ (it.title ~ ' ' ~ it.key ~ ' ' ~ prefix)|lower }}"
       data-status="{{ 'archived' if is_archived else 'active' }}"
       data-updated="{{ it.updated or '' }}">

    <div class="card {% if is_archived %}archived{% endif %}">
      {% if is_archived %}<span class="badge archived">Archived</span>{% endif %}

      {# Make only the title a link to avoid nesting buttons inside <a> #}
      <a class="title-link"
         href="{{ url_for('biography_view_path', type_name=type_name, bio_path=it.path_rel) }}">
        <h3 class="title">{{ it.title or it.key }}</h3>
      </a>

      <div class="desc">
        {% if it.updated %}<span class="chip badge">updated: {{ it.updated }}</span>{% endif %}
        {% if prefix %}<span class="chip path">in: {{ prefix }}</span>{% endif %}
      </div>

      <div class="actions-row">
        <a class="btn mini secondary"
           href="{{ url_for('biography_view_path', type_name=type_name, bio_path=it.path_rel) }}">üîé View</a>

        {% if not is_archived %}
          <form class="action-form" method="post"
                action="{{ url_for('api_archive_bio_path', type_name=type_name) }}">
            <input type="hidden" name="bio_path" value="{{ it.path_rel }}">
            <input type="hidden" name="next" value="{{ request.full_path or url_for('type_browse', type_name=type_name, show=show) }}">
            <button class="btn mini secondary" type="submit"
                    onclick="return confirm('Archive this biography? You can unarchive later.')">üóÑÔ∏è Archive</button>
          </form>
        {% else %}
          <form class="action-form" method="post"
                action="{{ url_for('api_unarchive_bio_path', type_name=type_name) }}">
            <input type="hidden" name="bio_path" value="{{ it.path_rel }}">
            <input type="hidden" name="next" value="{{ request.full_path or url_for('type_browse', type_name=type_name, show=show) }}">
            <button class="btn mini secondary" type="submit">‚Ü©Ô∏è Unarchive</button>
          </form>
        {% endif %}
      </div>
    </div>
  </div>
{% endfor %}
    </div>
  {% endif %}

  {# 2) Render child folders recursively #}
  {% for fname, child in node['folders']|dictsort %}
    {% set folder_label = fname.replace('_',' ')|title %}
    <details class="card" open>
      <summary class="title">
        <span>üìÅ {{ folder_label }}</span>
        <span class="chip badge">{{ child['items']|length }} item{{ '' if child['items']|length == 1 else 's' }}</span>
      </summary>
      <div>
        {{ render_folder(child, (prefix ~ '/' if prefix else '') ~ fname) }}
      </div>
    </details>
  {% endfor %}
{% endmacro %}
    <h1>üìö {{ type_name|replace('_',' ')|title }} - Biographies</h1>
    <div class="muted">
  Browse, search, and manage all biographies for this type. Each biography captures labels, events, and linked data over time.
</div>

<div class="toolbar">
  <div class="left">
    <input id="search" class="search"
           placeholder="Search {{ type_name|replace('_',' ')|title }} biographies‚Ä¶"
           oninput="filterBios(this.value)">
    <select id="statusFilter" class="select" onchange="applyFilters()" title="Show Active or Archived">
      <option value="">All statuses</option>
      <option value="active" {% if show=='' %}selected{% endif %}>Active</option>
      <option value="archived" {% if show=='archived' %}selected{% endif %}>Archived</option>
    </select>
  </div>
  <div class="right">
    <a class="btn ghost" href="{{ url_for('dashboard') }}">‚¨ÖÔ∏è Back to Dashboard</a>

    <a class="btn"
       href="{{ url_for('general_iframe_wizard',
                        step='start',
                        type_name=type_name,
                        return_url=url_for('type_browse', type_name=type_name)) }}">
      ‚ûï New Biography
    </a>

    <a class="btn secondary" href="{{ url_for('type_properties', type_name=type_name) }}">‚öôÔ∏è Manage Properties</a>
    <a class="btn secondary" href="{{ url_for('type_labels', type_name=type_name,
                                             return_url=url_for('type_browse', type_name=type_name)) }}">üè∑Ô∏è Manage Labels</a>
  </div>
</div>

<!-- Consistent tip banner -->
<div class="tip-banner">
  <span class="tip-dot" aria-hidden="true"></span>
  <div>
    <strong>Tip:</strong> Click a biography card to review, edit, or update it.  
    From the biography page you can open <em>üß† Most Like</em> to discover the closest matches
    <span class="muted-small">(lower MSE = more similar)</span>.
  </div>
</div>

 <div class="controls">
  <select id="sortSelect" onchange="sortAllGrids()">
    <option value="updated_desc">Sort: Recent first</option>
    <option value="updated_asc">Sort: Oldest first</option>
    <option value="name_asc">Sort: Name A‚ÄìZ</option>
    <option value="name_desc">Sort: Name Z‚ÄìA</option>
  </select>
</div>

{# If the route provided a folder tree, render that. Otherwise keep the split/flat lists. #}
{% if tree is defined %}
  {{ render_folder(tree, "") }}
{% else %}
  {% set have_split = active_bios is defined or archived_bios is defined %}
  {% if have_split %}
    {# ---------------- Active ---------------- #}
    {% if show != 'archived' %}
      <h3 style="margin:8px 0 6px">üìö Active</h3>
      {% if active_bios and active_bios|length %}
        <div id="grid_active" class="grid">
          {% for b in active_bios %}
            {{ bio_card(b, type_name, is_archived=False) }}
          {% endfor %}
        </div>
      {% else %}
        <div class="empty">No active biographies.</div>
      {% endif %}
    {% endif %}

    {# ---------------- Archived ---------------- #}
    {% if show in ['archived','all'] %}
      <h3 style="margin:18px 0 6px">üóÑÔ∏è Archived</h3>
      {% if archived_bios and archived_bios|length %}
        <div id="grid_archived" class="grid">
          {% for b in archived_bios %}
            {{ bio_card(b, type_name, is_archived=True) }}
          {% endfor %}
        </div>
      {% else %}
        <div class="empty">No archived biographies.</div>
      {% endif %}
    {% endif %}
  {% else %}
    {# Fallback when only 'bios' is provided #}
    {% if bios and bios|length > 0 %}
      <div id="grid_fallback" class="grid">
        {% for b in bios %}
          {{ bio_card(b, type_name) }}
        {% endfor %}
      </div>
    {% else %}
      <div class="empty">
        No biographies yet for <strong>{{ type_name|replace('_',' ')|title }}</strong>.<br>
        Click <em>New Biography</em> to create your first one.
      </div>
    {% endif %}
  {% endif %}
{% endif %}
  </div>

<script>
  // --- search + status filters (work across ALL grids produced by the macro) ---
  const statusSelect = document.getElementById('statusFilter');
  let qText = '';

  function filterBios(q){
    qText = (q||'').toLowerCase();
    applyFilters();
  }

  function applyFilters(){
    const stat = (statusSelect?.value || '').toLowerCase();

    // filter all bio cards
    document.querySelectorAll('.card-wrap').forEach(card=>{
      const hay = (card.getAttribute('data-key') || '').toLowerCase();
      const status = (card.getAttribute('data-status') || '').toLowerCase();
      const matchText = !qText || hay.includes(qText);
      const matchStat = !stat || status === stat;
      card.style.display = (matchText && matchStat) ? '' : 'none';
    });

    // hide folder <details> that have no visible cards
    document.querySelectorAll('details.card').forEach(det=>{
      const anyVisible = !!det.querySelector('.card-wrap:not([style*="display: none"])');
      det.style.display = anyVisible ? '' : 'none';
    });
  }

  // --- sorting (run for every .grid on the page) ---
  function sortAllGrids(){
    const mode = document.getElementById('sortSelect')?.value || 'updated_desc';
    document.querySelectorAll('.grid').forEach(grid=>{
      const cards = Array.from(grid.querySelectorAll('.card-wrap'));
      cards.sort((a, b) => {
        const nameA = (a.getAttribute('data-key') || '');
        const nameB = (b.getAttribute('data-key') || '');
        const dateA = Date.parse(a.getAttribute('data-updated') || '') || 0;
        const dateB = Date.parse(b.getAttribute('data-updated') || '') || 0;
        switch (mode) {
          case 'updated_asc':  return dateA - dateB;
          case 'name_asc':     return nameA.localeCompare(nameB);
          case 'name_desc':    return nameB.localeCompare(nameA);
          case 'updated_desc':
          default:             return dateB - dateA;
        }
      });
      cards.forEach(c => grid.appendChild(c));
    });
  }

  // keep your "Sort: Recent first" select working
  const sortSelect = document.getElementById('sortSelect');
  if (sortSelect) sortSelect.addEventListener('change', sortAllGrids);

  // UK timestamp formatting (unchanged)
  function formatUKTimes() {
    const nodes = document.querySelectorAll('.updated[data-iso]');
    nodes.forEach(n => {
      const iso = n.getAttribute('data-iso') || '';
      const d = new Date(iso);
      if (!isNaN(d)) {
        const uk = d.toLocaleString('en-GB', {
          timeZone: 'Europe/London',
          dateStyle: 'medium',
          timeStyle: 'short'
        });
        n.textContent = `Last updated: ${uk}`;
      }
    });
  }

  document.addEventListener('DOMContentLoaded', () => {
    sortAllGrids();
    formatUKTimes();
    applyFilters(); // apply current status selection on load
  });
</script>
</body>
</html>




