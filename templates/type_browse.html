<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>{{ type_name|replace('_',' ')|title }} ‚Äì Biographies</title>
  <link rel="stylesheet" href="/static/styles.css">
<style>
  :root{
    --bg:#f6f7fb; --card:#fff; --ink:#111827; --muted:#657085; --line:#e7e9f2;
    --brand:#6c63ff; --pill:#eef0f7;
    --danger:#c62828; --success:#0b6230; --warn:#7a4b00;
    --arch:#f8fafc;
  }
  body{background:var(--bg);font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;color:var(--ink)}
  .box{max-width:1100px;margin:36px auto;background:var(--card);padding:24px;
       border-radius:14px;box-shadow:0 8px 24px rgba(0,0,0,.06);border:1px solid var(--line)}
  h1{margin:0 0 8px;font-size:28px;font-weight:750}
  h2{margin:0 0 6px;font-size:22px;font-weight:730}
  h3{margin:0 0 6px;font-size:16px;font-weight:700}
  .muted{color:var(--muted)}

  /* toolbar */
  .toolbar{display:flex;gap:10px;align-items:center;flex-wrap:wrap;justify-content:space-between;margin:12px 0 16px}
  .toolbar .left,.toolbar .right{display:flex;gap:10px;align-items:center}
  .toolbar .spacer{flex:1}

  /* inputs */
  .search,.select{padding:10px 12px;border:1px solid var(--line);border-radius:10px;background:#fff;min-width:220px}
  .search{flex:1}

  /* buttons */
  .btn{display:inline-flex;align-items:center;justify-content:center;gap:6px;
       padding:9px 14px;border-radius:10px;font-weight:600;text-decoration:none;cursor:pointer;
       background:var(--brand);color:#fff;border:1px solid var(--brand)}
  .btn.secondary{background:var(--pill);color:#333;border-color:var(--line)}
  .btn.ghost{background:transparent;color:var(--brand);border:1px solid var(--brand)}
  .btn.danger{background:var(--danger);color:#fff;border-color:var(--danger)}
  .btn.archive{background:#f5f7ff;color:#2b2f5e;border:1px solid #d9ddff}
  .btn.restore{background:#e9fbf0;color:var(--success);border:1px solid #b9efcc}
  .btn.mini{padding:6px 10px;font-size:12px;border-radius:8px}

  /* grid & cards */
  .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(300px,1fr));gap:14px}
  .card{border:1px solid var(--line);border-radius:12px;padding:14px;background:#fff;
        display:flex;flex-direction:column;gap:10px;position:relative;transition:transform .12s,box-shadow .12s}
  .card-link{display:block;color:inherit;text-decoration:none}
  .card-link:hover .card{transform:translateY(-2px);box-shadow:0 8px 18px rgba(0,0,0,.07)}
  .card.archived{background:var(--arch);border-style:dashed;opacity:.85}
  .title{margin:0;font-size:16px;font-weight:800;line-height:1.2}
  .desc{color:#4b5563;font-size:13px;line-height:1.35}
  .actions{display:flex;gap:8px;margin-top:auto;flex-wrap:wrap}

  /* chips & badges */
  .chips{display:flex;flex-wrap:wrap;gap:6px;margin-top:4px}
  .chip{font-size:11px;border-radius:999px;padding:3px 8px;background:#f3f4f9;border:1px solid #e6e8f2;color:#445}
  .chip.badge{background:#fafbff;border-color:#e7e9f2}
  .chip.path{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,monospace}
  .chip.archived{background:#fff4e6;border-color:#ffd8a8;color:var(--warn)}
  .badge{position:absolute;top:10px;right:10px;font-size:11px;padding:3px 8px;border-radius:999px;
         background:#f3f4f6;color:#374151;border:1px solid #e5e7eb}
  .badge.archived{background:#fff1f2;color:#b91c1c;border-color:#fecdd3}

  /* misc */
  .empty{color:var(--muted);font-size:14px;background:#fafbff;border:1px dashed var(--line);
         border-radius:12px;padding:14px;text-align:center}
  .flashline{display:inline-block;background:#eef9f1;border:1px solid #b8ebc6;color:#0f5132;
             border-radius:8px;padding:6px 10px;margin-right:6px;font-size:12px}

  /* --- image safety + consistent thumbs --- */
.card, .option { overflow: hidden; }            /* keep media inside cards */
.grid { align-items: start; }                   /* prevent stretched rows */

/* Any image inside cards/options: never overflow */
.card img,
.option img {
  display: block;
  max-width: 100%;
  height: auto;
  border-radius: 8px;
}

/* If an image has the 'thumb' class, crop it to a neat banner */
.thumb {
  width: 100%;
  max-height: 180px;        /* change to taste: 140‚Äì220px works well */
  object-fit: cover;        /* crop without distortion */
  border-radius: 10px;
}

/* Optional: make long text and media inside options behave */
details.opts .optwrap { overflow: auto; }
</style>
</head>
<body>
  <div class="box">
    <h1>{{ type_name|replace('_',' ')|title }} - Biographies</h1>

 <div class="toolbar">
  <!-- Left controls -->
  <a class="btn ghost" href="{{ url_for('dashboard') }}">‚¨ÖÔ∏è Back to Dashboard</a>

  <!-- Launch the wizard with this type preselected, and come back here afterwards -->
  <a class="btn"
     href="{{ url_for('general_iframe_wizard',
                      step='start',
                      type_name=type_name,
                      return_url=url_for('type_browse', type_name=type_name)) }}">
    ‚ûï New Biography
  </a>

  <!-- Type-specific manage pages -->
  <a class="btn secondary" href="{{ url_for('type_properties', type_name=type_name) }}">‚öôÔ∏è Manage Properties</a>
  <a class="btn secondary" href="{{ url_for('type_labels', type_name=type_name) }}">üè∑Ô∏è Manage Labels</a>

  <span class="spacer"></span>

  <!-- View toggles -->
  <a class="btn secondary{% if show=='' %} ghost{% endif %}"
     href="{{ url_for('type_browse', type_name=type_name) }}">Active</a>
  <a class="btn secondary{% if show=='archived' %} ghost{% endif %}"
     href="{{ url_for('type_browse', type_name=type_name, show='archived') }}">Archived</a>
  <a class="btn secondary{% if show=='all' %} ghost{% endif %}"
     href="{{ url_for('type_browse', type_name=type_name, show='all') }}">All</a>
</div>

    <div class="controls">
      <input type="search" id="searchInput" placeholder="Search {{ type_name|replace('_',' ')|title }} biographies‚Ä¶"
             oninput="filterCards()">
      <select id="sortSelect" onchange="sortAllGrids()">
        <option value="updated_desc">Sort: Recent first</option>
        <option value="updated_asc">Sort: Oldest first</option>
        <option value="name_asc">Sort: Name A‚ÄìZ</option>
        <option value="name_desc">Sort: Name Z‚ÄìA</option>
      </select>
    </div>

    {% set have_split = active_bios is defined or archived_bios is defined %}
    {% if have_split %}
      {# ---------------- Active ---------------- #}
      {% if show != 'archived' %}
        <h3 style="margin:8px 0 6px">üìö Active</h3>
        {% if active_bios and active_bios|length %}
          <div id="grid_active" class="grid">
            {% for b in active_bios %}
              {% set _id = b.get('id') %}
              {% set _name = b.get('name') or _id.replace('_',' ')|title %}
              {% set _desc = b.get('description') %}
              {% set _stamp = b.get('updated') or b.get('created') %}
              <div class="card-wrap" data-name="{{ _name|lower }}" data-updated="{{ _stamp or '' }}">
                <a class="card-link" href="{{ url_for('biography_view', type_name=type_name, bio_id=_id) }}">
                  <div class="card" role="button" aria-label="View {{ _name }}">
                    <h3>{{ _name }}</h3>
                    {% if _desc %}<div class="desc">{{ _desc }}</div>{% endif %}
                    <div class="muted">
                      {% if _stamp %}
                        <span class="updated" data-iso="{{ _stamp }}">{{ _stamp }}</span>
                      {% else %}
                        No timestamp
                      {% endif %}
                    </div>
                  </div>
                </a>
                <div class="actions-row">
                  <a class="btn mini secondary" href="{{ url_for('biography_view', type_name=type_name, bio_id=_id) }}">üîé View</a>
                  <form class="action-form" method="post" action="{{ url_for('api_archive_bio', type_name=type_name, bio_id=_id) }}">
                    <button class="btn mini secondary" type="submit" onclick="return confirm('Archive this biography? You can unarchive later.')">üóÑÔ∏è Archive</button>
                  </form>
                </div>
              </div>
            {% endfor %}
          </div>
        {% else %}
          <div class="empty">No active biographies.</div>
        {% endif %}
      {% endif %}

      {# ---------------- Archived ---------------- #}
      {% if show in ['archived','all'] %}
        <h3 style="margin:18px 0 6px">üóÑÔ∏è Archived</h3>
        {% if archived_bios and archived_bios|length %}
          <div id="grid_archived" class="grid">
            {% for b in archived_bios %}
              {% set _id = b.get('id') %}
              {% set _name = b.get('name') or _id.replace('_',' ')|title %}
              {% set _desc = b.get('description') %}
              {% set _stamp = b.get('updated') or b.get('archived_at') or b.get('created') %}
              <div class="card-wrap" data-name="{{ _name|lower }}" data-updated="{{ _stamp or '' }}">
                <a class="card-link" href="{{ url_for('biography_view', type_name=type_name, bio_id=_id) }}">
                  <div class="card" role="button" aria-label="View {{ _name }}">
                    <span class="badge archived">Archived</span>
                    <h3>{{ _name }}</h3>
                    {% if _desc %}<div class="desc">{{ _desc }}</div>{% endif %}
                    <div class="muted">
                      {% if _stamp %}
                        <span class="updated" data-iso="{{ _stamp }}">{{ _stamp }}</span>
                      {% else %}
                        No timestamp
                      {% endif %}
                    </div>
                  </div>
                </a>
                <div class="actions-row">
                  <a class="btn mini secondary" href="{{ url_for('biography_view', type_name=type_name, bio_id=_id) }}">üîé View</a>
                  <form class="action-form" method="post" action="{{ url_for('api_unarchive_bio', type_name=type_name, bio_id=_id) }}">
                    <button class="btn mini secondary" type="submit">‚Ü©Ô∏è Unarchive</button>
                  </form>
                </div>
              </div>
            {% endfor %}
          </div>
        {% else %}
          <div class="empty">No archived biographies.</div>
        {% endif %}
      {% endif %}
    {% else %}
      {# Fallback when only 'bios' is provided #}
      {% if bios and bios|length > 0 %}
        <div id="grid_fallback" class="grid">
          {% for b in bios %}
            {% set _id = b.get('id') %}
            {% set _name = b.get('name') or _id.replace('_',' ')|title %}
            {% set _desc = b.get('description') %}
            {% set _stamp = b.get('updated') or b.get('created') %}
            {% set _arch = b.get('archived') %}
            <div class="card-wrap" data-name="{{ _name|lower }}" data-updated="{{ _stamp or '' }}">
              <a class="card-link" href="{{ url_for('biography_view', type_name=type_name, bio_id=_id) }}">
                <div class="card" role="button" aria-label="View {{ _name }}">
                  {% if _arch %}<span class="badge archived">Archived</span>{% endif %}
                  <h3>{{ _name }}</h3>
                  {% if _desc %}<div class="desc">{{ _desc }}</div>{% endif %}
                  <div class="muted">
                    {% if _stamp %}
                      <span class="updated" data-iso="{{ _stamp }}">{{ _stamp }}</span>
                    {% else %}
                      No timestamp
                    {% endif %}
                  </div>
                </div>
              </a>
              <div class="actions-row">
                <a class="btn mini secondary" href="{{ url_for('biography_view', type_name=type_name, bio_id=_id) }}">üîé View</a>
                {% if _arch %}
                  <form class="action-form" method="post" action="{{ url_for('api_unarchive_bio', type_name=type_name, bio_id=_id) }}">
                    <button class="btn mini secondary" type="submit">‚Ü©Ô∏è Unarchive</button>
                  </form>
                {% else %}
                  <form class="action-form" method="post" action="{{ url_for('api_archive_bio', type_name=type_name, bio_id=_id) }}">
                    <button class="btn mini secondary" type="submit" onclick="return confirm('Archive this biography? You can unarchive later.')">üóÑÔ∏è Archive</button>
                  </form>
                {% endif %}
              </div>
            </div>
          {% endfor %}
        </div>
      {% else %}
        <div class="empty">
          No biographies yet for <strong>{{ type_name|replace('_',' ')|title }}</strong>.<br>
          Click <em>New Biography</em> to create your first one.
        </div>
      {% endif %}
    {% endif %}
  </div>

  <script>
    function filterCards() {
      const q = (document.getElementById('searchInput').value || '').trim().toLowerCase();
      document.querySelectorAll('[id^="grid_"] .card-wrap, #grid_fallback .card-wrap').forEach(c => {
        const name = c.getAttribute('data-name') || '';
        c.style.display = name.includes(q) ? '' : 'none';
      });
    }

    function sortGrid(gridId) {
      const grid = document.getElementById(gridId);
      if (!grid) return;
      const mode = document.getElementById('sortSelect').value;
      const cards = Array.from(grid.querySelectorAll('.card-wrap'));
      cards.sort((a, b) => {
        const nameA = (a.getAttribute('data-name') || '');
        const nameB = (b.getAttribute('data-name') || '');
        const dateA = Date.parse(a.getAttribute('data-updated') || '') || 0;
        const dateB = Date.parse(b.getAttribute('data-updated') || '') || 0;

        switch (mode) {
          case 'updated_asc':  return dateA - dateB;
          case 'name_asc':     return nameA.localeCompare(nameB);
          case 'name_desc':    return nameB.localeCompare(nameA);
          case 'updated_desc':
          default:             return dateB - dateA;
        }
      });
      cards.forEach(c => grid.appendChild(c));
    }

    function sortAllGrids() {
      sortGrid('grid_active');
      sortGrid('grid_archived');
      sortGrid('grid_fallback');
    }

    // Format timestamps to UK time (Europe/London) once the DOM is ready
    function formatUKTimes() {
      const nodes = document.querySelectorAll('.updated[data-iso]');
      nodes.forEach(n => {
        const iso = n.getAttribute('data-iso') || '';
        const d = new Date(iso);
        if (!isNaN(d)) {
          const uk = d.toLocaleString('en-GB', {
            timeZone: 'Europe/London',
            dateStyle: 'medium',
            timeStyle: 'short'
          });
          n.textContent = `Last updated: ${uk}`;
        }
      });
    }

    document.addEventListener('DOMContentLoaded', () => {
      sortAllGrids();
      formatUKTimes();
    });
  </script>
</body>
</html>




