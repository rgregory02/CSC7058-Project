<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>{{ 'New' if mode=='new' else 'Edit' }} Property ‚Äì {{ type_name|replace('_',' ')|title }}</title>
  <link rel="stylesheet" href="/static/styles.css">
  <style>
    body{background:#f6f7fb;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
    .wrap{max-width:1000px;margin:30px auto;background:#fff;border:1px solid #e7e9f2;border-radius:14px;box-shadow:0 8px 24px rgba(0,0,0,.05);padding:24px}
    h1{margin:0 0 8px}
    .muted{color:#657085}
    form{display:grid;grid-template-columns:1fr 1fr;gap:18px}
    .full{grid-column:1/-1}
    label{font-weight:600;display:block;margin-bottom:6px}
    input[type=text], textarea, select{width:100%;padding:10px;border:1px solid #d9dbe7;border-radius:8px}
    textarea{min-height:90px}
    .row{display:flex;gap:12px;align-items:center}
    .btn{display:inline-block;background:#6c63ff;color:#fff;padding:10px 16px;border-radius:10px;text-decoration:none;font-weight:600;border:none;cursor:pointer}
    .btn.secondary{background:#eef0f7;color:#333}
    .actions{grid-column:1/-1;display:flex;gap:10px;justify-content:flex-end;margin-top:8px}
    small.help{display:block;color:#8b90a0;margin-top:4px}
    .pill{display:inline-block;background:#f2f4ff;border:1px solid #dfe3ff;padding:4px 8px;border-radius:999px;font-size:12px;color:#495}
    .twoCols{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  </style>
</head>
<body>
  <div class="wrap">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
      <div>
        <h1>{{ '‚ûï New' if mode=='new' else '‚úèÔ∏è Edit' }} Property</h1>
        <div class="muted">{{ type_name|replace('_',' ')|title }}</div>
      </div>
      <div class="row">
        <a class="btn secondary" href="{{ url_for('type_properties', type_name=type_name) }}">Back to Properties</a>
        <a class="btn secondary" href="{{ url_for('dashboard') }}">Dashboard</a>
      </div>
    </div>

    {% set src = (prop.source if prop and prop.source is defined else {}) %}
    {# UI normalization: show 'self_labels' if saved as type_labels but points to current type #}
    {% set raw_kind = src.kind if src and src.kind is defined else '' %}
    {% set ui_kind = ( 'self_labels' if (raw_kind=='type_labels' and (src.get('type')==type_name)) else raw_kind ) %}

    <form method="post" autocomplete="off">
      <!-- Identity -->
      <div class="full">
        <label for="name">Property Name</label>
        <input type="text" id="name" name="name"
               placeholder="e.g. Work Place"
               value="{{ (prop.name if prop else '') or '' }}" required>
        <small class="help">Human‚Äëreadable display name.</small>
      </div>

      <div>
        <label for="key">Property Key</label>
        <input type="text" id="key" name="key"
               placeholder="e.g. work_place"
               value="{{ (prop_key if mode=='edit' else '') or '' }}"
               pattern="[a-z0-9_]+"
               required>
        <small class="help">Auto‚Äëgenerates from the name (lowercase, numbers & underscores). You can override it.</small>
      </div>

      <div>
        <label for="input">Input type (optional)</label>
        <input type="text" id="input" name="input"
               placeholder="e.g. select, multi, free_text"
               value="{{ prop.input if prop and prop.input is defined else '' }}">
        <small class="help">Purely informational for now; helpful for UI hints.</small>
      </div>

      <div class="full">
        <label for="description">Description</label>
        <textarea id="description" name="description"
                  placeholder="Optional description for this property">{{ prop.description if prop else '' }}</textarea>
      </div>

      <!-- Source block -->
      <div class="full"><span class="pill">Source</span></div>

      <div>
        <label for="source_kind">Source kind</label>
        <select id="source_kind" name="source_kind">
          <option value="none" {{ 'selected' if ui_kind in ('', None) else '' }}>‚Äî none ‚Äî</option>
          <option value="self_labels" {{ 'selected' if ui_kind=='self_labels' else '' }}>self_labels (this type)</option>
          <option value="type_labels" {{ 'selected' if ui_kind=='type_labels' else '' }}>type_labels (another type)</option>
          <option value="type_biographies" {{ 'selected' if ui_kind=='type_biographies' else '' }}>type_biographies (another type)</option>
        </select>
        <small class="help">Choose where this property‚Äôs options come from.</small>
      </div>

      <div>
        <label for="source_type">Source type</label>
        <select id="source_type" name="source_type">
          <option value="">‚Äî pick a type ‚Äî</option>
          {% for t in available_types %}
            <option value="{{ t }}" {{ 'selected' if src and src.get('type')==t else '' }}>{{ t }}</option>
          {% endfor %}
        </select>
        <small class="help">Used for <code>type_labels</code> / <code>type_biographies</code>. Hidden for <code>self_labels</code>.</small>
      </div>

      <div class="full twoCols">
        <div>
          <label for="source_path">Source path</label>
          {% set src_path = src.get('path','') if src else '' %}
          <input list="label_groups" type="text" id="source_path" name="source_path"
                 placeholder="e.g. work_building/hospital"
                 value="{{ src_path }}">
          <datalist id="label_groups"></datalist>
          <small class="help">
            For <code>self_labels</code>/<code>type_labels</code>: label group path.  
            If <code>self_labels</code> and left blank, it will default to the property key.
          </small>
        </div>

        <!-- NEW: visual picker mirroring the datalist -->
        <div>
          <label for="source_path_select">Pick from groups</label>
          <select id="source_path_select">
            <option value="">‚Äî choose a group ‚Äî</option>
          </select>
          <small class="help">Choose an existing group; or type your own on the left.</small>
          <div style="margin-top:10px;display:flex;align-items:center;gap:8px">
            {% set allow_children = (src.get('allow_children') if src else False) %}
            <input type="checkbox" id="source_allow_children" name="source_allow_children"
                   {{ 'checked' if allow_children else '' }}>
            <label for="source_allow_children" style="margin:0">Allow child folders</label>
          </div>
        </div>
      </div>

      <!-- Link biography block -->
      <div class="full"><span class="pill">Link Biography</span></div>

      {% set lb = (prop.link_biography if prop and prop.link_biography is defined else {}) %}

      <div>
        <label for="link_bio_type">Link biography type</label>
        <select id="link_bio_type" name="link_bio_type">
          <option value="">‚Äî none ‚Äî</option>
          {% for t in available_types %}
            <option value="{{ t }}" {{ 'selected' if lb and lb.get('type')==t else '' }}>{{ t }}</option>
          {% endfor %}
        </select>
      </div>

      <div>
        <label for="link_bio_path">Link biography path (optional)</label>
        <input type="text" id="link_bio_path" name="link_bio_path"
               placeholder="e.g. hospitals"
               value="{{ lb.get('path','') if lb else '' }}">
        <small class="help">If you keep biographies in subfolders (optional).</small>
      </div>

      <div>
        <label for="link_bio_mode">Link biography mode</label>
        {% set mode_val = lb.get('mode','child_or_parent') if lb else 'child_or_parent' %}
        <select id="link_bio_mode" name="link_bio_mode">
          <option value="child_only" {{ 'selected' if mode_val=='child_only' else '' }}>child_only</option>
          <option value="parent_only" {{ 'selected' if mode_val=='parent_only' else '' }}>parent_only</option>
          <option value="child_or_parent" {{ 'selected' if mode_val=='child_or_parent' else '' }}>child_or_parent</option>
        </select>
      </div>

<!-- Auto‚Äëlink toggle (hidden unless a bio link is configured) -->
<div class="full" id="auto_link_container" style="display:none">
  <div class="row">
    <input type="checkbox" id="link_bio_auto" name="link_bio_auto"
      {% set _auto = (
           prop.refer_to.auto_link if (prop and prop.refer_to is defined) else
           (prop.link_biography.auto_link if (prop and prop.link_biography is defined) else False)
         ) %}
      {{ 'checked' if _auto else '' }}>
    <label for="link_bio_auto" style="margin:0">Auto‚Äëlink exact match</label>
  </div>
  <small class="help">
    When enabled, the Labels step will auto‚Äëselect a biography if there‚Äôs a single exact match for the current selection.
  </small>
</div>

      <!-- quick helpers -->
      <div class="row">
        <a class="btn secondary" href="{{ url_for('add_type_prompt') }}" target="_top">‚ûï Add Type</a>
        <a class="btn secondary" href="{{ url_for('create_subfolder', type_name=type_name) }}" target="_top">üè∑Ô∏è Add Label Group</a>
      </div>

      <!-- Actions -->
      <div class="actions">
        <a class="btn secondary" href="{{ url_for('type_properties', type_name=type_name) }}">Cancel</a>
        <button type="submit" class="btn">Save Property</button>
      </div>
    </form>
  </div>

<script>
  // ---- Data from server for dynamic suggestions ----
  const CURRENT_TYPE = {{ type_name|tojson }};
  const LABEL_GROUPS_BY_TYPE = {{ (label_groups_by_type or {})|tojson }};
  const AVAILABLE_TYPES = {{ (available_types or [])|tojson }};

  // Elements
  const nameEl = document.getElementById('name');
  const keyEl  = document.getElementById('key');
  const sourceKindEl = document.getElementById('source_kind');
  const sourceTypeEl = document.getElementById('source_type');
  const sourcePathEl = document.getElementById('source_path');
  const allowChildrenEl = document.getElementById('source_allow_children');
  const datalist = document.getElementById('label_groups');
  const pathSelect = document.getElementById('source_path_select');

  // Legacy link‚Äëbio controls + auto‚Äëlink container
  const linkBioTypeEl = document.getElementById('link_bio_type');
  const autoLinkContainer = document.getElementById('auto_link_container');

  let keyDirty = {{ 'true' if mode=='edit' else 'false' }};

  function toSnakeCase(s){
    return (s||'').trim().toLowerCase().replace(/[^a-z0-9]+/g,'_').replace(/^_+|_+$/g,'');
  }

  keyEl.addEventListener('input', () => { keyDirty = true; });
  nameEl.addEventListener('input', () => {
    if (keyDirty) return;
    keyEl.value = toSnakeCase(nameEl.value);
    if (sourceKindEl.value === 'self_labels' && !sourcePathEl.value) {
      sourcePathEl.value = keyEl.value;
    }
  });

  function fillGroupsUI(groups){
    datalist.innerHTML = '';
    pathSelect.innerHTML = '<option value="">‚Äî choose a group ‚Äî</option>';
    (groups || []).forEach(g => {
      const opt = document.createElement('option');
      opt.value = g;
      datalist.appendChild(opt);
      const o2 = document.createElement('option');
      o2.value = g;
      o2.textContent = g;
      pathSelect.appendChild(o2);
    });
  }

  function refreshSourceControls(firstLoad=false){
    const kind = sourceKindEl.value;
    const isSelf = (kind === 'self_labels');
    const isLbls = (kind === 'type_labels');
    const isBios = (kind === 'type_biographies');

    sourceTypeEl.disabled     = !(isLbls || isBios);
    sourcePathEl.disabled     = !(isSelf || isLbls);
    pathSelect.disabled       = !(isSelf || isLbls);
    allowChildrenEl.disabled  = !(isSelf || isLbls);

    if (isSelf){
      fillGroupsUI(LABEL_GROUPS_BY_TYPE[CURRENT_TYPE] || []);
      if (!firstLoad && !sourcePathEl.value) {
        sourcePathEl.value = keyEl.value || toSnakeCase(nameEl.value);
      }
    } else if (isLbls){
      fillGroupsUI(LABEL_GROUPS_BY_TYPE[sourceTypeEl.value] || []);
    } else {
      fillGroupsUI([]);
      allowChildrenEl.checked = false;
    }

    // Keep legacy link fields dimmed if type_biographies is chosen
    toggleLegacyLinkBio();

    // NEW: if we‚Äôre using labels and link_bio_type is empty, mirror the source type
    maybeMirrorBioTypeFromSource();
    refreshAutoLinkVisibility();
  }

  function toggleLegacyLinkBio() {
    const isTBio = (sourceKindEl.value === 'type_biographies');
    ['link_bio_type', 'link_bio_path', 'link_bio_mode'].forEach(id => {
      const el = document.getElementById(id);
      if (!el) return;
      el.disabled = isTBio;
      el.closest('div')?.classList.toggle('muted', isTBio);
    });
  }

  // NEW: mirror link_bio_type from source_type when sensible
  function maybeMirrorBioTypeFromSource() {
    if (!linkBioTypeEl) return;
    const kind = sourceKindEl.value;
    // Only auto-fill if user hasn't set a link type yet
    if (!linkBioTypeEl.value && (kind === 'self_labels' || kind === 'type_labels')) {
      const t = sourceTypeEl.value || '';
      if (t) {
        linkBioTypeEl.value = t;       // prefill
      }
    }
  }

  // NEW: show/hide the auto-link row
  function refreshAutoLinkVisibility() {
    if (!autoLinkContainer) return;
    const kind = sourceKindEl.value;
    const hasTypeBios = (kind === 'type_biographies') && !!(sourceTypeEl.value);
    const hasLegacy   = !!(linkBioTypeEl && linkBioTypeEl.value);
    autoLinkContainer.style.display = (hasTypeBios || hasLegacy) ? 'block' : 'none';
  }

  // Wire up listeners
  sourceKindEl.addEventListener('change', () => {
    refreshSourceControls(false);
  });
  sourceTypeEl.addEventListener('change', () => {
    // keep UI in sync and mirror if empty
    maybeMirrorBioTypeFromSource();
    refreshSourceControls(false);
  });
  if (linkBioTypeEl) {
    linkBioTypeEl.addEventListener('change', refreshAutoLinkVisibility);
  }

  // mirror dropdown selection into the text input
  pathSelect.addEventListener('change', () => {
    if (pathSelect.value) sourcePathEl.value = pathSelect.value;
  });

  document.addEventListener('DOMContentLoaded', () => {
    const initialKind = '{{ ui_kind }}';
    if (initialKind === 'self_labels') {
      sourceKindEl.value = 'self_labels';
    }
    refreshSourceControls(true);

    // Preselect dropdown if the text value already matches
    const match = Array.from(pathSelect.options).find(o => o.value === sourcePathEl.value);
    if (match) pathSelect.value = match.value;

    // Ensure visibility is correct on load
    refreshAutoLinkVisibility();
  });
</script>

</body>
</html>


