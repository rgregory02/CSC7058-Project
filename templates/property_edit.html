<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>{{ 'New' if mode=='new' else 'Edit' }} Property – {{ type_name|replace('_',' ')|title }}</title>
  <link rel="stylesheet" href="/static/styles.css">
  <style>
    body{background:#f6f7fb;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
    .wrap{max-width:1000px;margin:30px auto;background:#fff;border:1px solid #e7e9f2;border-radius:14px;box-shadow:0 8px 24px rgba(0,0,0,.05);padding:24px}
    h1{margin:0 0 8px}
    .muted{color:#657085}
    form{display:grid;grid-template-columns:1fr 1fr;gap:18px}
    .full{grid-column:1/-1}
    label{font-weight:600;display:block;margin-bottom:6px}
    input[type=text], textarea, select{width:100%;padding:10px;border:1px solid #d9dbe7;border-radius:8px}
    textarea{min-height:90px}
    .row{display:flex;gap:12px;align-items:center}
    .btn{display:inline-block;background:#6c63ff;color:#fff;padding:10px 16px;border-radius:10px;text-decoration:none;font-weight:600;border:none;cursor:pointer}
    .btn.secondary{background:#eef0f7;color:#333}
    .actions{grid-column:1/-1;display:flex;gap:10px;justify-content:flex-end;margin-top:8px}
    small.help{display:block;color:#8b90a0;margin-top:4px}
    .pill{display:inline-block;background:#f2f4ff;border:1px solid #dfe3ff;padding:4px 8px;border-radius:999px;font-size:12px;color:#495}
    .twoCols{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  </style>
</head>
<body>
  <div class="wrap">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
      <div>
        <h1>{{ '➕ New' if mode=='new' else '✏️ Edit' }} Property</h1>
        <div class="muted">{{ type_name|replace('_',' ')|title }}</div>
      </div>
      <div class="row">
        <a class="btn secondary" href="{{ url_for('type_properties', type_name=type_name) }}">Back to Properties</a>
        <a class="btn secondary" href="{{ url_for('dashboard') }}">Dashboard</a>
      </div>
    </div>

    {% set src = (prop.source if prop and prop.source is defined else {}) %}
    {# UI normalization: show 'self_labels' if saved as type_labels but points to current type #}
    {% set raw_kind = src.kind if src and src.kind is defined else '' %}
    {% set ui_kind = ( 'self_labels' if (raw_kind=='type_labels' and (src.get('type')==type_name)) else raw_kind ) %}

    <form method="post" autocomplete="off">
      <!-- Identity -->
      <div class="full">
        <label for="name">Property Name</label>
        <input type="text" id="name" name="name"
               placeholder="e.g. Work Place"
               value="{{ (prop.name if prop else '') or '' }}" required>
        <small class="help">Human‑readable display name.</small>
      </div>

      <div>
        <label for="key">Property Key</label>
        <input type="text" id="key" name="key"
               placeholder="e.g. work_place"
               value="{{ (prop_key if mode=='edit' else '') or '' }}"
               pattern="[a-z0-9_]+"
               required>
        <small class="help">Auto‑generates from the name (lowercase, numbers & underscores). You can override it.</small>
      </div>

      <div>
        <label for="input">Input type (optional)</label>
        <input type="text" id="input" name="input"
               placeholder="e.g. select, multi, free_text"
               value="{{ prop.input if prop and prop.input is defined else '' }}">
        <small class="help">Purely informational for now; helpful for UI hints.</small>
      </div>

      <div class="full">
        <label for="description">Description</label>
        <textarea id="description" name="description"
                  placeholder="Optional description for this property">{{ prop.description if prop else '' }}</textarea>
      </div>

      <!-- Source block -->
      <div class="full"><span class="pill">Source</span></div>

      <div>
        <label for="source_kind">Source kind</label>
        <select id="source_kind" name="source_kind">
          <option value="none" {{ 'selected' if ui_kind in ('', None) else '' }}>— none —</option>
          <option value="self_labels" {{ 'selected' if ui_kind=='self_labels' else '' }}>self_labels (this type)</option>
          <option value="type_labels" {{ 'selected' if ui_kind=='type_labels' else '' }}>type_labels (another type)</option>
          <option value="type_biographies" {{ 'selected' if ui_kind=='type_biographies' else '' }}>type_biographies (another type)</option>
          <option value="external_api" {{ 'selected' if ui_kind=='external_api' else '' }}>external_api (HTTP)</option>
        </select>
        <small class="help">Choose where this property’s options come from.</small>
      </div>

      <div>
        <label for="source_type">Source type</label>
        <select id="source_type" name="source_type">
          <option value="">— pick a type —</option>
          {% for t in available_types %}
            <option value="{{ t }}" {{ 'selected' if src and src.get('type')==t else '' }}>{{ t }}</option>
          {% endfor %}
        </select>
        <small class="help">Used for <code>type_labels</code> / <code>type_biographies</code>. Hidden for <code>self_labels</code>.</small>
      </div>

      <div class="full twoCols">
        <div>
          <label for="source_path">Source path</label>
          {% set src_path = src.get('path','') if src else '' %}
          <input list="label_groups" type="text" id="source_path" name="source_path"
                 placeholder="e.g. work_building/hospital"
                 value="{{ src_path }}">
          <datalist id="label_groups"></datalist>
          <small class="help">
            For <code>self_labels</code>/<code>type_labels</code>: label group path.  
            If <code>self_labels</code> and left blank, it will default to the property key.
          </small>
        </div>

        <!-- NEW: visual picker mirroring the datalist -->
        <div>
          <label for="source_path_select">Pick from groups</label>
          <select id="source_path_select">
            <option value="">— choose a group —</option>
          </select>
          <small class="help">Choose an existing group; or type your own on the left.</small>
          <div style="margin-top:10px;display:flex;align-items:center;gap:8px">
            {% set allow_children = (src.get('allow_children') if src else False) %}
            <input type="checkbox" id="source_allow_children" name="source_allow_children"
                   {{ 'checked' if allow_children else '' }}>
            <label for="source_allow_children" style="margin:0">Allow child folders</label>
          </div>
        </div>

     <!-- External API config (shown only when Source kind = external_api) -->
<div class="full" id="external_api_block" style="display:none">
  <span class="pill">External API</span>

  <!-- Endpoint + method -->
  <div class="twoCols" style="margin-top:10px">
    <div>
      <label for="api_endpoint">Endpoint URL</label>
      <input type="text" id="api_endpoint" name="source_api_endpoint"
             placeholder="https://api.example.com/search"
             value="{{ (src.get('endpoint') if src else '') or '' }}">
      <small class="help">Full URL to the API endpoint.</small>
    </div>
    <div>
      <label for="api_method">HTTP Method</label>
      {% set _m = (src.get('method') if src else '') or 'GET' %}
      <select id="api_method" name="source_api_method">
        <option value="GET"  {{ 'selected' if _m=='GET'  else '' }}>GET</option>
        <option value="POST" {{ 'selected' if _m=='POST' else '' }}>POST</option>
      </select>
      <small class="help">GET (query params) or POST (JSON body).</small>
    </div>
  </div>

  <!-- Auth + cache -->
  <div class="twoCols">
    <div>
      <label for="api_headers_env">Env Var for Auth</label>
      <input type="text" id="api_headers_env" name="source_api_headers_env"
             placeholder="ONENET_API_KEY"
             value="{{ (src.get('headers_env') if src else '') or '' }}">
      <small class="help">We’ll send <code>Authorization: Bearer $ENV</code>. Leave blank for none.</small>
    </div>
    <div>
      <label for="api_cache_seconds">Cache (seconds)</label>
      <input type="text" id="api_cache_seconds" name="source_api_cache_seconds"
             placeholder="e.g. 3600"
             value="{{ (src.get('cache_seconds') if src else '') or '' }}">
      <small class="help">Optional time‑based cache to reduce API calls.</small>
    </div>
  </div>

  <!-- Query/body template -->
  <div class="full">
    <label for="api_query">Query / Body Template (JSON)</label>
    <textarea id="api_query" name="source_api_query" placeholder='{"q": "{search}", "limit": 25}'>{{ (src.get('query')|tojson if (src and src.get('query') is not none) else '') }}</textarea>
    <small class="help">Use <code>{search}</code> to inject the user’s filter text.</small>
  </div>

  <!-- Response mapping -->
  <div class="twoCols">
    <div>
      <label for="api_list_path">List Path</label>
      <input type="text" id="api_list_path" name="source_api_list_path"
             placeholder="results.items"
             value="{{ (src.get('list_path') if src else '') or '' }}">
      <small class="help">Dot path to the array in the API response (blank if top‑level array).</small>
    </div>
    <div>
      <label>Field Mapping</label>
      <div class="twoCols">
        <div>
          <input type="text" id="api_map_id" name="source_api_map_id"
                 placeholder="id"
                 value="{{ ((src.get('map') or {}).get('id') if src else '') or '' }}">
          <small class="help">id path</small>
        </div>
        <div>
          <input type="text" id="api_map_display" name="source_api_map_display"
                 placeholder="name"
                 value="{{ ((src.get('map') or {}).get('display') if src else '') or '' }}">
          <small class="help">display path</small>
        </div>
      </div>
      <div class="twoCols" style="margin-top:8px">
        <div>
          <input type="text" id="api_map_description" name="source_api_map_description"
                 placeholder="summary"
                 value="{{ ((src.get('map') or {}).get('description') if src else '') or '' }}">
          <small class="help">description path (optional)</small>
        </div>
        <div>
          <input type="text" id="api_map_image_url" name="source_api_map_image_url"
                 placeholder="logo"
                 value="{{ ((src.get('map') or {}).get('image_url') if src else '') or '' }}">
          <small class="help">image_url path (optional)</small>
        </div>
      </div>
    </div>
  </div>

  <!-- 🔐 API key management + live test -->
  <div class="full" id="api_key_box" style="display:none; border:1px dashed #e5e7eb; padding:12px; border-radius:10px; margin-top:8px;">
    <label>🔐 API Key for <code id="api_key_name">—</code></label>
    <div class="row" style="gap:8px; align-items:center;">
      <input type="password" id="api_key_value" placeholder="Paste key (stored securely on server)">
      <button type="button" class="btn" id="api_key_save">Save Key</button>
      <button type="button" class="btn secondary" id="api_key_check">Check Key</button>
    </div>
    <small class="help" id="api_key_status">Key not checked yet.</small>

    <div class="row" style="gap:8px; margin-top:10px;">
      <input type="text" id="api_test_search" placeholder="Test search (optional, e.g. nurse)">
      <button type="button" class="btn ghost" id="api_test_btn">Test Connection</button>
    </div>
    <div id="api_test_result" class="muted" style="margin-top:6px"></div>
  </div>

  <small class="help">
    These settings are saved on the property as
    <code>source: { kind: "external_api", endpoint, method, headers_env, query, list_path, map, cache_seconds }</code>.
    API keys are stored server‑side (not in Git).
  </small>
</div>


      <!-- Link biography block -->
      <div class="full"><span class="pill">Link Biography</span></div>

      {% set lb = (prop.link_biography if prop and prop.link_biography is defined else {}) %}

      <div>
        <label for="link_bio_type">Link biography type</label>
        <select id="link_bio_type" name="link_bio_type">
          <option value="">— none —</option>
          {% for t in available_types %}
            <option value="{{ t }}" {{ 'selected' if lb and lb.get('type')==t else '' }}>{{ t }}</option>
          {% endfor %}
        </select>
      </div>

      <div>
        <label for="link_bio_path">Link biography path (optional)</label>
        <input type="text" id="link_bio_path" name="link_bio_path"
               placeholder="e.g. hospitals"
               value="{{ lb.get('path','') if lb else '' }}">
        <small class="help">If you keep biographies in subfolders (optional).</small>
      </div>

      <div>
        <label for="link_bio_mode">Link biography mode</label>
        {% set mode_val = lb.get('mode','child_or_parent') if lb else 'child_or_parent' %}
        <select id="link_bio_mode" name="link_bio_mode">
          <option value="child_only" {{ 'selected' if mode_val=='child_only' else '' }}>child_only</option>
          <option value="parent_only" {{ 'selected' if mode_val=='parent_only' else '' }}>parent_only</option>
          <option value="child_or_parent" {{ 'selected' if mode_val=='child_or_parent' else '' }}>child_or_parent</option>
        </select>
      </div>

<!-- Auto‑link toggle (hidden unless a bio link is configured) -->
<div class="full" id="auto_link_container" style="display:none">
  <div class="row">
    <input type="checkbox" id="link_bio_auto" name="link_bio_auto"
      {% set _auto = (
           prop.refer_to.auto_link if (prop and prop.refer_to is defined) else
           (prop.link_biography.auto_link if (prop and prop.link_biography is defined) else False)
         ) %}
      {{ 'checked' if _auto else '' }}>
    <label for="link_bio_auto" style="margin:0">Auto‑link exact match</label>
  </div>
  <small class="help">
    When enabled, the Labels step will auto‑select a biography if there’s a single exact match for the current selection.
  </small>
</div>

      <!-- quick helpers -->
      <div class="row">
        <a class="btn secondary" href="{{ url_for('add_type_prompt') }}" target="_top">➕ Add Type</a>
        <a class="btn secondary" href="{{ url_for('create_subfolder', type_name=type_name) }}" target="_top">🏷️ Add Label Group</a>
      </div>

      <!-- Actions -->
      <div class="actions">
        <a class="btn secondary" href="{{ url_for('type_properties', type_name=type_name) }}">Cancel</a>
        <button type="submit" class="btn">Save Property</button>
      </div>
    </form>
  </div>

<script>
  // ---- Data from server for dynamic suggestions ----
  const CURRENT_TYPE = {{ type_name|tojson }};
  const LABEL_GROUPS_BY_TYPE = {{ (label_groups_by_type or {})|tojson }};
  const AVAILABLE_TYPES = {{ (available_types or [])|tojson }};

  // Elements
  const nameEl = document.getElementById('name');
  const keyEl  = document.getElementById('key');
  const sourceKindEl = document.getElementById('source_kind');
  const sourceTypeEl = document.getElementById('source_type');
  const sourcePathEl = document.getElementById('source_path');
  const allowChildrenEl = document.getElementById('source_allow_children');
  const datalist = document.getElementById('label_groups');
  const pathSelect = document.getElementById('source_path_select');

  // Legacy link‑bio controls + auto‑link container
  const linkBioTypeEl = document.getElementById('link_bio_type');
  const autoLinkContainer = document.getElementById('auto_link_container');

  // External API block
  const extApiBlock     = document.getElementById('external_api_block');
  const apiEndpointEl   = document.getElementById('api_endpoint');
  const apiMethodEl     = document.getElementById('api_method');
  const apiHeadersEnvEl = document.getElementById('api_headers_env');
  const apiCacheEl      = document.getElementById('api_cache_seconds');
  const apiQueryEl      = document.getElementById('api_query');
  const apiListPathEl   = document.getElementById('api_list_path');
  const apiMapIdEl      = document.getElementById('api_map_id');
  const apiMapDispEl    = document.getElementById('api_map_display');
  const apiMapDescEl    = document.getElementById('api_map_description');
  const apiMapImgEl     = document.getElementById('api_map_image_url');

  // External API: key panel elements
  const apiKeyBox    = document.getElementById('api_key_box');
  const apiKeyNameEl = document.getElementById('api_key_name');
  const apiKeyValue  = document.getElementById('api_key_value');
  const apiKeySave   = document.getElementById('api_key_save');
  const apiKeyCheck  = document.getElementById('api_key_check');
  const apiKeyStatus = document.getElementById('api_key_status');

  // External API: test controls
  const apiTestSearch = document.getElementById('api_test_search');
  const apiTestBtn    = document.getElementById('api_test_btn');
  const apiTestOut    = document.getElementById('api_test_result');

  let keyDirty = {{ 'true' if mode=='edit' else 'false' }};

  function toSnakeCase(s){
    return (s||'').trim().toLowerCase().replace(/[^a-z0-9]+/g,'_').replace(/^_+|_+$/g,'');
  }

  keyEl.addEventListener('input', () => { keyDirty = true; });
  nameEl.addEventListener('input', () => {
    if (keyDirty) return;
    keyEl.value = toSnakeCase(nameEl.value);
    if (sourceKindEl.value === 'self_labels' && !sourcePathEl.value) {
      sourcePathEl.value = keyEl.value;
    }
  });

  function fillGroupsUI(groups){
    datalist.innerHTML = '';
    pathSelect.innerHTML = '<option value="">— choose a group —</option>';
    (groups || []).forEach(g => {
      const opt = document.createElement('option');
      opt.value = g;
      datalist.appendChild(opt);
      const o2 = document.createElement('option');
      o2.value = g;
      o2.textContent = g;
      pathSelect.appendChild(o2);
    });
  }

  function refreshSourceControls(firstLoad=false){
    const kind = sourceKindEl.value;
    const isSelf = (kind === 'self_labels');
    const isLbls = (kind === 'type_labels');
    const isBios = (kind === 'type_biographies');
    const isApi  = (kind === 'external_api');

    // Enable/disable classic label controls
    sourceTypeEl.disabled     = !(isLbls || isBios);
    sourcePathEl.disabled     = !(isSelf || isLbls);
    pathSelect.disabled       = !(isSelf || isLbls);
    allowChildrenEl.disabled  = !(isSelf || isLbls);

    // Fill pickers for classic labels
    if (isSelf){
      fillGroupsUI(LABEL_GROUPS_BY_TYPE[CURRENT_TYPE] || []);
      if (!firstLoad && !sourcePathEl.value) {
        sourcePathEl.value = keyEl.value || toSnakeCase(nameEl.value);
      }
    } else if (isLbls){
      fillGroupsUI(LABEL_GROUPS_BY_TYPE[sourceTypeEl.value] || []);
    } else {
      fillGroupsUI([]);
      allowChildrenEl.checked = false;
    }

    // External API visibility
    showExternalApiConfig(isApi);

    // Keep legacy link fields dimmed if type_biographies is chosen
    toggleLegacyLinkBio();

    // Mirror link_bio_type from source_type when sensible
    maybeMirrorBioTypeFromSource();
    refreshAutoLinkVisibility();
  }

  function toggleLegacyLinkBio() {
    const isTBio = (sourceKindEl.value === 'type_biographies');
    ['link_bio_type', 'link_bio_path', 'link_bio_mode'].forEach(id => {
      const el = document.getElementById(id);
      if (!el) return;
      el.disabled = isTBio;
      el.closest('div')?.classList.toggle('muted', isTBio);
    });
  }

  // Mirror link_bio_type from source_type when sensible
  function maybeMirrorBioTypeFromSource() {
    if (!linkBioTypeEl) return;
    const kind = sourceKindEl.value;
    // Only auto-fill if user hasn't set a link type yet
    if (!linkBioTypeEl.value && (kind === 'self_labels' || kind === 'type_labels')) {
      const t = sourceTypeEl.value || '';
      if (t) {
        linkBioTypeEl.value = t;       // prefill
      }
    }
  }

  // Show/hide the auto-link row
  function refreshAutoLinkVisibility() {
    if (!autoLinkContainer) return;
    const kind = sourceKindEl.value;
    const hasTypeBios = (kind === 'type_biographies') && !!(sourceTypeEl.value);
    const hasLegacy   = !!(linkBioTypeEl && linkBioTypeEl.value);
    autoLinkContainer.style.display = (hasTypeBios || hasLegacy) ? 'block' : 'none';
  }

  // ---- External API helpers ----
  function showExternalApiConfig(show){
    if (!extApiBlock) return;
    extApiBlock.style.display = show ? 'block' : 'none';
    refreshKeyBox(); // keep key panel in sync
  }

  function refreshKeyBox(){
    if (!apiKeyBox) return;
    const isApi = (sourceKindEl.value === 'external_api');
    const envName = (apiHeadersEnvEl?.value || '').trim();
    apiKeyBox.style.display = (isApi && envName) ? 'block' : 'none';
    if (apiKeyNameEl) apiKeyNameEl.textContent = envName || '—';
  }

  function parseQueryJSON(){
    // Accept either JSON or blank
    const raw = (apiQueryEl?.value || '').trim();
    if (!raw) return {};
    try {
      return JSON.parse(raw);
    } catch(_){
      // Keep it resilient; the server will also validate.
      return {};
    }
  }

  async function saveKey(){
    const envName = (apiHeadersEnvEl?.value || '').trim();
    const value = (apiKeyValue?.value || '');
    if(!envName){ alert('Set the Env var name first'); return; }
    const res = await fetch('/api/admin/secrets/set', {
      method:'POST', headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ name: envName, value })
    });
    let data = {};
    try { data = await res.json(); } catch(_){}
    if (apiKeyStatus) {
      apiKeyStatus.textContent = (data && data.ok) ? 'Key saved on server.' : ('Save failed' + (data?.error ? ': ' + data.error : '.'));
    }
    if (data?.ok && apiKeyValue) apiKeyValue.value = '';
  }

  async function checkKey(){
    const envName = (apiHeadersEnvEl?.value || '').trim();
    if(!envName){ alert('Set the Env var name first'); return; }
    const res = await fetch('/api/admin/secrets/status', {
      method:'POST', headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ name: envName })
    });
    let data = {};
    try { data = await res.json(); } catch(_){}
    if (apiKeyStatus) {
      apiKeyStatus.textContent = (data && data.exists) ? 'Key present on server.' : 'No key stored yet.';
    }
  }

  async function testConnection(){
    if (apiTestOut) apiTestOut.textContent = 'Testing…';

    const source = {
      kind: 'external_api',
      endpoint:  apiEndpointEl?.value || '',
      method:    apiMethodEl?.value || 'GET',
      headers_env: apiHeadersEnvEl?.value || '',
      cache_seconds: apiCacheEl?.value || '',
      query:     parseQueryJSON(),
      list_path: apiListPathEl?.value || '',
      map: {
        id:          apiMapIdEl?.value || '',
        display:     apiMapDispEl?.value || '',
        description: apiMapDescEl?.value || '',
        image_url:   apiMapImgEl?.value || ''
      }
    };

    try{
      const res = await fetch('/api/admin/external/test', {
        method:'POST', headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ source, search: (apiTestSearch?.value || '') })
      });
      const data = await res.json();
      if(!data.ok){
        if (apiTestOut) apiTestOut.textContent = 'Error: ' + (data.error || 'unknown');
        return;
      }
      const sample = data.sample || [];
      if (apiTestOut) {
        apiTestOut.innerHTML = sample.length
          ? ('Sample: ' + sample.slice(0,3).map(o => `${o.display} (${o.id})`).join(', '))
          : 'No results (check endpoint/list_path/map).';
      }
    }catch(e){
      if (apiTestOut) apiTestOut.textContent = 'Request failed: ' + (e?.message || e);
    }
  }

  // Wire up listeners
  sourceKindEl.addEventListener('change', () => {
    refreshSourceControls(false);
  });
  sourceTypeEl.addEventListener('change', () => {
    // keep UI in sync and mirror if empty
    maybeMirrorBioTypeFromSource();
    refreshSourceControls(false);
  });
  if (linkBioTypeEl) {
    linkBioTypeEl.addEventListener('change', refreshAutoLinkVisibility);
  }

  // Mirror dropdown selection into the text input
  pathSelect.addEventListener('change', () => {
    if (pathSelect.value) sourcePathEl.value = pathSelect.value;
  });

  // External API listeners
  apiHeadersEnvEl?.addEventListener('input', refreshKeyBox);
  apiKeySave?.addEventListener('click', saveKey);
  apiKeyCheck?.addEventListener('click', checkKey);
  apiTestBtn?.addEventListener('click', testConnection);

  // Init on load
  document.addEventListener('DOMContentLoaded', () => {
    const initialKind = '{{ ui_kind }}';
    if (initialKind === 'self_labels') {
      sourceKindEl.value = 'self_labels';
    }
    // If the saved property is external_api, make sure it shows immediately.
    if (initialKind === 'external_api') {
      showExternalApiConfig(true);
    }
    refreshSourceControls(true);

    // Preselect dropdown if the text value already matches
    const match = Array.from(pathSelect.options).find(o => o.value === sourcePathEl.value);
    if (match) pathSelect.value = match.value;

    // Ensure visibility is correct on load
    refreshAutoLinkVisibility();
    refreshKeyBox();
  });
</script>

</body>
</html>


