<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>{{ (bio.name or bio_id|replace('_',' ')|title) }} ‚Äî {{ type_name|replace('_',' ')|title }}</title>
  <link rel="stylesheet" href="/static/styles.css">
  <style>
    body{ background:#f6f7fb; font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial; }
    .wrap{ max-width:1100px; margin:32px auto; background:#fff; border:1px solid #e7e9f2; border-radius:14px; box-shadow:0 8px 24px rgba(0,0,0,.05); padding:24px; }
    .header{ display:flex; align-items:center; justify-content:space-between; gap:12px; }
    h1{ margin:0; }
    .muted{ color:#6b7280; }
    .toolbar{ display:flex; flex-wrap:wrap; gap:10px; }
    .btn{display:inline-block;padding:10px 16px;border-radius:10px;background:#6c63ff;color:#fff;text-decoration:none;font-weight:600}
    .btn.secondary{background:#eef0f7;color:#333}
    .btn.ghost{background:transparent;color:#6c63ff;border:1px solid #6c63ff}
    .btn.gray{background:#e5e7eb;color:#222}
    .grid{ display:grid; grid-template-columns: 1fr 1fr; gap:16px; }
    @media (max-width: 900px){ .grid{ grid-template-columns: 1fr; } }
    .card{ background:#fff; border:1px solid #e7e9f2; border-radius:12px; padding:16px; }
    .section-title{ margin:0 0 8px; font-size:18px; color:#2f2f36; }
    .pill{ display:inline-block; padding:3px 8px; border-radius:999px; font-size:12px; background:#eef0f7; color:#333; }
    .label-row{ border-left:4px solid #e5e7eb; padding:10px 12px; border-radius:8px; margin:10px 0; background:#fafafa; }
    .event-row{ border-left:5px solid #cfe0ff; background:#f4f8ff; border-radius:10px; padding:10px 12px; margin:10px 0; }
    .conf{ font-size:12px; font-weight:700; margin-left:6px; }
    .conf.high{ color:#16a34a; } .conf.med{ color:#f59e0b; } .conf.low{ color:#ef4444; }
    .biochip{ background:#eef5f2; border-left:4px solid #2e7d32; padding:8px 10px; border-radius:8px; margin-top:6px; }
    .kv{ display:grid; grid-template-columns: 160px 1fr; gap:6px; }
    .small{ font-size:12px; color:#6b7280; }
    .mono{ font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace; }

    /* Entry toggles */
    .entry-list{ margin:8px 0 0 0; padding:0; list-style:none; }
    .entry-block{ border:1px solid #e7e9f2; border-radius:10px; margin:12px 0; overflow:hidden; background:#fff; }
    .entry-header{ display:flex; gap:12px; align-items:flex-start; justify-content:space-between; cursor:pointer; padding:12px 14px; background:#f7f8fc; border-bottom:1px solid #eef0f7; }
    .entry-left{ display:flex; gap:10px; align-items:center; }
    .chevron{ width:20px; text-align:center; }
    .entry-title{ font-weight:700; }
    .entry-meta{ font-size:12px; color:#6b7280; margin-top:2px; }
    .entry-content{ max-height:0; overflow:hidden; opacity:0; transition:max-height .25s ease, opacity .25s ease; padding:0 14px; }
    .entry-block.expanded .entry-content{ padding:14px; max-height:2000px; opacity:1; }
    .entry-toolbar{ text-align:right; margin-top:6px; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="header">
      <div>
        <h1>{{ bio.name or bio_id|replace('_',' ')|title }}</h1>
        <div class="muted">{{ type_name|replace('_',' ')|title }} ‚Ä¢ ID: <span class="mono">{{ bio_id }}</span></div>
      </div>
      <div class="toolbar">
        <a class="btn secondary" href="{{ url_for('type_browse', type_name=type_name) }}">‚¨ÖÔ∏è Back to {{ type_name|replace('_',' ')|title }}</a>
        <a class="btn ghost" href="{{ url_for('most_like_type', type_name=type_name, bio_id=bio_id) }}">üîç Find Similar {{ type_name|replace('_',' ')|title }}</a>
      </div>
    </div>

    {% set entries = bio.entries or [] %}
    {% set entry = entries[-1] if entries else {} %}

    <div class="grid" style="margin-top:16px">
      <!-- Left: snapshot -->
      <div class="card">
        <h3 class="section-title">üìÑ Snapshot</h3>
        <div class="kv">
          <div class="muted">Last updated</div>
          <div>{{ (bio.updated or bio.created or '')|uk_datetime }}</div>

          <div class="muted">Time</div>
          <div>
            {% if entry.time %}
              {% if entry.time.date_value %}{{ entry.time.date_value|uk_date }}
              {% elif entry.time.subvalue %}{{ entry.time.subvalue|replace('_',' ')|title }}
              {% elif entry.time.start_date or entry.time.end_date %}
                {{ (entry.time.start_date or '')|uk_date }} ‚Ä¶ {{ (entry.time.end_date or '')|uk_date }}
              {% else %}‚Äî{% endif %}
              {% set c = entry.time.confidence or 100 %}
              <span class="conf {% if c>=67 %}high{% elif c>=34 %}med{% else %}low{% endif %}">{{ c }}%</span>
            {% else %}‚Äî{% endif %}
          </div>

          {% if entry.time_normalised %}
            <div class="muted">Time (normalised)</div>
            <div class="small">
              {% set tn = entry.time_normalised %}
              {% if tn.start_iso %}{{ tn.start_iso|uk_date }}{% else %}‚Äî{% endif %}
              {% if tn.end_iso %} ‚Äì {{ tn.end_iso|uk_date }}{% endif %}
              {% if tn.precision %} ({{ tn.precision|replace('_',' ') }}){% endif %}
            </div>
          {% endif %}

          {% if bio.description %}
            <div class="muted">Description</div>
            <div>{{ bio.description }}</div>
          {% endif %}
        </div>
      </div>

      <!-- Right: actions / meta -->
      <div class="card">
        <h3 class="section-title">‚öôÔ∏è Actions</h3>
        <p class="small">Use the Label Wizard to change labels; add more time entries; or search/edit the raw biography.</p>
        <div class="small" style="display:flex; gap:8px; flex-wrap:wrap;">
          <a class="btn ghost" href="{{ url_for('general_iframe_wizard', type=type_name, bio_id=bio_id, step='time', add=1) }}">‚è±Ô∏è Add Time Period</a>
          <a class="btn" href="{{ url_for('general_iframe_wizard', type=type_name, bio_id=bio_id, step='start', edit_entry_index=(entries|length - 1 if entries else 0)) }}" target="_top">‚úèÔ∏è Edit (From Start)</a>

          {% set return_to = request.referrer or request.url %}
          {% if bio.get('archived') %}
            <form method="post" action="{{ url_for('api_unarchive_bio', type_name=type_name, bio_id=bio_id) }}" style="display:inline;">
              <input type="hidden" name="next" value="{{ return_to }}">
              <button type="submit" class="btn secondary" style="background:#4CAF50;color:#fff;">‚ôªÔ∏è Unarchive</button>
            </form>
          {% else %}
            <form method="post" action="{{ url_for('api_archive_bio', type_name=type_name, bio_id=bio_id) }}" style="display:inline;">
              <input type="hidden" name="next" value="{{ return_to }}">
              <button type="submit" class="btn secondary" style="background:#c62828;color:#fff;">üóÑÔ∏è Archive Biography</button>
            </form>
          {% endif %}
        </div>
      </div>
    </div>

    {% set latest_events = entry.get('events') or [] %}
    {% if latest_events %}
      <div class="card" style="margin-top:16px">
        <h3 class="section-title">üéØ Events (latest entry)</h3>
        {% for ev in latest_events %}
          {% set conf = ev.confidence or 100 %}
          <div class="event-row">
            <div>
              <strong>Option:</strong>
              {{ (ev.option_display or ev.option_id)|default('Unnamed', true) }}
              {% if ev.child_option_id %} <span class="muted">‚Üí {{ ev.child_option_id }}</span>{% endif %}
              <span class="conf {% if conf>=67 %}high{% elif conf>=34 %}med{% else %}low{% endif %}">{{ conf }}%</span>
            </div>

            {% if ev.link_type or ev.linked_bio %}
              <div class="small" style="margin-top:4px">
                <strong>Link:</strong>
                {{ ev.link_type|replace('_',' ')|title if ev.link_type else '‚Äî' }}
                {% if ev.linked_bio %} ‚Üí <code class="mono">{{ ev.linked_bio }}</code>{% endif %}
              </div>
            {% endif %}

            {% if ev.time %}
              <div class="small" style="margin-top:4px">
                <strong>Time:</strong>
                {% if ev.time.date_value %}
                  {{ ev.time.date_value|uk_date }}
                {% elif ev.time.label_id or ev.time.label_free %}
                  {{ ev.time.label_id or ev.time.label_free }}
                {% elif ev.time.subvalue %}
                  {{ ev.time.subvalue|replace('_',' ')|title }}
                {% elif ev.time.start_date or ev.time.end_date %}
                  {{ (ev.time.start_date or '')|uk_date }} ‚Ä¶ {{ (ev.time.end_date or '')|uk_date }}
                {% else %}‚Äî{% endif %}
                {% if ev.time.confidence is not none %}
                  <span class="conf {% if (ev.time.confidence or 100) >= 67 %}high{% elif (ev.time.confidence or 100) >= 34 %}med{% else %}low{% endif %}">
                    {{ ev.time.confidence or 100 }}%
                  </span>
                {% endif %}
              </div>
            {% endif %}
          </div>
        {% endfor %}
      </div>
    {% endif %}

    <!-- Labels for the current (latest) entry, excluding events -->
    <div class="card" style="margin-top:16px">
      <h3 class="section-title">üè∑Ô∏è Labels (latest entry)</h3>
      {% if entry %}
        {% for type_key, type_items in entry.items() %}
          {% if type_key not in ['time','time_normalised','created','updated','status','events'] and type_items %}
            {% if type_items is sequence and not (type_items is string) %}
              <h4 style="margin:18px 0 8px">{{ type_key|replace('_',' ')|title }}</h4>
              {% for label in type_items %}
                {% if label is mapping %}
                  {% set conf = label.confidence or 100 %}
                  <div class="label-row">
                    <div>
                      <strong>{{ (label.get('label_type') or 'Label')|replace('_',' ')|title }}</strong>
                      ‚Äî
                      {% set display_text = (label.get('display') or label.get('label') or label.get('id') or 'Unnamed') %}
                      {{ display_text|replace('_',' ')|title }}
                      <span class="conf {% if conf>=67 %}high{% elif conf>=34 %}med{% else %}low{% endif %}">{{ conf }}%</span>
                    </div>

                    {% if label.biography_data %}
                      <div class="biochip">
                        üìñ <strong>{{ label.biography_data.get('name','') }}</strong>
                        {% if label.biography_data.get('description') %}
                          <div class="small">{{ label.biography_data.description }}</div>
                        {% endif %}
                      </div>
                    {% elif label.biography %}
                      <div class="biochip">
                        üìñ Linked biography: <span class="mono">{{ label.biography }}</span>
                      </div>
                    {% endif %}

                    {% if label.description %}
                      <div class="small" style="margin-top:6px">{{ label.description }}</div>
                    {% endif %}

                    {% if label.image_url %}
                      <div style="margin-top:8px"><img src="{{ label.image_url }}" style="max-height:90px;border-radius:8px"></div>
                    {% endif %}
                  </div>
                {% endif %}
              {% endfor %}
            {% endif %}
          {% endif %}
        {% endfor %}
      {% else %}
        <div class="muted">No entries yet.</div>
      {% endif %}
    </div>

    <!-- Entries (toggleable summaries) -->
    <div class="card" style="margin-top:16px">
      <div style="display:flex;justify-content:space-between;align-items:center;">
        <h3 class="section-title">üóÇÔ∏è Entries (details)</h3>
        <div class="entry-toolbar">
          <button class="btn gray" type="button" onclick="toggleAll(true)">üü¢ Expand All</button>
          <button class="btn gray" type="button" onclick="toggleAll(false)">üôà Collapse All</button>
        </div>
      </div>

      {% if entries %}
        <ul class="entry-list">
          {% for e in entries %}
            {% set idx = loop.index0 %}
            {% set t = e.time or {} %}
            {% set time_label = (
                t.date_value if t.date_value else
                (t.subvalue|replace('_',' ')|title if t.subvalue else
                 ((t.start_date or '') ~ ' ‚Ä¶ ' ~ (t.end_date or '')))
            ) %}
            {% set label_groups = [] %}
            {% for k,v in e.items() %}
              {% if k not in ['time','time_normalised','created','updated','status'] and v and (v is sequence) and not (v is string) %}
                {% set _ = label_groups.append(k) %}
              {% endif %}
            {% endfor %}
            <li class="entry-block" id="entry-{{ idx }}">
              <div class="entry-header" role="button" aria-expanded="false" onclick="toggleEntry({{ idx }})">
                <div class="entry-left">
                  <div class="chevron" aria-hidden="true">‚ñ∂Ô∏è</div>
                  <div>
                    <div class="entry-title">{{ (time_label or 'Unknown')|trim|replace('  ', ' ')|uk_date }}</div>
                    <div class="entry-meta">
                      {% if e.created %}Created {{ e.created|uk_datetime }} ‚Ä¢ {% endif %}
                      {% if e.updated %}Updated {{ e.updated|uk_datetime }} ‚Ä¢ {% endif %}
                      {{ label_groups|length }} group{{ '' if label_groups|length==1 else 's' }}
                    </div>
                  </div>
                </div>
                <div class="entry-actions">
                  <a class="small" target="_top"
                     href="{{ url_for('general_iframe_wizard', type=type_name, bio_id=bio_id, step='time', edit_entry_index=idx) }}">
                    Open in wizard
                  </a>
                </div>
              </div>

              <div class="entry-content">
                {% if e.time_normalised %}
                  <div class="small" style="margin-bottom:8px; color:#374151;">
                    <strong>Normalised:</strong>
                    {% set tn = e.time_normalised %}
                    {% if tn.start_iso %}{{ tn.start_iso|uk_date }}{% else %}‚Äî{% endif %}
                    {% if tn.end_iso %} ‚Äì {{ tn.end_iso|uk_date }}{% endif %}
                    {% if tn.precision %} ({{ tn.precision }}){% endif %}
                    {% if tn.age_years is not none %} ‚Ä¢ age ‚âà {{ tn.age_years }}{% endif %}
                  </div>
                {% endif %}

                {% if e.get('events') %}
                  <h4 style="margin:10px 0 6px">Events</h4>
                  {% for ev in e.events %}
                    {% set conf = ev.confidence or 100 %}
                    <div class="event-row">
                      <div>
                        <strong>Option:</strong>
                        {{ (ev.option_display or ev.option_id)|default('Unnamed', true) }}
                        {% if ev.child_option_id %}<span class="muted">‚Üí {{ ev.child_option_id }}</span>{% endif %}
                        <span class="conf {% if conf>=67 %}high{% elif conf>=34 %}med{% else %}low{% endif %}">{{ conf }}%</span>
                      </div>
                      {% if ev.link_type or ev.linked_bio %}
                        <div class="small" style="margin-top:4px">
                          <strong>Link:</strong>
                          {{ ev.link_type|replace('_',' ')|title if ev.link_type else '‚Äî' }}
                          {% if ev.linked_bio %} ‚Üí <code class="mono">{{ ev.linked_bio }}</code>{% endif %}
                        </div>
                      {% endif %}
                      {% if ev.time %}
                        <div class="small" style="margin-top:4px">
                          <strong>Time:</strong>
                          {% if ev.time.date_value %}
                            {{ ev.time.date_value|uk_date }}
                          {% elif ev.time.label_id or ev.time.label_free %}
                            {{ ev.time.label_id or ev.time.label_free }}
                          {% elif ev.time.subvalue %}
                            {{ ev.time.subvalue|replace('_',' ')|title }}
                          {% elif ev.time.start_date or ev.time.end_date %}
                            {{ (ev.time.start_date or '')|uk_date }} ‚Ä¶ {{ (ev.time.end_date or '')|uk_date }}
                          {% else %}‚Äî{% endif %}
                          {% if ev.time.confidence is not none %}
                            <span class="conf {% if (ev.time.confidence or 100) >= 67 %}high{% elif (ev.time.confidence or 100) >= 34 %}med{% else %}low{% endif %}">
                              {{ ev.time.confidence or 100 }}%
                            </span>
                          {% endif %}
                        </div>
                      {% endif %}
                    </div>
                  {% endfor %}
                {% endif %}

                {% for k in label_groups if k != 'events' %}
                  <h4 style="margin:10px 0 6px">{{ k.replace('_',' ')|title }}</h4>
                  {% for item in e[k] %}
                    {% if item is mapping %}
                      {% set conf = item.confidence or 100 %}
                      <div class="label-row">
                        <div>
                          <strong>{{ (item.get('label_type') or 'Label')|replace('_',' ')|title }}</strong> ‚Äî
                          {{ (item.get('display') or item.get('label') or item.get('id') or 'Unnamed')|replace('_',' ')|title }}
                          <span class="conf {% if conf>=67 %}high{% elif conf>=34 %}med{% else %}low{% endif %}">{{ conf }}%</span>
                        </div>
                        {% if item.biography_data %}
                          <div class="biochip">
                            üìñ <strong>{{ item.biography_data.get('name','') }}</strong>
                            {% if item.biography_data.get('description') %}
                              <div class="small">{{ item.biography_data.description }}</div>
                            {% endif %}
                          </div>
                        {% elif item.biography %}
                          <div class="biochip">üìñ Linked biography: <span class="mono">{{ item.biography }}</span></div>
                        {% endif %}
                        {% if item.description %}
                          <div class="small" style="margin-top:6px">{{ item.description }}</div>
                        {% endif %}
                        {% if item.image_url %}
                          <div style="margin-top:8px"><img src="{{ item.image_url }}" style="max-height:90px;border-radius:8px"></div>
                        {% endif %}
                      </div>
                    {% endif %}
                  {% endfor %}
                {% endfor %}
              </div>
            </li>
          {% endfor %}
        </ul>
      {% else %}
        <div class="muted">No entries recorded.</div>
      {% endif %}
    </div>

    <!-- Timeline (compact) -->
    <div class="card" style="margin-top:16px">
      <h3 class="section-title">üóìÔ∏è Entries (compact)</h3>
      {% if entries %}
        <ol class="small" style="margin:0 0 0 18px">
          {% for e in entries|reverse %}
            <li>
              {% if e.time and e.time.date_value %}
                {{ e.time.date_value|uk_date }}
              {% elif e.time and e.time.subvalue %}
                {{ e.time.subvalue|replace('_',' ')|title }}
              {% elif e.time and (e.time.start_date or e.time.end_date) %}
                {{ (e.time.start_date or '')|uk_date }} ‚Ä¶ {{ (e.time.end_date or '')|uk_date }}
              {% else %}Unknown time{% endif %}
              {% if e.created %}<span class="muted"> ‚Ä¢ created {{ e.created|uk_datetime }}</span>{% endif %}
            </li>
          {% endfor %}
        </ol>
      {% else %}
        <div class="muted">No entries recorded.</div>
      {% endif %}
    </div>

    <!-- Raw JSON (debug) -->
    <div class="card" style="margin-top:16px">
      <details>
        <summary class="section-title">üß™ Debug JSON</summary>
        <pre class="mono" style="white-space:pre-wrap">{{ bio | tojson(indent=2) }}</pre>
      </details>
    </div>
  </div>

  <script>
    function toggleEntry(index){
      const block = document.getElementById('entry-'+index);
      if(!block) return;
      block.classList.toggle('expanded');
      const chev = block.querySelector('.chevron');
      if(chev) chev.textContent = block.classList.contains('expanded') ? 'üîΩ' : '‚ñ∂Ô∏è';
      const hdr = block.querySelector('.entry-header');
      if(hdr) hdr.setAttribute('aria-expanded', block.classList.contains('expanded') ? 'true' : 'false');
    }
    function toggleAll(expand){
      document.querySelectorAll('.entry-block').forEach(b=>{
        b.classList.toggle('expanded', !!expand);
        const chev = b.querySelector('.chevron');
        if(chev) chev.textContent = expand ? 'üîΩ' : '‚ñ∂Ô∏è';
        const hdr = b.querySelector('.entry-header');
        if(hdr) hdr.setAttribute('aria-expanded', expand ? 'true' : 'false');
      });
    }
  </script>
</body>
</html>
