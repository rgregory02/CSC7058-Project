<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Step: Time</title>
  <link rel="stylesheet" href="/static/styles.css" />
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      background: #f4f6f8;
      padding: 40px;
      text-align: center;
    }
    .box {
      background: white;
      max-width: 650px;
      margin: auto;
      padding: 35px 30px;
      border-radius: 14px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.08);
    }
    h1 {
      font-size: 2rem;
      margin-bottom: 10px;
      color: #333;
    }
    .person-name {
      font-size: 1.5rem;
      font-weight: bold;
      color: #6f42c1;
      margin-bottom: 15px;
    }

    label {
      display: block;
      margin-top: 20px;
      font-weight: 600;
      text-align: left;
    }
    select, input[type="date"], input[type="range"] {
      width: 100%;
      padding: 12px;
      margin-top: 8px;
      margin-bottom: 18px;
      font-size: 1rem;
      border: 1px solid #ccc;
      border-radius: 8px;
    }

    .add-entry-button {
      background-color: #28a745;
      color: white;
      padding: 12px 24px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 1rem;
      margin-top: 10px;
    }

    .section-title {
      margin-top: 30px;
      font-weight: bold;
      font-size: 1.2em;
      color: #333;
    }

    .confidence-exact { color: green; font-weight: bold; }
    .confidence-high { color: green; }
    .confidence-medium { color: orange; }
    .confidence-low { color: red; }

    .confidence-meta {
      font-size: 0.9rem;
    }

    .icon {
      margin-right: 6px;
    }

    .back-button {
      display: inline-block;
      margin-top: 25px;
      background: #6c757d;
      color: white;
      padding: 8px 16px;
      text-decoration: none;
      border-radius: 6px;
      font-size: 0.95rem;
    }
  </style>
</head>
<body>
  <div class="box">
    <h1>üï∞Ô∏è Step: Time</h1>
    <div class="person-name">Name: {{ name }}</div>

    {% if session.edit_entry_index is defined %}
      <div style="color: orange; font-weight: bold; margin-bottom: 10px;">
        ‚úèÔ∏è Editing Time Entry #{{ session.edit_entry_index }}
        <form method="POST" action="{{ url_for('person_step_time', person_id=person_id) }}" style="display:inline;">
          <input type="hidden" name="cancel_edit" value="true">
          <button type="submit" class="back-button" style="margin-left: 12px; background-color: #dc3545;">
            ‚ùå Cancel Edit
          </button>
        </form>
      </div>
    {% endif %}

    <hr>

    <form method="POST">
      <label for="label_type">üìÖ Choose a time type:</label>
      <select id="label_type" name="label_type" required onchange="this.form.submit()">
        <option value="">-- Select Time Label --</option>
        {% for label, desc in label_files %}
          <option value="{{ label }}" {% if label == selected_label_type %}selected{% endif %}>
            {{ label|replace('_', ' ')|title }}{% if desc %} ‚Äì {{ desc }}{% endif %}
          </option>
        {% endfor %}
      </select>

      {% if selected_label_type == "date" %}
        <label for="date_value">üìÜ Pick a date:</label>
        <input type="date" id="date_value" name="date_value" value="{{ selected_date or '' }}">
      {% elif subfolder_labels %}
        <label for="subvalue">üìö Select a value:</label>
        <select id="subvalue" name="subvalue">
          {% for item in subfolder_labels %}
            <option value="{{ item }}" {% if item == selected_subvalue %}selected{% endif %}>
              {{ item|replace('_', ' ')|title }}
            </option>
          {% endfor %}
        </select>
      {% endif %}

      {% if selected_label_type %}
        <label for="confidence">üéØ Confidence:</label>
        <input type="range" id="confidence" name="confidence" min="0" max="100"
                value="{{ selected_confidence | default(100, true) }}" oninput="updateConfidenceDisplay()" />
        <span id="confidence_display">{{ selected_confidence | default(100, true) }}</span>%
        <div class="confidence-meta"><small id="confidence_level" class=""></small></div>

        <button type="submit" class="add-entry-button">‚úÖ Save Time Selection</button>
      {% endif %}
    </form>

    <hr>

    {% if existing_entries %}
      <div class="section-title">üïí Current Time Period</div>
      <ul>
        {% set last = existing_entries[-1] %}
        <li>
          {{ last[0]|replace('_', ' ')|title }} ‚Äì Confidence:
          <span class="{% if last[1]|int == 100 %}confidence-exact{% elif last[1]|int >= 67 %}confidence-high{% elif last[1]|int >= 34 %}confidence-medium{% else %}confidence-low{% endif %}">
            {{ last[1] }}{% if last[1]|int == 100 %} (Exact){% endif %}
          </span>
        </li>
      </ul>

      {% if existing_entries|length > 1 %}
        <div class="section-title">üìú Previous Time Periods</div>
        <ul>
          {% for tag, conf in existing_entries[:-1] %}
            <li>
              {{ tag|replace('_', ' ')|title }} ‚Äì Confidence:
              <span class="{% if conf|int == 100 %}confidence-exact{% elif conf|int >= 67 %}confidence-high{% elif conf|int >= 34 %}confidence-medium{% else %}confidence-low{% endif %}">
                {{ conf }}{% if conf|int == 100 %} (Exact){% endif %}
              </span>
            </li>
          {% endfor %}
        </ul>
      {% endif %}
    {% else %}
      <p><em>No time period selected yet.</em></p>
    {% endif %}

    {% if request.referrer %}
      <a href="{{ request.referrer }}" class="back-button">‚¨ÖÔ∏è Return to Last Step</a>
    {% endif %}
  </div>

  <script>
    function updateConfidenceDisplay() {
      const slider = document.getElementById("confidence");
      const value = parseInt(slider.value || 0);
      document.getElementById("confidence_display").textContent = value;

      const level = document.getElementById("confidence_level");
      if (value === 100) {
        level.textContent = "Confidence level: Exact";
        level.style.color = "green";
      } else if (value >= 67) {
        level.textContent = "Confidence level: High";
        level.style.color = "green";
      } else if (value >= 34) {
        level.textContent = "Confidence level: Medium";
        level.style.color = "orange";
      } else {
        level.textContent = "Confidence level: Low";
        level.style.color = "red";
      }
    }
    document.addEventListener("DOMContentLoaded", updateConfidenceDisplay);
  </script>
</body>
</html>