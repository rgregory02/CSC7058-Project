<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>{{ type_name|replace('_',' ')|title }} ‚Äî Labels</title>
  <link rel="stylesheet" href="/static/styles.css">
  <style>
    :root{
      --bg:#f6f7fb;
      --card:#fff;
      --ink:#1f2937;
      --muted:#657085;
      --line:#e6e8f1;
      --chip:#f3f4f9;
      --chip-ink:#445;
      --brand:#6c63ff;
      --brand-ink:#fff;
      --danger:#c62828;
      --success:#2e7d32;
    }
    body{background:var(--bg);font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;color:var(--ink)}
    .box{max-width:1100px;margin:32px auto;background:var(--card);padding:22px;border-radius:14px;box-shadow:0 10px 30px rgba(0,0,0,.06)}
    h1{margin:0 0 4px;font-weight:750}
    /* toolbar */
    .toolbar{display:flex;gap:10px;align-items:center;justify-content:space-between;margin:6px 0 14px}
    .left, .right{display:flex;gap:10px;align-items:center}
    .search{width:360px;max-width:52vw;padding:10px 12px 10px 36px;border:1px solid var(--line);border-radius:10px;background:#fff url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="%23657085" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>') 10px 50% no-repeat}
    .chip{display:inline-flex;align-items:center;gap:6px;font-size:12px;background:var(--chip);color:var(--chip-ink);border:1px solid var(--line);border-radius:999px;padding:4px 8px}
    .btn{display:inline-flex;align-items:center;gap:8px;padding:8px 12px;border-radius:10px;border:1px solid var(--line);background:#fff;color:var(--ink);text-decoration:none;font-weight:600}
    .btn.brand{background:var(--brand);border-color:var(--brand);color:#fff}
    .btn.ghost{background:transparent}
    .btn.small{padding:6px 9px;font-weight:600}
    .btn.danger{background:#fff;border-color:#f4c9cf;color:#a11}
    .btn.success{background:#fff;border-color:#c8e9cc;color:#2e7d32}

    /* grid */
    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(340px,1fr));gap:14px}
    .card{border:1px solid var(--line);border-radius:12px;padding:14px;background:#fff;position:relative;display:flex;flex-direction:column;gap:8px}
    .card.archived{opacity:.75}
    .card.focused{box-shadow:0 0 0 3px rgba(108,99,255,.2)}
    .card h3{margin:0 0 2px;font-size:16px}
    .meta{display:flex;flex-wrap:wrap;gap:6px 8px;align-items:center}
    .note{color:var(--muted);font-size:12px}
    .badge{display:inline-flex;align-items:center;padding:2px 6px;border-radius:7px;border:1px solid var(--line);background:var(--chip);font-size:11px;color:#495}
    .badge.arch{background:#fff0f5;border-color:#f5ccd8;color:#a11}
    .actions{display:flex;gap:8px;margin-left:auto}
    .divider{height:1px;background:var(--line);margin:6px 0}

    /* options panel */
    details.opts{border:1px dashed var(--line);border-radius:10px;background:#fafbff}
    details.opts>summary{cursor:pointer;list-style:none;padding:8px 10px;font-weight:700}
    details.opts>summary::marker, details.opts>summary::-webkit-details-marker{display:none}
    .optwrap{padding:8px 10px;max-height:320px;overflow:auto}
    .option{border:1px solid var(--line);border-radius:10px;padding:10px;margin:8px 0;background:#fff}
    .option.is-archived{opacity:.6}
    .opt-head{display:flex;justify-content:space-between;gap:8px}
    .opt-title{font-weight:700}
    .opt-desc{color:var(--muted);font-size:12px;margin-top:4px;overflow:hidden;text-overflow:ellipsis;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical}
    .thumb{max-height:36px;max-width:72px;vertical-align:middle;margin-left:8px;border-radius:6px}
    .children{margin:8px 0 0 12px;border-left:3px solid var(--line);padding-left:10px}

    /* helpers */
    .row{display:flex;align-items:center;gap:10px;flex-wrap:wrap}
    .empty{color:var(--muted);font-size:13px}
    a.inline{color:var(--brand);text-decoration:none}
  </style>
</head>
<body>
  <div class="box">
    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        <div class="row" style="margin:0 0 12px;flex-wrap:wrap">
          {% for cat, msg in messages %}
            <span class="chip">{{ msg }}</span>
          {% endfor %}
        </div>
      {% endif %}
    {% endwith %}

    <h1>üè∑Ô∏è {{ type_name|replace('_',' ')|title }} - Labels</h1>
    <div class="muted">Configure labels related to this type. Labels can pull from labels folders, APIs, or databases, and optionally link to other property types.</div>

<div class="toolbar">
  <div class="left">
    <input id="search" class="search" placeholder="Filter label groups‚Ä¶" oninput="filterLabels(this.value)" aria-label="Filter label groups">
    <select id="statusFilter" class="select" onchange="applyFilters()" title="Show Active or Archived">
      <option value="">All statuses</option>
      <option value="active">Active</option>
      <option value="archived">Archived</option>
    </select>
  </div>
  <div class="right">
  <a class="btn brand" href="{{ url_for('create_subfolder', type_name=type_name, return_url=request.url) }}">‚ûï New Label</a>
    <a class="btn" href="{{ request.args.get('return_url') or url_for('type_browse', type_name=type_name) }}">‚¨Ö Back to {{ type_name|replace('_',' ')|title }}</a>
    
  </div>
</div>

    <div class="grid" id="groups">
      {% for g in groups %}
        {% set is_archived = g.archived %}
{% set status = 'archived' if is_archived else 'active' %}
<div class="card group {% if is_archived %}archived{% endif %}"
     id="group_{{ g.key|replace('/','__') }}"
     data-key="{{ (g.key ~ ' ' ~ (g.label or '') ~ ' ' ~ (g.description or ''))|lower }}"
     data-status="{{ status }}">
          <div class="row" style="align-items:flex-start">
            <div style="min-width:0">
              <h3 title="{{ g.label }}">{{ g.label }}</h3>
              <div class="meta">
                <span class="chip" title="Option count">{{ g.count }} options</span>
                {% if g.kind == 'folder' %}
                  <span class="badge">Folder</span>
                {% elif g.kind == 'property_link' %}
                  <span class="badge">Property link</span>
                {% endif %}
                {% if g.archived %}
                  <span class="badge arch">Archived</span>
                {% endif %}
              </div>
              {% if g.description %}
                <div class="note" title="{{ g.description }}">{{ g.description }}</div>
              {% endif %}
              {% if g.kind == 'property_link' and g.target_type and g.target_type != type_name %}
                <div class="note">
                  From <a class="inline" href="{{ url_for('type_labels', type_name=g.target_type) }}?focus={{ g.target_path|urlencode }}">{{ g.target_type }}</a>
                  <span class="badge" style="margin-left:6px">{{ g.target_path }}</span>
                </div>
              {% elif g.kind == 'property_link' and g.target_path %}
                <div class="note">
                  Path <span class="badge" style="margin-left:6px">{{ g.target_path }}</span>
                </div>
              {% endif %}
            </div>

            <div class="actions">
              <a class="btn small ghost" href="{{ url_for('edit_label_group', type_name=type_name, group_key=g.key) }}" title="Edit group">‚úèÔ∏è Edit</a>

              {% set grp_action = 'api_unarchive_label_group' if g.archived else 'api_archive_label_group' %}
              <form method="post" action="{{ url_for(grp_action, type_name=type_name) }}">
                <input type="hidden" name="group_key" value="{{ g.key }}">
                <input type="hidden" name="next" value="{{ request.url }}">
                <button class="btn small {% if g.archived %}success{% else %}danger{% endif %}" type="submit">
                  {% if g.archived %}‚ôªÔ∏è Unarchive{% else %}üóÑÔ∏è Archive{% endif %}
                </button>
              </form>
            </div>
          </div>

          {% if g.options and g.options|length > 0 %}
            <details class="opts" {% if request.args.get('focus') and (g.key == request.args.get('focus') or g.target_path == request.args.get('focus')) %} open {% endif %}>
              <summary>‚ñ∏ Show options</summary>
              <div class="optwrap">
                {% for o in g.options %}
                  <div class="option {% if o.archived %}is-archived{% endif %}" data-archived="{{ '1' if o.archived else '0' }}">
                    <div class="opt-head">
                      <div class="row" style="gap:6px">
                        <div class="opt-title">{{ o.display or o.id }}</div>
                        {% if o.archived %}<span class="badge arch">Archived</span>{% endif %}
                        {% if o.image_url %}<img class="thumb" src="{{ o.image_url }}" alt="">{% endif %}
                      </div>
                      <form method="post" action="{{ url_for(( 'api_unarchive_label' if o.archived else 'api_archive_label'), type_name=type_name) }}">
                        <input type="hidden" name="group_key" value="{{ g.key }}">
                        <input type="hidden" name="option_id" value="{{ o.id }}">
                        <input type="hidden" name="next" value="{{ request.url }}">
                        <button class="btn small ghost" type="submit">{% if o.archived %}‚ôªÔ∏è Unarchive{% else %}üóÑÔ∏è Archive{% endif %}</button>
                      </form>
                    </div>
                    {% if o.description %}
                      <div class="opt-desc" title="{{ o.description }}">{{ o.description }}</div>
                    {% endif %}

                    {% if o.children %}
                      <details class="children">
                        <summary>{{ o.child_count }} child option{{ 's' if o.child_count != 1 else '' }}</summary>
                        <div style="margin-top:6px">
                          {% for c in o.children %}
                            <div class="option {% if c.archived %}is-archived{% endif %}" data-archived="{{ '1' if c.archived else '0' }}">
                              <div class="opt-head">
                                <div>
                                  <div class="opt-title">{{ c.display or c.id }}</div>
                                  {% if c.description %}<div class="opt-desc" title="{{ c.description }}">{{ c.description }}</div>{% endif %}
                                </div>
                                <form method="post" action="{{ url_for(( 'api_unarchive_label' if c.archived else 'api_archive_label'), type_name=type_name) }}">
                                  <input type="hidden" name="group_key" value="{{ g.key }}">
                                  <input type="hidden" name="option_id" value="{{ o.id }}">
                                  <input type="hidden" name="child_id"  value="{{ c.id }}">
                                  <input type="hidden" name="next" value="{{ request.url }}">
                                  <button class="btn small ghost" type="submit">{% if c.archived %}‚ôªÔ∏è Unarchive{% else %}üóÑÔ∏è Archive{% endif %}</button>
                                </form>
                              </div>
                            </div>
                          {% endfor %}
                        </div>
                      </details>
                    {% endif %}
                  </div>
                {% endfor %}
              </div>
            </details>
          {% else %}
            <div class="empty">No options to show.</div>
          {% endif %}
        </div>
      {% endfor %}
    </div>
  </div>

<script>
  const grid = document.getElementById('groups');
  const statusFilter = document.getElementById('statusFilter');
  let qText = '';

  function filterLabels(q){
    qText = (q||'').toLowerCase();
    applyFilters();
  }

  function applyFilters(){
    const stat = (statusFilter?.value || '').toLowerCase();
    if(!grid) return;
    grid.querySelectorAll('.group').forEach(card=>{
      const hay = (card.getAttribute('data-key') || '').toLowerCase();
      const status = (card.getAttribute('data-status') || '').toLowerCase();
      const matchText = !qText || hay.includes(qText);
      const matchStat = !stat || status === stat;
      card.style.display = (matchText && matchStat) ? '' : 'none';
    });
  }

  // Focus + apply filters on first load (so default "Active" hides archived)
  document.addEventListener('DOMContentLoaded', () => {
    const params = new URLSearchParams(location.search);
    const focus = params.get('focus');
    if (focus) {
      let el = document.getElementById('group_' + focus.replace(/\//g,'__'));
      if(!el){
        document.querySelectorAll('#groups .group').forEach(card=>{
          if(!el && (card.getAttribute('data-key')||'').includes(focus.toLowerCase())) el = card;
        });
      }
      if(el){ el.classList.add('focused'); el.scrollIntoView({behavior:'smooth', block:'center'}); }
    }
    applyFilters();
  });
</script>
</body>
</html>