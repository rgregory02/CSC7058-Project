<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Review ‚Äî {{ bio.get('name', bio_id)|replace('_',' ')|title }}</title>
  <link rel="stylesheet" href="/static/styles.css">
  <style>
    body { background:#f0f8f5; font-family:'Segoe UI', sans-serif; text-align:center; padding:60px 20px; }
    .box { background:#fff; max-width:820px; margin:auto; padding:50px 40px; border-radius:14px; box-shadow:0 6px 18px rgba(0,0,0,.1); }
    h1 { color:#2e7d32; margin-bottom:10px; font-size:2em; }
    .celebration { font-size:2.2em; margin-bottom:20px; }
    .details { font-size:1.05em; margin-bottom:26px; color:#444; }
    .details strong { color:#000; }

    .entry-block { background:#f9f9f9; border:1px solid #ccc; border-radius:10px; padding:22px; margin:0 auto 28px auto; text-align:left; max-width:680px; }
    .entry-block h3 { color:#2e7d32; margin-top:0; }

    .label-section-title { margin:24px 0 10px; color:#2e7d32; }
    .label-block { border-left:4px solid #ccc; padding-left:12px; margin-bottom:12px; }
    .label-block img { max-height:80px; margin-top:6px; border-radius:6px; }
    .label-block em { font-size:.9em; color:#555; display:block; }

    .biography-info { background:#eef5f2; border-left:4px solid #2e7d32; padding:10px 12px; margin-top:8px; font-size:.95em; color:#333; border-radius:6px; }

    .confidence-tag { font-style:italic; margin-left:8px; }
    .confidence-high { color:green; }
    .confidence-medium { color:orange; }
    .confidence-low { color:red; }

    .actions { display:flex; flex-wrap:wrap; justify-content:center; gap:14px; margin-top:6px; }
    .actions a { padding:12px 18px; border-radius:8px; text-decoration:none; font-size:1em; font-weight:700; transition:.15s; }
    .actions a.primary { background:#4CAF50; color:#fff; }
    .actions a.secondary { background:#888; color:#fff; }
    .actions a.tertiary { background:#6c63ff; color:#fff; }
    .actions a:hover { opacity:.92; transform:translateY(-2px); }
    .monosmall { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; font-size:.92em; color:#333; }
  </style>
</head>
<body>
  {% set entry_index = session.get('entry_index') if session else None %}
  {% set entries = bio.get('entries', []) %}
  {% set entry =
      (entries[entry_index] if (entry_index is not none and 0 <= entry_index < entries|length) else
       (entries[-1] if entries else {}))
  %}

  <div class="box">
    <div class="celebration">üß©</div>
    <h1>Review for {{ bio.get('name', bio_id)|replace('_',' ')|title }}</h1>

    <div class="details">
      <p><strong>Type:</strong> {{ type_name|replace('_',' ')|title }}</p>
      <p class="monosmall"><strong>ID:</strong> {{ bio_id }}</p>
      {% if entry and entry.get('created') %}
        <p><strong>Entry created:</strong> {{ entry.get('created') }}</p>
      {% endif %}
    </div>

    <div class="entry-block">
      <h3>üìÑ Snapshot of This Entry</h3>

      {# ---- Time ---- #}
      {% set t = entry.get('time', {}) %}
      {% set time_conf_class =
        'confidence-high' if (t.get('confidence', 0) >= 67)
        else 'confidence-medium' if (t.get('confidence', 0) >= 34)
        else 'confidence-low'
      %}
      <p><strong>Time:</strong>
        {% if t.get('date_value') %}
          {{ t.get('date_value') }}
        {% elif t.get('subvalue') %}
          {{ t.get('subvalue')|replace('_',' ')|title }}
        {% else %}
          Unknown
        {% endif %}
        <span class="confidence-tag {{ time_conf_class }}">(Confidence: {{ t.get('confidence', 0) }}%)</span>
      </p>

      {# ---- Labels per type in the entry ---- #}
      {% for k, v in entry.items() %}
        {% if k not in ['time','created','status'] and v %}
          <h4 class="label-section-title">{{ k|replace('_',' ')|title }}</h4>

          {% for label in v %}
            {% if label is mapping %}
              {% set conf = label.get('confidence', 0) %}
              {% set label_conf_class =
                'confidence-high' if (conf >= 67)
                else 'confidence-medium' if (conf >= 34)
                else 'confidence-low'
              %}
              {% set display_text =
                  label.get('display') or label.get('label') or label.get('id') or 'Unnamed' %}

              <div class="label-block">
                <strong>{{ label.get('label_type','Label')|replace('_',' ')|title }}</strong>
                ‚Äì {{ display_text|replace('_',' ')|title }}

                {# Linked biography snippet if present #}
                {% if label.get('biography_data') %}
                  <div class="biography-info">
                    üìñ <strong>{{ label.biography_data.get('name','Unknown') }}</strong><br>
                    {% if label.biography_data.get('description') %}
                      <em>{{ label.biography_data.get('description') }}</em>
                    {% endif %}
                  </div>
                {% endif %}

                <div class="confidence-tag {{ label_conf_class }}">Confidence: {{ conf }}%</div>

                {% if label.get('description') %}
                  <em>{{ label.get('description') }}</em>
                {% endif %}
                {% if label.get('image_url') %}
                  <img src="{{ label.get('image_url') }}" alt="{{ display_text }}">
                {% endif %}
              </div>
            {% else %}
              <pre class="monosmall" style="color:#b00;">Non-dict label encountered: {{ label|tojson }}</pre>
            {% endif %}
          {% endfor %}
        {% endif %}
      {% endfor %}
    </div>

    <div class="actions">
      <a class="primary" target="_top"
         href="{{ url_for('general_iframe_wizard', type=type_name, bio_id=bio_id, step='labels') }}">‚úèÔ∏è Edit Labels</a>
      <a class="tertiary" target="_top"
         href="{{ url_for('general_iframe_wizard', type=type_name, bio_id=bio_id, step='time') }}">‚ûï Add Another Time Period</a>
      <a class="secondary" target="_top"
         href="{{ url_for('type_browse', type_name=type_name) }}">üìö Back to {{ type_name|replace('_',' ')|title }} List</a>
    </div>
  </div>
</body>
</html>
