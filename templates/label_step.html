<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Select Labels – {{ current_type|replace('_',' ')|title }}</title>
  <link rel="stylesheet" href="/static/styles.css">
  <style>
    body { background:#f2f2f2; padding:40px; font-family:sans-serif; }
    .box { background:#fff; max-width:980px; margin:auto; padding:28px; border-radius:12px; box-shadow:0 2px 12px rgba(0,0,0,.08); }
    h1 { margin: 0 0 6px; }
    .subheading { color:#555; margin-bottom:18px; }
    .label-group-box { border:1px solid #ddd; border-radius:10px; padding:18px; margin-bottom:28px; background:#fff; }
    .label-title { font-weight:700; font-size:1.15em; color:#6f42c1; margin-bottom:10px; display:flex; align-items:center; gap:10px; }
    .group-note { font-size:.9em; color:#666; }
    .label-options { display:flex; flex-wrap:wrap; gap:14px; }
    .label-card { border:2px solid #ccc; border-radius:10px; padding:12px; cursor:pointer; min-width:160px; max-width:200px; min-height:150px; display:flex; align-items:center; justify-content:center; flex-direction:column; background:#fafafa; transition:.2s; position:relative; text-align:center; }
    .label-card:hover { transform: translateY(-2px); box-shadow:0 2px 8px rgba(0,0,0,.06); }
    .label-card.selected { border-color:#4CAF50; background:#eaffea; }
    .label-card.selected::after { content:"✓"; position:absolute; top:8px; right:10px; color:#4CAF50; font-weight:700; }
    .label-card img { max-width:100%; max-height:80px; object-fit:contain; border-radius:6px; }
    .label-description { font-size:.85em; color:#666; margin-top:6px; }
    .label-search { width:100%; padding:10px; border:1px solid #ccc; border-radius:8px; margin-bottom:12px; }
    .confidence-slider { margin-top:12px; text-align:center; }
    .confidence-display { font-size:.9em; margin-top:4px; }
    .primary-button { display:inline-block; background:#6c63ff; color:#fff; font-weight:700; padding:10px 20px; border-radius:8px; text-decoration:none; border:none; cursor:pointer; }
    .primary-button:hover { background:#5a54d6; }
    .bottom-card { margin-top:30px; padding:22px; border:1px solid #ddd; border-radius:12px; background:#f9f9f9; text-align:center; }
    .back-link { margin:0 10px; text-decoration:none; border:1px solid #007bff; padding:6px 12px; border-radius:6px; color:#007bff; background:#fff; }
    .bio-suggestions { margin-top:14px; background:#f9f9ff; border:1px dashed #ccd; border-radius:10px; padding:14px; }
    .muted { color:#666; font-size:.9em; }
.sugg-card{
  border:1px solid #e7e9f2; border-radius:8px; padding:10px; margin:8px 0; background:#fff; cursor:pointer;
}
.sugg-card.selected{ background:#eaffee; border-color:#46b36a; }

  </style>
</head>
<body>
<div class="box">
  <h1>🧩 Select {{ current_type|replace('_',' ')|title }}</h1>
  <div class="subheading">
    {% if bio_name %}<div><strong>Biography:</strong> {{ bio_name }}</div>{% endif %}
    {% if time_selection and (time_selection.label or time_selection.date_value) %}
      <div><strong>Time:</strong>
        {% if time_selection.label %}{{ time_selection.label.replace('_',' ')|title }}
        {% else %}{{ time_selection.date_value }}{% endif %}
      </div>
    {% endif %}
  </div>

  <form method="POST">
  {% for group in label_groups_list %}
    {% set safe_key     = group.key.replace('/', '__') %}
    {% set is_child     = ('/' in group.key) %}
    {% set existing     = existing_labels.get(group.key, {}) %}
    {% set selected_id  = existing.get('label') or existing.get('id') %}
    {% set matched_conf = existing.get('confidence', 100) %}

    <div class="label-group-box" id="group_{{ safe_key }}">
      <div class="label-title">
        {{ group.label or group.key.split('/')[-1]|replace('_',' ')|title }}
        {% if group.description %}<span class="muted">— {{ group.description }}</span>{% endif %}
      </div>

      {% if group.refer_to %}
        <div class="group-note">
          This field links to <strong>{{ group.refer_to.type|replace('_',' ')|title }}</strong> biographies.
          Choose an existing biography or create a new one below.
        </div>
      {% endif %}

      {% if group.options and not (group.refer_to and group.refer_to.source == 'biographies') %}
        <input
          type="text"
          class="label-search"
          placeholder="Search {{ group.label or group.key }}…"
          oninput="filterLabels(this, '{{ group.key }}')"
          data-group="{{ group.key }}">
      {% endif %}

      <!-- Hidden selected value for this group -->
      <input type="hidden"
             name="selected_id_{{ group.key }}"
             id="input_{{ safe_key }}"
             class="group-selection-tracker"
             value="{{ selected_id or '' }}">

      {% set is_cross_bio = group.refer_to and group.refer_to.source == 'biographies' %}
      {% if group.options and not is_cross_bio %}
        <div class="label-options">
          {% for item in group.options %}
            {% set is_selected = (selected_id == item.id) %}
            <div class="label-card {% if is_selected %}selected{% endif %}"
                 id="card_{{ safe_key }}_{{ item.id }}"
                 data-group="{{ group.key }}"
                 data-value="{{ item.id }}"
                 onclick="selectLabel('{{ group.key }}','{{ item.id }}', {{ 'true' if is_child else 'false' }})">
              {% if item.image %}
                <img src="{{ item.image }}" alt="{{ item.display }}">
              {% endif %}
              <div><strong>{{ item.display or item.id }}</strong></div>
              {% if item.description %}<div class="label-description">{{ item.description }}</div>{% endif %}
            </div>
          {% endfor %}
        </div>

        <div class="confidence-slider">
          <label for="confidence_{{ safe_key }}">🎯 Confidence:</label><br>
          <input type="range"
                 name="confidence_{{ group.key }}"
                 id="confidence_{{ safe_key }}"
                 min="0" max="100"
                 value="{{ matched_conf }}"
                 oninput="updateConfidence('{{ group.key }}')">
          <div class="confidence-display">
            <span id="confidence_display_{{ safe_key }}">{{ matched_conf }}%</span>
            <span id="confidence_level_{{ safe_key }}"></span>
          </div>
        </div>
      {% endif %}

      {# ---------- Linked biographies (server-rendered) ---------- #}
      {# Only render when this group is a CHILD and backend returned suggestions #}
      {% set sugg_key = group.key.replace('/', '__') %}
      {% set bio_list = suggested_biographies.get(sugg_key) %}
      {% if is_child and bio_list and bio_list|length > 0 %}
        {% set bio_input_name   = 'selected_id_' ~ group.key ~ '_bio' %}
        {% set bio_hidden_id    = 'input_' ~ sugg_key ~ '_bio' %}
        {% set bio_selected_id  = (existing_bio_selections.get(group.key ~ '_bio','') if existing_bio_selections else '') %}
        {% set bio_conf_val     = (existing_bio_selections.get(group.key ~ '_bio_conf', 100) if existing_bio_selections else 100) %}

        <div class="bio-suggestions" id="bio_suggestions_{{ sugg_key }}">
          <div class="label-title">📖 Linked Biographies</div>

          <input type="hidden"
                 name="{{ bio_input_name }}"
                 id="{{ bio_hidden_id }}"
                 class="group-selection-tracker"
                 value="{{ bio_selected_id }}">

          <input type="text"
                 class="label-search"
                 placeholder="Search biographies…"
                 oninput="filterLabels(this, '{{ sugg_key }}_bio')"
                 data-group="{{ sugg_key }}_bio">

          <div class="label-options">
            {% for option in bio_list %}
              {% set bio_selected = (option.id == bio_selected_id) %}
              <div class="label-card{% if bio_selected %} selected{% endif %}"
                   data-group="{{ sugg_key }}_bio"
                   data-value="{{ option.id }}"
                   onclick="toggleBioSelection(this, '{{ bio_hidden_id }}')">
                <div><strong>{{ option.display or option.id }}</strong></div>
                {% if option.description %}<div class="label-description">{{ option.description }}</div>{% endif %}
              </div>
            {% endfor %}
          </div>

          <div class="confidence-slider" style="margin-top:10px;">
            <label for="confidence_{{ safe_key }}_bio">🎯 Biography Match Confidence:</label><br>
            <input type="range"
                   name="confidence_{{ group.key }}_bio"
                   id="confidence_{{ safe_key }}_bio"
                   min="0" max="100"
                   value="{{ bio_conf_val }}"
                   oninput="updateConfidence('{{ group.key }}_bio')">
            <div class="confidence-display">
              <span id="confidence_display_{{ safe_key }}_bio">{{ bio_conf_val }}%</span>
              <span id="confidence_level_{{ safe_key }}_bio"></span>
            </div>
          </div>
        </div>
      {% elif (not is_child) and bio_list %}
        <div class="muted" style="margin-top:8px">
          Select a child option to see matching biographies.
        </div>
      {% endif %}

      {# ---------- AJAX injection targets (for live children + bios) ---------- #}
      <div id="children_for_{{ safe_key }}"></div>
      <div id="bios_for_{{ safe_key }}"></div>

      {% if (not group.options) and (not is_child) and (not bio_list) %}
        <div class="muted">No labels available yet for this group.</div>
      {% endif %}
    </div>
  {% endfor %}

<!-- GPT assist -->
<div class="label-group-box">
  <h3>🤖 Need help choosing labels?</h3>
  <p class="muted">
    Describe this {{ current_type.replace('_',' ') }} and we’ll suggest labels.
    You can tweak or deselect before saving.
  </p>

  <textarea id="labelPromptInput" rows="3"
            style="width:100%; padding:10px; border:1px solid #ccc; border-radius:8px;"
            placeholder="e.g. I am a nurse who loves working with children"></textarea>

  <div style="margin-top:10px; display:flex; gap:8px; align-items:center;">
    <button id="gptSuggestBtn"
        type="button"
        class="primary-button"
        onclick='suggestLabels("{{ current_type }}", {{ label_groups_list|map(attribute="key")|list|tojson }})'>
  🔍 Suggest Labels
</button>

    <span id="gptHint" class="muted" style="display:none;">Generating…</span>
  </div>

  <!-- Suggestions render here -->
  <div id="gptSuggestions" class="label-options" style="margin-top:12px;"></div>

  <!-- This is what gets POSTed back and saved -->
  <input type="hidden" name="gpt_selected_labels_json"
         id="gpt_selected_labels_json" value="[]">
</div>


  <div class="bottom-card">
    <div style="margin-bottom:12px;">
      <button type="submit" id="saveButton" class="primary-button">➡️ Move to next page with no labels selected</button>
    </div>
    <div>
      <a href="/" class="back-link">🏠 Home</a>
    </div>
  </div>
</form>

</div>

<script>
  /* ----------------------------- small helpers ----------------------------- */
  const CURRENT_TYPE = "{{ current_type }}";
  const qs  = sel => document.querySelector(sel);
  const qsa = sel => Array.from(document.querySelectorAll(sel));
  const safe = k => (k || "").replaceAll("/", "__");
  const uns  = k => (k || "").replaceAll("__", "/");
  const cssEscape = (s) => (window.CSS && CSS.escape ? CSS.escape(s) : String(s).replace(/[^a-zA-Z0-9_-]/g,'\\$&')); // FIX

  function titleCase(s){ return (s||"").replace(/_/g," ").replace(/\b\w/g,m=>m.toUpperCase()); }

  /* ----------------------- read current hidden selections ------------------ */
  function collectSelectionsMap() {
    const map = {};
    qsa("input.group-selection-tracker[id^='input_']").forEach(inp => {
      const key  = uns(inp.id.replace(/^input_/, ""));
      const val  = (inp.value || "").trim();
      if (val) map[key] = val;
    });
    return map;
  }
  function collectCurrentSelectionsList() {
    const arr = [];
    qsa(".group-selection-tracker").forEach(input => {
      const key = (input.name || "").replace(/^selected_id_/, "");
      const id  = (input.value || "").trim();
      if (!id) return;
      const confEl = qs("#confidence_" + safe(key));
      const conf = confEl ? parseInt(confEl.value || "100", 10) : 100;
      arr.push({ label_type: key.split("/").pop(), id, confidence: conf });
    });
    return arr;
  }

  /* --------------------------- confidence display -------------------------- */
  function updateConfidence(rawKey){
    const sk = safe(rawKey);
    const slider  = qs("#confidence_" + sk);
    const display = qs("#confidence_display_" + sk);
    const level   = qs("#confidence_level_" + sk);
    if(!slider || !display || !level) return;
    const v = parseInt(slider.value || 0, 10);
    display.textContent = v + "%";
    if(v===100){ level.textContent='(Exact)'; level.style.color='green'; }
    else if(v>=67){ level.textContent='(High)'; level.style.color='green'; }
    else if(v>=34){ level.textContent='(Medium)'; level.style.color='orange'; }
    else { level.textContent='(Low)'; level.style.color='red'; }
  }
  function initConfidenceFor(key){
    updateConfidence(key);
    const sk = safe(key);
    const el = qs("#confidence_" + sk);
    if (el) el.addEventListener("input", () => updateConfidence(key));
  }

  /* ------------------------------ bios widget ------------------------------ */
  function renderBios(groupKey, bios) {
    const host = qs("#bios_for_" + safe(groupKey));
    if (!host) return;
    if (!bios || !bios.length) { host.innerHTML = ""; return; }

    const cards = bios.map(b => `
      <div class="label-card"
           tabindex="0"
           data-group="${safe(groupKey)}_bio"
           data-value="${b.id}"
           onclick="toggleBioSelection(this, 'input_${safe(groupKey)}_bio')"
           onkeydown="if(event.key==='Enter'||event.key===' '){event.preventDefault(); this.click();}">
        <div><strong>${b.display || b.id}</strong></div>
        ${b.description ? `<div class="label-description">${b.description}</div>` : ""}
      </div>
    `).join("");

    host.innerHTML = `
      <div class="bio-suggestions">
        <div class="label-title">📖 Linked Biographies</div>
        <input type="hidden"
               id="input_${safe(groupKey)}_bio"
               name="selected_id_${groupKey}_bio"
               class="group-selection-tracker"
               value="">
        <input type="text" class="label-search"
               placeholder="Search biographies…"
               oninput="filterLabels(this, '${safe(groupKey)}_bio')"
               data-group="${safe(groupKey)}_bio">
        <div class="label-options">${cards}</div>
        <div class="confidence-slider" style="margin-top:10px;">
          <label for="confidence_${safe(groupKey)}_bio">🎯 Biography Match Confidence:</label><br>
          <input type="range"
                 name="confidence_${groupKey}_bio"
                 id="confidence_${safe(groupKey)}_bio"
                 min="0" max="100" value="100">
          <div class="confidence-display">
            <span id="confidence_display_${safe(groupKey)}_bio">100%</span>
            <span id="confidence_level_${safe(groupKey)}_bio"></span>
          </div>
        </div>
      </div>
    `;
    initConfidenceFor(groupKey + "_bio");
    updateSaveButtonState();
  }

  /* ---------------------------- child group render ------------------------- */
  function renderChildGroup(parentKey, childKey, options) {
    const host = qs("#children_for_" + safe(parentKey));
    if (!host) return;

    const cards = options.map(opt => `
      <div class="label-card"
           id="card_${safe(childKey)}_${opt.id}"
           data-group="${childKey}"
           data-value="${opt.id}"
           tabindex="0"
           onclick="selectChild('${childKey}','${opt.id}')"
           onkeydown="if(event.key==='Enter'||event.key===' '){event.preventDefault(); this.click();}">
        ${ (opt.image || opt.image_url) ? `<img src="${opt.image || opt.image_url}" alt="${opt.display}">` : "" } <!-- FIX -->
        <div><strong>${opt.display || opt.id}</strong></div>
        ${opt.description ? `<div class="label-description">${opt.description}</div>` : ""}
      </div>
    `).join("");

    host.innerHTML = `
      <div class="label-group-box" id="group_${safe(childKey)}">
        <div class="label-title">${titleCase(childKey.split('/').slice(-1)[0])}</div>
        <input type="hidden"
               name="selected_id_${childKey}"
               id="input_${safe(childKey)}"
               class="group-selection-tracker"
               value="">
        <div class="label-options">${cards}</div>
        <div class="confidence-slider">
          <label for="confidence_${safe(childKey)}">🎯 Confidence:</label><br>
          <input type="range"
                 name="confidence_${childKey}"
                 id="confidence_${safe(childKey)}"
                 min="0" max="100" value="100">
          <div class="confidence-display">
            <span id="confidence_display_${safe(childKey)}">100%</span>
            <span id="confidence_level_${safe(childKey)}"></span>
          </div>
        </div>
        <div id="bios_for_${safe(childKey)}"></div>
      </div>
    `;
    initConfidenceFor(childKey);
    updateSaveButtonState();
  }

  /* ---------------------------- parent/child clicks ------------------------ */
  function selectLabel(groupKey, labelId, isChild){
    qsa(`.label-card[data-group="${groupKey}"]`).forEach(c => c.classList.remove("selected"));
    const card = qs(`#card_${safe(groupKey)}_${cssEscape(labelId)}`); // FIX
    if (card) card.classList.add("selected");

    const hid = qs("#input_" + safe(groupKey));
    if (hid) hid.value = labelId;

    updateSaveButtonState();

    if (isChild) { fetchBiosFor(groupKey); return; }

    fetch("/api/labels/children", {
      method: "POST",
      headers: {"Content-Type": "application/json"},
      body: JSON.stringify({ type_name: CURRENT_TYPE, group_key: groupKey, selected_id: labelId })
    })
    .then(r => r.ok ? r.json() : Promise.reject())
    .then(json => {
      if (!json || !json.ok) return;
      if (json.child_key && Array.isArray(json.options) && json.options.length) {
        renderChildGroup(groupKey, json.child_key, json.options);
        setTimeout(() => {
          const el = qs("#group_" + safe(json.child_key));
          if (el) el.scrollIntoView({behavior: "smooth", block: "start"});
        }, 30);
      } else {
        const cHost = qs("#children_for_" + safe(groupKey));
        if (cHost) cHost.innerHTML = "";
        const bHost = qs("#bios_for_" + safe(groupKey));
        if (bHost) bHost.innerHTML = "";
      }
    })
    .catch(()=>{});
  }

  function selectChild(groupKey, labelId){
    qsa(`.label-card[data-group="${groupKey}"]`).forEach(c => c.classList.remove("selected"));
    const card = qs(`#card_${safe(groupKey)}_${cssEscape(labelId)}`); // FIX
    if (card) card.classList.add("selected");

    const hid = qs("#input_" + safe(groupKey));
    if (hid) hid.value = labelId;

    updateSaveButtonState();
    fetchBiosFor(groupKey);
  }

  function fetchBiosFor(groupKey){
    fetch("/api/labels/suggest_biographies", {
      method: "POST",
      headers: {"Content-Type": "application/json"},
      body: JSON.stringify({ type_name: CURRENT_TYPE, group_key: groupKey, selections: collectSelectionsMap() })
    })
    .then(r => r.ok ? r.json() : Promise.reject())
    .then(json => { if (json && json.ok) renderBios(groupKey, json.bios || []); })
    .catch(()=>{});
  }

  /* ------------------------ search & bio tile interactions ----------------- */
  function filterLabels(input, groupKey){
    const q = (input.value||"").toLowerCase();
    let shown = 0;
    qsa(`.label-card[data-group="${groupKey}"]`).forEach(card=>{
      const t = card.innerText.toLowerCase();
      const match = t.includes(q);
      if (match && shown < 12){ card.style.display='flex'; shown++; }
      else { card.style.display='none'; }
    });
  }

  function toggleBioSelection(card, hiddenId){
    const hidden = qs("#" + hiddenId);
    if(!hidden) return;
    const val   = card.getAttribute("data-value");
    const group = card.getAttribute("data-group");
    const cards = qsa(`.label-card[data-group="${group}"]`);

    if(hidden.value === val){
      hidden.value = "";
      card.classList.remove("selected");
    } else {
      cards.forEach(c=>c.classList.remove("selected"));
      hidden.value = val;
      card.classList.add("selected");
    }
    updateSaveButtonState();
  }

  /* ------------------------------ save button UX --------------------------- */
  function updateSaveButtonState(){
    const trackers = document.querySelectorAll('.group-selection-tracker');
    const gptEl = document.getElementById('gpt_selected_labels_json');
    const btn = document.getElementById('saveButton');

    const hasManual = Array.from(trackers).some(i => (i.value||'').trim() !== '');
    let hasGPT = false;
    try {
      const arr = JSON.parse(gptEl?.value || '[]');
      hasGPT = Array.isArray(arr) && arr.length > 0;
    } catch(_) {}

    if(!btn) return;
    if(hasManual || hasGPT){
      btn.textContent = '✅ Save All Selections';
      btn.style.backgroundColor = '#4CAF50';
    }else{
      btn.textContent = '➡️ Move to next page with no labels selected';
      btn.style.backgroundColor = '#6c63ff';
    }
  }

  /* ---------------------------- GPT suggestions UI ------------------------- */
  function renderGptSuggestions(items) {
    const wrap = document.getElementById('gptSuggestions');
    if (!wrap) return;

    wrap.innerHTML = '';
    const chosen = new Map();

    function syncHidden() {
      const arr = Array.from(chosen.values());
      document.getElementById('gpt_selected_labels_json').value = JSON.stringify(arr);
      updateSaveButtonState?.();
    }

    (items || []).forEach(s => {
      const sug = {
        id: s.id,
        label_type: s.label_type || s.group_key || s.type || '',
        confidence: Number.isFinite(s.confidence) ? s.confidence : 100,
        display: s.display || s.id,
        description: s.description || ''
      };

      const card = document.createElement('div');
      card.className = 'sugg-card';
      card.setAttribute('role', 'button');
      card.innerHTML = `
        <div><strong>${sug.display}</strong></div>
        ${sug.description ? `<div class="label-description">${sug.description}</div>` : ''}
      `;

      card.onclick = async () => {
        const key = `${sug.label_type||''}::${sug.id}`;
        const wasSelected = chosen.has(key);
        if (wasSelected) {
          chosen.delete(key);
          card.classList.remove('selected');
        } else {
          chosen.set(key, sug);
          card.classList.add('selected');
          await applySuggestionToGroups(sug); // try to click the real option
        }
        syncHidden();
      };

      wrap.appendChild(card);
    });

    document.getElementById('gpt_selected_labels_json').value = '[]';
    updateSaveButtonState?.();
  }

  async function suggestLabels(currentType, groupPrefixes = []) {
    const btn  = qs("#gptSuggestBtn");
    const hint = qs("#gptHint");
    const promptEl = qs("#labelPromptInput");
    const prompt = (promptEl?.value || "").trim();

    if (!prompt) { alert("Tell me a bit about this " + currentType.replaceAll("_"," ") + " first."); return; }

    try {
      if (btn) btn.disabled = true;
      if (hint) hint.style.display = "inline";

      const res = await fetch("/api/suggest_labels", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          type: currentType,
          prompt,
          context: { selections: collectCurrentSelectionsList() },
          group_prefixes: groupPrefixes
        })
      });
      if (!res.ok) throw new Error(await res.text());
      const data = await res.json();
      renderGptSuggestions(Array.isArray(data.labels) ? data.labels : []);
    } catch(e){
      console.error(e);
      alert("Sorry — could not get suggestions.");
    } finally {
      if (btn) btn.disabled = false;
      if (hint) hint.style.display = "none";
    }
  }
  window.suggestLabels = suggestLabels;

  /* ------------------------- apply suggestion to UI ------------------------ */
  async function applySuggestionToGroups(sug) {
    if (!sug || !sug.id) return false;

    // 1) Try any visible card first
    let direct = document.querySelector(`.label-card[data-value="${cssEscape(sug.id)}"]`);
    if (direct) { direct.click(); return true; }

    // 2) Ask the server where this id lives (works cross-type + nested)
    const res = await fetch('/api/labels/resolve_option', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({ type_name: CURRENT_TYPE, option_id: sug.id }) // FIX
    });
    if (!res.ok) return false;
    const data = await res.json();
    if (!data.ok) return false;

    // If parent must be expanded first
    if (data.parent_id) {
      const rawGroup = data.group_key.split('/').slice(0, -1).join('/') || data.group_key;
      const parentCard = document.querySelector(`#card_${safe(rawGroup)}_${cssEscape(data.parent_id)}`); // FIX
      if (parentCard) parentCard.click();

      const targetKey  = data.child_key || data.group_key;
      const targetSafe = safe(targetKey);
      const targetId   = data.child_id || sug.id;

      let tries = 0;
      const t = setInterval(() => {
        const c = document.querySelector(`#card_${targetSafe}_${cssEscape(targetId)}`);
        if (c) { c.click(); clearInterval(t); }
        if (++tries > 20) clearInterval(t);
      }, 100);
      return true;
    }

    // Direct group match
    if (data.group_key) {
      const card = document.querySelector(`#card_${safe(data.group_key)}_${cssEscape(sug.id)}`); // FIX
      if (card) { card.click(); return true; }
    }
    return false;
  }

  /* ------------------------------- bootstrapping --------------------------- */
  document.addEventListener("DOMContentLoaded", () => {
    qsa("[id^='confidence_']").forEach(el=>{
      const id = el.id.replace("confidence_","");
      updateConfidence(uns(id));
    });
    updateSaveButtonState();

    qsa(".label-card[data-group]").forEach(el=>{
      el.setAttribute("tabindex","0");
      if(!el.getAttribute("onkeydown")){
        el.addEventListener("keydown", e=>{
          if(e.key==="Enter"||e.key===" "){ e.preventDefault(); el.click(); }
        });
      }
    });
  });
</script>

</body>


</html>
