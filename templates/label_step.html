<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Select Labels ‚Äì {{ current_type|replace('_',' ')|title }}</title>
  <link rel="stylesheet" href="/static/styles.css">
  <style>
    body { background:#f2f2f2; padding:40px; font-family:sans-serif; }
    .box { background:#fff; max-width:980px; margin:auto; padding:28px; border-radius:12px; box-shadow:0 2px 12px rgba(0,0,0,.08); }
    h1 { margin: 0 0 6px; }
    .subheading { color:#555; margin-bottom:18px; }
    .label-group-box { border:1px solid #ddd; border-radius:10px; padding:18px; margin-bottom:28px; background:#fff; }
    .label-title { font-weight:700; font-size:1.15em; color:#6f42c1; margin-bottom:10px; display:flex; align-items:center; gap:10px; }
    .group-note { font-size:.9em; color:#666; }
    .label-options { display:flex; flex-wrap:wrap; gap:14px; }
    .label-card { border:2px solid #ccc; border-radius:10px; padding:12px; cursor:pointer; min-width:160px; max-width:200px; min-height:150px; display:flex; align-items:center; justify-content:center; flex-direction:column; background:#fafafa; transition:.2s; position:relative; text-align:center; }
    .label-card:hover { transform: translateY(-2px); box-shadow:0 2px 8px rgba(0,0,0,.06); }
    .label-card.selected { border-color:#4CAF50; background:#eaffea; }
    .label-card.selected::after { content:"‚úì"; position:absolute; top:8px; right:10px; color:#4CAF50; font-weight:700; }
    .label-card img { max-width:100%; max-height:80px; object-fit:contain; border-radius:6px; }
    .label-description { font-size:.85em; color:#666; margin-top:6px; }
    .label-search { width:100%; padding:10px; border:1px solid #ccc; border-radius:8px; margin-bottom:12px; }
    .confidence-slider { margin-top:12px; text-align:center; }
    .confidence-display { font-size:.9em; margin-top:4px; }
    .primary-button { display:inline-block; background:#6c63ff; color:#fff; font-weight:700; padding:10px 20px; border-radius:8px; text-decoration:none; border:none; cursor:pointer; }
    .primary-button:hover { background:#5a54d6; }
    .bottom-card { margin-top:30px; padding:22px; border:1px solid #ddd; border-radius:12px; background:#f9f9f9; text-align:center; }
    .back-link { margin:0 10px; text-decoration:none; border:1px solid #007bff; padding:6px 12px; border-radius:6px; color:#007bff; background:#fff; }
    .bio-suggestions { margin-top:14px; background:#f9f9ff; border:1px dashed #ccd; border-radius:10px; padding:14px; }
    .muted { color:#666; font-size:.9em; }
    .sugg-card{ border:1px solid #e7e9f2; border-radius:8px; padding:10px; margin:8px 0; background:#fff; cursor:pointer; }
    .sugg-card.selected{ background:#eaffee; border-color:#46b36a; }
    .clear-btn { background:#fff; border:1px solid #bbb; color:#444; padding:4px 10px; border-radius:6px; cursor:pointer; font-size:.85em; margin-left:auto; }
    .clear-btn:hover { background:#f6f6f6; }
        body[data-embed="1"] .wizard-chrome {
      display: none !important;  /* Hide tabs/header in embed */
    }
    body[data-embed="1"] .wizard-body {
      margin-top: 0; /* Tighten spacing when header is hidden */
    }
  </style>
</head>
{% set EMBED = request.args.get('embed') in ('1','true','True') %}
{% if EMBED %}<base target="_top">{% endif %}
<body data-embed="{{ '1' if EMBED else '0' }}">
  <div class="wizard-chrome">{# tabs/title #}</div>
  <div class="wizard-body">‚Ä¶</div>
<div class="box">
  <h1>üß© Select {{ current_type|replace('_',' ')|title }}</h1>
  <div class="subheading">
    {% if bio_name %}<div><strong>Biography:</strong> {{ bio_name }}</div>{% endif %}
    {% if time_selection and (time_selection.label or time_selection.date_value) %}
      <div><strong>Time:</strong>
        {% if time_selection.label %}{{ time_selection.label.replace('_',' ')|title }}
        {% else %}{{ time_selection.date_value|uk_date }}{% endif %}
      </div>
    {% endif %}
  </div>

  <form method="POST">
    {% for group in label_groups_list %}
      {% set safe_key     = group.key.replace('/', '__') %}
      {% set is_child     = ('/' in group.key) %}
      {% set existing     = existing_labels.get(group.key, {}) %}
      {% set selected_id  = existing.get('label') or existing.get('id') %}
      {% set matched_conf = existing.get('confidence', 100) %}

      <div class="label-group-box" id="group_{{ safe_key }}">
        <div class="label-title">
          {{ group.label or group.key.split('/')[-1]|replace('_',' ')|title }}
          {% if group.description %}<span class="muted">‚Äî {{ group.description }}</span>{% endif %}
          <button type="button" class="clear-btn" onclick="clearGroupUI('{{ group.key }}')">Clear</button>
        </div>

        {% if group.refer_to %}
          <div class="group-note">
            This field links to <strong>{{ group.refer_to.type|replace('_',' ')|title }}</strong> biographies.
            Choose an existing biography or create a new one below.
          </div>
        {% endif %}

        {% if group.options %}
          <input
            type="text"
            class="label-search"
            placeholder="Search {{ group.label or group.key }}‚Ä¶"
            oninput="filterLabels(this, '{{ group.key }}')"
            data-group="{{ group.key }}">
        {% endif %}

        {% if not group.input %}
          <!-- Hidden selected value (only for option-based groups) -->
          <input type="hidden"
                 name="selected_id_{{ group.key }}"
                 id="input_{{ safe_key }}"
                 class="group-selection-tracker"
                 value="{{ selected_id or '' }}">
        {% endif %}

{% if group.input %}
  {# ---------- Free text / date / number / textarea / select ---------- #}
  {% set field = group.input %}
  {% set field_name = field.name or 'value' %}
  {% set existing_val = existing.get(field_name) or existing.get('id') or '' %}

  <div class="field" style="margin-top:10px">
    <label for="fld_{{ safe_key }}" class="muted">{{ field.label or group.label }}</label>
    {% if field.kind in ['text','email','tel','date','month','datetime-local','number'] %}
      <input id="fld_{{ safe_key }}"
             type="{{ field.kind }}"
             name="input_{{ group.key }}"
             placeholder="{{ field.placeholder or '' }}"
             value="{{ existing_val }}"
             {% if group.required %}required{% endif %}>
    {% elif field.kind == 'textarea' %}
      <textarea id="fld_{{ safe_key }}"
                name="input_{{ group.key }}"
                placeholder="{{ field.placeholder or '' }}"
                {% if group.required %}required{% endif %}>{{ existing_val }}</textarea>
    {% elif field.kind == 'select' %}
      <select id="fld_{{ safe_key }}" name="input_{{ group.key }}" {% if group.required %}required{% endif %}>
        {% if field.placeholder %}<option value="">{{ field.placeholder }}</option>{% endif %}
        {% for opt in field.options or [] %}
          <option value="{{ opt.id }}"{% if existing_val == opt.id %} selected="selected"{% endif %}>
            {{ opt.display or opt.id }}
          </option>
        {% endfor %}
      </select>
    {% endif %}
    {% if field.help %}<div class="muted" style="margin-top:6px">{{ field.help }}</div>{% endif %}
  </div>

  {# Optional: confidence for input fields too (uses same name pattern) #}
  <div class="confidence-slider">
    <label class="muted">Confidence:</label><br>
    <input type="range"
           name="confidence_{{ group.key }}"
           id="confidence_{{ safe_key }}"
           min="0" max="100"
           value="{{ matched_conf }}"
           oninput="updateConfidence('{{ group.key }}')">
    <div class="confidence-display">
      <span id="confidence_display_{{ safe_key }}">{{ matched_conf }}%</span>
      <span id="confidence_level_{{ safe_key }}"></span>
    </div>
  </div>

{% else %}
{% if group.options %}
  <div class="label-options">
    {% for item in group.options %}
      {% set is_selected = (selected_id == item.id) %}
      {% set img = item.image or item.image_url %}
      <div class="label-card {% if is_selected %}selected{% endif %}"
           id="card_{{ safe_key }}_{{ item.id }}"
           data-group="{{ group.key }}"
           data-value="{{ item.id }}"
           tabindex="0"
           onclick="selectLabel('{{ group.key }}','{{ item.id }}', false)"
           onkeydown="if(event.key==='Enter'||event.key===' '){event.preventDefault(); selectLabel('{{ group.key }}','{{ item.id }}', false);}">
        {% if img %}
          <img src="{{ img }}" alt="{{ item.display or item.id }}">
        {% endif %}
        <div><strong>{{ item.display or item.id }}</strong></div>
        {% if item.description %}<div class="label-description">{{ item.description }}</div>{% endif %}
      </div>
    {% endfor %}
  </div>

  <div class="confidence-slider">
    <label for="confidence_{{ safe_key }}">üéØ Confidence:</label><br>
    <input type="range"
           name="confidence_{{ group.key }}"
           id="confidence_{{ safe_key }}"
           min="0" max="100"
           value="{{ matched_conf }}"
           oninput="updateConfidence('{{ group.key }}')">
    <div class="confidence-display">
      <span id="confidence_display_{{ safe_key }}">{{ matched_conf }}%</span>
      <span id="confidence_level_{{ safe_key }}"></span>
    </div>
  </div>
{% endif %}
{% endif %}

        {# ---------- Linked biographies (server-rendered) ---------- #}
{# ---------- Linked biographies (now for top-level AND child groups) ---------- #}
{% set is_bio_link = (group.refer_to and group.refer_to.source == 'biographies') or group.link_biography %}
<div id="children_for_{{ safe_key }}"></div>

<div id="bios_for_{{ safe_key }}">
{% if is_bio_link %}
  {% set sugg_key = group.key.replace('/', '__') %}
  {% set _rtype_from_refer = (group.refer_to.type if (group.refer_to and group.refer_to.type) else None) %}
  {% set _rtype_from_link  = (group.link_biography.type if (group.link_biography and group.link_biography.type) else None) %}
  {% set rtype = _rtype_from_refer or _rtype_from_link or current_type %}

  {% set bio_list = (suggested_biographies.get(sugg_key) or []) %}
  {% set fallback = ((linkable_bios.get(rtype) if linkable_bios else None) or []) %}
  {% set listing = (bio_list if (bio_list|length > 0) else fallback) %}

  {% set bio_input_name   = 'selected_id_' ~ group.key ~ '_bio' %}
  {% set bio_hidden_id    = 'input_' ~ sugg_key ~ '_bio' %}
  {% set bio_selected_id  = (existing_bio_selections.get(group.key ~ '_bio','') if existing_bio_selections else '') %}
  {% set bio_conf_val     = (existing_bio_selections.get(group.key ~ '_bio_conf', 100) if existing_bio_selections else 100) %}

  <div class="bio-suggestions">
    <div class="label-title" style="justify-content:space-between;gap:8px">
  <span>üìñ Linked Biographies ({{ rtype|replace('_',' ')|title }})</span>
  {% set _auto = (group.refer_to.auto_link if group.refer_to else (group.link_biography.auto_link if group.link_biography else False)) %}
  <label class="muted" style="font-weight:400;display:flex;align-items:center;gap:6px">
    <input type="checkbox"
           class="auto-link-toggle"
           data-group="{{ sugg_key }}"
           {% if _auto %}checked{% endif %}>
    Auto‚Äëlink exact match
  </label>
</div>
<script>
  AUTO_LINK["{{ group.key }}"] = {{ 'true' if _auto else 'false' | tojson }};
</script>

    <input type="hidden" name="{{ bio_input_name }}" id="{{ bio_hidden_id }}"
           class="group-selection-tracker" value="{{ bio_selected_id }}">

    <input type="text" class="label-search" placeholder="Search biographies‚Ä¶"
           oninput="filterLabels(this, '{{ sugg_key }}_bio')" data-group="{{ sugg_key }}_bio">

    <div class="label-options">
      {% for option in (listing or []) %}
        {% set bio_selected = (option.id == bio_selected_id) %}
        <div class="label-card{% if bio_selected %} selected{% endif %}"
             data-group="{{ sugg_key }}_bio"
             data-value="{{ option.id }}"
             tabindex="0"
             onclick="toggleBioSelection(this, '{{ bio_hidden_id }}')"
             onkeydown="if(event.key==='Enter'||event.key===' '){event.preventDefault(); this.click();}">
          <div><strong>{{ option.display or option.id }}</strong></div>
          {% if option.description %}<div class="label-description">{{ option.description }}</div>{% endif %}
        </div>
      {% endfor %}
      {% if listing|length == 0 %}
        <div class="muted">No biographies to show for {{ rtype|replace('_',' ')|title }}.</div>
      {% endif %}
    </div>

    <div class="confidence-slider" style="margin-top:10px;">
      <label for="confidence_{{ safe_key }}_bio">üéØ Biography Match Confidence:</label><br>
      <input type="range" name="confidence_{{ group.key }}_bio" id="confidence_{{ safe_key }}_bio"
             min="0" max="100" value="{{ bio_conf_val }}"
             oninput="updateConfidence('{{ group.key }}_bio')">
      <div class="confidence-display">
        <span id="confidence_display_{{ safe_key }}_bio">{{ bio_conf_val }}%</span>
        <span id="confidence_level_{{ safe_key }}_bio"></span>
      </div>
    </div>
  </div>
{% endif %}
</div>

{% if (not group.options) and (not is_child) and (not group.input) and (not is_bio_link) %}
  <div class="muted">No labels available yet for this group.</div>
{% endif %}
      </div>
    {% endfor %}

    <div class="label-group-box" style="border-style:dashed">
      <h3>üõ†Ô∏è Add Labels Inline</h3>
      <p class="muted">
        Writes to <code>types/{{ current_type }}/labels/...</code> and appears immediately after a short reload.
      </p>

      <details style="margin:8px 0" open>
        <summary><strong>‚ûï New Property (group)</strong></summary>
        <div style="margin-top:10px; display:grid; gap:8px;">
          <div style="display:grid; gap:8px; grid-template-columns:1fr 1fr;">
            <div>
              <label class="muted">From template</label>
              <select id="tmpl_group_key" style="width:100%"></select>
            </div>
            <div>
              <label class="muted">‚Ä¶or custom key</label>
              <input id="new_group_key" placeholder="key (e.g. hair_color)" />
            </div>
          </div>
          <div style="display:grid; gap:8px; grid-template-columns:1fr 1fr;">
            <input id="new_group_label" placeholder="Label (e.g. Hair color)">
            <input id="new_group_desc" placeholder="Description">
          </div>

          <div style="display:grid; gap:8px; grid-template-columns:1fr 1fr 1fr;">
            <div>
              <label class="muted">Source</label>
              <select id="new_group_source" style="width:100%">
                <option value="options" selected>Options in folder</option>
                <option value="biographies">Link to biographies</option>
              </select>
            </div>
            <div>
              <label class="muted">Biography type</label>
              <select id="new_group_refer_type" style="width:100%" disabled></select>
              <small class="muted">‚ÄúSelf‚Äù will select {{ current_type }}</small>
            </div>
            <div>
              <label class="muted">Order</label>
              <input id="new_group_order" type="number" value="999" placeholder="Order">
            </div>
          </div>

          <div style="display:flex; gap:10px; align-items:center;">
            <button type="button" class="primary-button" onclick="adminCreateGroupSmart()">Create Group</button>
            <button type="button" onclick="adminUseSelfType()" class="clear-btn">Use self type</button>
          </div>
          <div id="adminStatus_group" class="muted"></div>
        </div>
      </details>

      <details style="margin:8px 0">
        <summary><strong>‚ûï New Option in Existing Group</strong></summary>
        <div style="margin-top:10px; display:grid; gap:8px;">
          <div>
            <label class="muted">Group</label>
            <select id="opt_group_key" style="width:100%"></select>
          </div>
          <div style="display:grid; gap:8px; grid-template-columns:1fr 1fr;">
            <input id="opt_id" placeholder="option id (e.g. brown_hair)">
            <input id="opt_display" placeholder="Display (Brown hair)">
          </div>
          <input id="opt_desc" placeholder="Description">
          <div style="display:grid; gap:8px; grid-template-columns:1fr 1fr;">
            <input id="opt_image" placeholder="Image URL (optional)">
            <input id="opt_order" type="number" value="999" placeholder="Order">
          </div>
          <button type="button" class="primary-button" onclick="adminCreateOption()">Create Option</button>
          <div id="adminStatus_option" class="muted"></div>
        </div>
      </details>

      <details style="margin:8px 0">
        <summary><strong>ü™ú New Child Group under Parent</strong></summary>
        <div style="margin-top:10px; display:grid; gap:8px;">
          <div style="display:grid; gap:8px; grid-template-columns:1fr 1fr;">
            <div>
              <label class="muted">Parent (top-level)</label>
              <select id="child_parent_key" style="width:100%"></select>
            </div>
            <div>
              <label class="muted">Child key</label>
              <input id="child_key" placeholder="child key (e.g. hospital)">
            </div>
          </div>
          <div style="display:grid; gap:8px; grid-template-columns:1fr 1fr;">
            <input id="child_label" placeholder="Child Label">
            <input id="child_desc" placeholder="Description">
          </div>

          <div style="display:grid; gap:8px; grid-template-columns:1fr 1fr 1fr;">
            <div>
              <label class="muted">Source</label>
              <select id="child_source" style="width:100%">
                <option value="options" selected>Options in folder</option>
                <option value="biographies">Link to biographies</option>
              </select>
            </div>
            <div>
              <label class="muted">Biography type</label>
              <select id="child_refer_type" style="width:100%" disabled></select>
            </div>
            <div>
              <label class="muted">Order</label>
              <input id="child_order" type="number" value="999" placeholder="Order">
            </div>
          </div>

          <div style="display:flex; gap:10px; align-items:center;">
            <button type="button" class="primary-button" onclick="adminCreateChildSmart()">Create Child Group</button>
            <button type="button" onclick="adminUseSelfTypeChild()" class="clear-btn">Use self type</button>
          </div>
          <div id="adminStatus_child" class="muted"></div>
        </div>
      </details>
    </div>

    <!-- GPT assist -->
    <div class="label-group-box">
      <h3>ü§ñ Need help choosing labels?</h3>
      <p class="muted">
        Describe this {{ current_type.replace('_',' ') }} and we‚Äôll suggest labels.
        You can tweak or deselect before saving.
      </p>

      <textarea id="labelPromptInput" rows="3"
                style="width:100%; padding:10px; border:1px solid #ccc; border-radius:8px;"
                placeholder="e.g. I am a nurse who loves working with children"></textarea>

      <div style="margin-top:10px; display:flex; gap:8px; align-items:center;">
        <button id="gptSuggestBtn"
            type="button"
            class="primary-button"
            onclick='suggestLabels("{{ current_type }}", {{ label_groups_list|map(attribute="key")|list|tojson }})'>
          üîç Suggest Labels
        </button>
        <span id="gptHint" class="muted" style="display:none;">Generating‚Ä¶</span>
      </div>

      <div id="gptSuggestions" class="label-options" style="margin-top:12px;"></div>
      <input type="hidden" name="gpt_selected_labels_json" id="gpt_selected_labels_json" value="[]">
    </div>

    <div class="bottom-card">
      <div style="margin-bottom:12px;">
        <button type="submit" id="saveButton" class="primary-button">‚û°Ô∏è Move to next page with no labels selected</button>
      </div>
      <div>
        <a href="/" class="back-link">üè† Home</a>
      </div>
    </div>
  </form>
</div>

<script>
  const AUTO_LINK = Object.create(null);
  const CURRENT_TYPE = "{{ current_type }}";
  const qs  = sel => document.querySelector(sel);
  const qsa = sel => Array.from(document.querySelectorAll(sel));
  const safe = k => (k || "").replaceAll("/", "__");
  const uns  = k => (k || "").replaceAll("__", "/");
  const cssEscape = (s) => (window.CSS && CSS.escape ? CSS.escape(s) : String(s).replace(/[^a-zA-Z0-9_-]/g,'\\$&'));
  function titleCase(s){ return (s||"").replace(/_/g," ").replace(/\b\w/g,m=>m.toUpperCase()); }

  function updateConfidence(rawKey){
    const sk = safe(rawKey);
    const slider  = qs("#confidence_" + sk);
    const display = qs("#confidence_display_" + sk);
    const level   = qs("#confidence_level_" + sk);
    if(!slider || !display || !level) return;
    const v = parseInt(slider.value || 0, 10);
    display.textContent = v + "%";
    if(v===100){ level.textContent='(Exact)'; level.style.color='green'; }
    else if(v>=67){ level.textContent='(High)'; level.style.color='green'; }
    else if(v>=34){ level.textContent='(Medium)'; level.style.color='orange'; }
    else { level.textContent='(Low)'; level.style.color='red'; }
  }
  function initConfidenceFor(key){
    updateConfidence(key);
    const sk = safe(key);
    const el = qs("#confidence_" + sk);
    if (el) el.addEventListener("input", () => updateConfidence(key));
  }

  let BOOT = { types: [], groups: [], top_level_groups: [], property_templates: [] };

  async function loadAdminBootstrap(){
    try{
      const res = await fetch(`/api/labels/admin/bootstrap?type={{ current_type }}`);
      const data = await res.json();
      if(!data.ok) throw new Error(data.error || 'bootstrap failed');
      BOOT = data;

      const tmplSel = document.getElementById('tmpl_group_key');
      tmplSel.innerHTML = `<option value="">(choose a template)</option>` +
        (data.property_templates || []).map(k => `<option value="${k}">${k}</option>`).join('');

      const optGroupSel = document.getElementById('opt_group_key');
      optGroupSel.innerHTML = (data.groups || []).map(k => `<option value="${k}">${k}</option>`).join('');

      const parentSel = document.getElementById('child_parent_key');
      parentSel.innerHTML = (data.top_level_groups || []).map(k => `<option value="${k}">${k}</option>`).join('');

      const referTypeSel = document.getElementById('new_group_refer_type');
      referTypeSel.innerHTML = data.types.map(t => `<option value="${t}">${t}</option>`).join('');
      const referTypeChildSel = document.getElementById('child_refer_type');
      referTypeChildSel.innerHTML = data.types.map(t => `<option value="${t}">${t}</option>`).join('');
    }catch(e){
      console.error(e);
    }
  }

  function wireSourceToggles(){
    const srcSel = document.getElementById('new_group_source');
    const rSel  = document.getElementById('new_group_refer_type');
    const srcChildSel = document.getElementById('child_source');
    const rChildSel   = document.getElementById('child_refer_type');

    function refresh() {
      rSel.disabled = (srcSel.value !== 'biographies');
      rChildSel.disabled = (srcChildSel.value !== 'biographies');
    }
    srcSel.addEventListener('change', refresh);
    srcChildSel.addEventListener('change', refresh);
    refresh();
  }

  function adminUseSelfType(){
    const rSel  = document.getElementById('new_group_refer_type');
    const srcSel = document.getElementById('new_group_source');
    srcSel.value = 'biographies';
    rSel.disabled = false;
    rSel.value = "{{ current_type }}";
  }
  function adminUseSelfTypeChild(){
    const rSel  = document.getElementById('child_refer_type');
    const srcSel = document.getElementById('child_source');
    srcSel.value = 'biographies';
    rSel.disabled = false;
    rSel.value = "{{ current_type }}";
  }

  function _msgAt(id, s, ok=true){
    const el = document.getElementById(id);
    if(!el) return;
    el.textContent = s;
    el.style.color = ok ? "green" : "crimson";
  }

  async function adminCreateGroupSmart(){
    const key = (document.getElementById('new_group_key').value || '').trim() ||
                (document.getElementById('tmpl_group_key').value || '').trim();
    const label = (document.getElementById('new_group_label').value || '').trim();
    const desc  = (document.getElementById('new_group_desc').value || '').trim();
    const order = parseInt(document.getElementById('new_group_order').value || '999', 10);
    const src   = document.getElementById('new_group_source').value;
    const rtype = document.getElementById('new_group_refer_type').value;

    if(!key){ _msgAt('adminStatus_group', 'Please choose a template or enter a key.', false); return; }

    const payload = { type_name: "{{ current_type }}", key, label, description: desc, order };
    if (src === 'biographies' && rtype) payload.refer_to = { source: 'biographies', type: rtype };

    try{
      const res = await fetch('/api/labels/admin/create_group', {
        method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify(payload)
      });
      const data = await res.json();
      if(!res.ok || !data.ok) throw new Error(data.error || res.statusText);
      _msgAt('adminStatus_group', 'Group created. Reloading‚Ä¶', true);
      setTimeout(()=>location.reload(), 600);
    }catch(e){
      _msgAt('adminStatus_group', 'Create group failed: ' + e.message, false);
    }
  }

  async function adminCreateOption(){
    const group_key = document.getElementById('opt_group_key').value;
    const id        = document.getElementById('opt_id').value.trim();
    const display   = document.getElementById('opt_display').value.trim();
    const desc      = document.getElementById('opt_desc').value.trim();
    const order     = parseInt(document.getElementById('opt_order').value || '999', 10);
    const image     = document.getElementById('opt_image').value.trim();

    if(!group_key || !id){ _msgAt('adminStatus_option','Group and id are required.', false); return; }

    try{
      const res = await fetch('/api/labels/admin/create_option', {
        method: 'POST', headers: {'Content-Type':'application/json'},
        body: JSON.stringify({ type_name: "{{ current_type }}", group_key, id, display, description: desc, order, image })
      });
      const data = await res.json();
      if(!res.ok || !data.ok) throw new Error(data.error || res.statusText);
      _msgAt('adminStatus_option','Option created. Reloading‚Ä¶', true);
      setTimeout(()=>location.reload(), 600);
    }catch(e){
      _msgAt('adminStatus_option','Create option failed: ' + e.message, false);
    }
  }

  async function adminCreateChildSmart(){
    const parent_key = document.getElementById('child_parent_key').value;
    const child_key  = document.getElementById('child_key').value.trim();
    const label      = document.getElementById('child_label').value.trim();
    const desc       = document.getElementById('child_desc').value.trim();
    const order      = parseInt(document.getElementById('child_order').value || '999', 10);
    const src        = document.getElementById('child_source').value;
    const rtype      = document.getElementById('child_refer_type').value;

    if(!parent_key || !child_key){ _msgAt('adminStatus_child','Parent and child key required.', false); return; }

    const payload = { type_name: "{{ current_type }}", parent_key, child_key, label, description: desc, order };
    if (src === 'biographies' && rtype) payload.refer_to = { source: 'biographies', type: rtype };

    try{
      const res = await fetch('/api/labels/admin/create_child_group', {
        method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify(payload)
      });
      const data = await res.json();
      if(!res.ok || !data.ok) throw new Error(data.error || res.statusText);
      _msgAt('adminStatus_child','Child group created. Reloading‚Ä¶', true);
      setTimeout(()=>location.reload(), 600);
    }catch(e){
      _msgAt('adminStatus_child','Create child failed: ' + e.message, false);
    }
  }

  document.addEventListener("DOMContentLoaded", () => {
    qsa("[id^='confidence_']").forEach(el=>{
      const id = el.id.replace("confidence_","");
      updateConfidence(uns(id));
    });
    updateSaveButtonState();

    qsa(".label-card[data-group]").forEach(el=>{
      el.setAttribute("tabindex","0");
      if(!el.getAttribute("onkeydown")){
        el.addEventListener("keydown", e=>{
          if(e.key==="Enter"||e.key===" "){ e.preventDefault(); el.click(); }
        });
      }
    });

    loadAdminBootstrap();
    wireSourceToggles();
  });

  /* ------------------------------ bios widget ------------------------------ */
  function renderBios(groupKey, bios) {
    const host = qs("#bios_for_" + safe(groupKey));
    if (!host) return;

    // Preserve any existing selection + confidence before we overwrite the DOM
    const prevHidden = qs("#input_" + safe(groupKey) + "_bio");
    const prevBioId = prevHidden ? (prevHidden.value || "").trim() : "";
    const prevConfEl = qs("#confidence_" + safe(groupKey) + "_bio");
    const prevConf = prevConfEl ? parseInt(prevConfEl.value || "100", 10) : 100;

    if (!bios || !bios.length) {
      host.innerHTML = `
        <div class="bio-suggestions">
          <div class="label-title">üìñ Linked Biographies ({{ current_type|replace('_',' ')|title }})</div>
          <div class="muted">No biographies found for the current selection.</div>
        </div>`;
      return;
    }

    const groupSafe = safe(groupKey);
    const cards = bios.map(b => `
      <div class="label-card"
          tabindex="0"
          data-group="${groupSafe}_bio"
          data-value="${b.id}"
          onclick="toggleBioSelection(this, 'input_${groupSafe}_bio')"
          onkeydown="if(event.key==='Enter'||event.key===' '){event.preventDefault(); this.click();}">
        <div><strong>${b.display || b.id}</strong></div>
        ${b.description ? `<div class="label-description">${b.description}</div>` : ""}
      </div>
    `).join("");

    host.innerHTML = `
      <div class="bio-suggestions">
        <div class="label-title">üìñ Linked Biographies ({{ current_type|replace('_',' ')|title }})</div>

        <input type="hidden"
              id="input_${groupSafe}_bio"
              name="selected_id_${groupKey}_bio"
              class="group-selection-tracker"
              value="${prevBioId}">

        <input type="text" class="label-search"
              placeholder="Search biographies‚Ä¶"
              oninput="filterLabels(this, '${groupSafe}_bio')"
              data-group="${groupSafe}_bio">

        <div class="label-options">${cards}</div>

        <div class="confidence-slider" style="margin-top:10px;">
          <label for="confidence_${groupSafe}_bio">üéØ Biography Match Confidence:</label><br>
          <input type="range"
                name="confidence_${groupKey}_bio"
                id="confidence_${groupSafe}_bio"
                min="0" max="100" value="${isFinite(prevConf) ? prevConf : 100}">
          <div class="confidence-display">
            <span id="confidence_display_${groupSafe}_bio">${isFinite(prevConf) ? prevConf : 100}%</span>
            <span id="confidence_level_${groupSafe}_bio"></span>
          </div>
        </div>
      </div>
    `;

    // Mark selection if there was one
    if (prevBioId) {
      const card = qs(`.label-card[data-group="${groupSafe}_bio"][data-value="${cssEscape(prevBioId)}"]`);
      if (card) card.classList.add("selected");
    }

    // ----- AUTO‚ÄëLINK exact match if enabled and nothing selected yet -----
    try {
      const autoOn = (AUTO_LINK && AUTO_LINK[groupKey]) ? true : false;
      if (autoOn) {
        const curSelInput = qs("#input_" + safe(groupKey));       // the label selection for this group
        const curLabelId = (curSelInput ? (curSelInput.value || "").trim() : "");
        const hiddenBio = qs("#input_" + groupSafe + "_bio");

        if (curLabelId && hiddenBio && !hiddenBio.value) {
          const pretty = curLabelId.replace(/_/g, " ").toLowerCase();
          const match = bios.find(b =>
            (b.id && b.id === curLabelId) ||
            ((b.display || "").toLowerCase() === pretty)
          );
          if (match) {
            // select it
            hiddenBio.value = match.id;
            const card = qs(`.label-card[data-group="${groupSafe}_bio"][data-value="${cssEscape(match.id)}"]`);
            if (card) card.classList.add("selected");
            // set confidence to 100 for exact auto‚Äëlink
            const confEl = qs("#confidence_" + groupSafe + "_bio");
            const confDisp = qs("#confidence_display_" + groupSafe + "_bio");
            const level = qs("#confidence_level_" + groupSafe + "_bio");
            if (confEl) confEl.value = 100;
            if (confDisp) confDisp.textContent = "100%";
            if (level) { level.textContent = "(Exact)"; level.style.color = "green"; }
          }
        }
      }
    } catch (_) {}

    initConfidenceFor(groupKey + "_bio");
    updateSaveButtonState();
  }

  /* ---------------------------- child group render ------------------------- */
  function renderChildGroup(parentKey, childKey, options) {
    const host = qs("#children_for_" + safe(parentKey));
    if (!host) return;

    const cards = options.map(opt => `
      <div class="label-card"
           id="card_${safe(childKey)}_${opt.id}"
           data-group="${childKey}"
           data-value="${opt.id}"
           tabindex="0"
           onclick="selectChild('${childKey}','${opt.id}')"
           onkeydown="if(event.key==='Enter'||event.key===' '){event.preventDefault(); this.click();}">
        ${ (opt.image || opt.image_url) ? `<img src="${opt.image || opt.image_url}" alt="${opt.display || opt.id}">` : "" }
        <div><strong>${opt.display || opt.id}</strong></div>
        ${opt.description ? `<div class="label-description">${opt.description}</div>` : ""}
      </div>
    `).join("");

    host.innerHTML = `
      <div class="label-group-box" id="group_${safe(childKey)}">
        <div class="label-title">
          ${titleCase(childKey.split('/').slice(-1)[0])}
          <button type="button" class="clear-btn" onclick="clearGroupUI('${childKey}')">Clear</button>
        </div>
        <input type="hidden"
               name="selected_id_${childKey}"
               id="input_${safe(childKey)}"
               class="group-selection-tracker"
               value="">
        <div class="label-options">${cards}</div>
        <div class="confidence-slider">
          <label for="confidence_${safe(childKey)}">üéØ Confidence:</label><br>
          <input type="range"
                 name="confidence_${childKey}"
                 id="confidence_${safe(childKey)}"
                 min="0" max="100" value="100">
          <div class="confidence-display">
            <span id="confidence_display_${safe(childKey)}">100%</span>
            <span id="confidence_level_${safe(childKey)}"></span>
          </div>
        </div>
        <div id="bios_for_${safe(childKey)}"></div>
      </div>
    `;
    initConfidenceFor(childKey);
    updateSaveButtonState();
  }

  /* ------------------------- clear/toggle helpers -------------------------- */
  function clearGroupUI(groupKey) {
    qsa(`.label-card[data-group="${groupKey}"]`).forEach(c => c.classList.remove("selected"));
    const hid = qs("#input_" + safe(groupKey));
    if (hid) hid.value = "";
    updateConfidence(groupKey);
    const cHost = qs("#children_for_" + safe(groupKey));
    if (cHost) cHost.innerHTML = "";
    const bHost = qs("#bios_for_" + safe(groupKey));
    if (bHost) bHost.innerHTML = "";
    updateSaveButtonState();
  }

  function selectLabel(groupKey, labelId, isChild){
    const hid = qs("#input_" + safe(groupKey));
    const current = (hid && hid.value) ? String(hid.value) : "";

    // toggle off
    if (current === String(labelId)) { 
      clearGroupUI(groupKey); 
      return; 
    }

    // mark selection
    qsa(`.label-card[data-group="${groupKey}"]`).forEach(c => c.classList.remove("selected"));
    const card = qs(`#card_${safe(groupKey)}_${cssEscape(labelId)}`);
    if (card) card.classList.add("selected");
    if (hid)  hid.value = labelId;

    updateSaveButtonState();

    // --- if this was a child group, just refresh bios for that child and exit
    if (isChild) {
      fetchBiosFor(groupKey);
      return;
    }

    // --- parent group flow:
    // 1) DO NOT clear the parent bios anymore (keep them visible)
    // 2) Clear any previously rendered child container
    const cHost = qs("#children_for_" + safe(groupKey));
    if (cHost) cHost.innerHTML = "";

    // 3) Refresh parent bios for the new parent selection
    fetchBiosFor(groupKey);

    // 4) Ask server for child options and render child group (below the parent)
    fetch("/api/labels/children", {
      method: "POST",
      headers: {"Content-Type": "application/json"},
      body: JSON.stringify({ type_name: CURRENT_TYPE, group_key: groupKey, selected_id: labelId })
    })
    .then(r => r.ok ? r.json() : Promise.reject())
    .then(json => {
      if (!json || !json.ok) return;
      if (json.child_key && Array.isArray(json.options) && json.options.length) {
        renderChildGroup(groupKey, json.child_key, json.options);
        setTimeout(() => {
          const el = qs("#group_" + safe(json.child_key));
          if (el) el.scrollIntoView({behavior: "smooth", block: "start"});
        }, 30);
      }
    })
    .catch(()=>{});
  }

function selectChild(groupKey, labelId){
  const hid = qs("#input_" + safe(groupKey));
  const current = (hid && hid.value) ? String(hid.value) : "";
  if (current === String(labelId)) { clearGroupUI(groupKey); return; }

  qsa(`.label-card[data-group="${groupKey}"]`).forEach(c => c.classList.remove("selected"));
  const card = qs(`#card_${safe(groupKey)}_${cssEscape(labelId)}`);
  if (card) card.classList.add("selected");
  if (hid) hid.value = labelId;

  updateSaveButtonState();

  // ‚úÖ Do NOT clear the parent bios; keep both parent + child widgets alive
  // Optionally refresh the child bios to reflect the new selection:
  fetchBiosFor(groupKey);
}

  function fetchBiosFor(groupKey){
    fetch("/api/labels/suggest_biographies", {
      method: "POST",
      headers: {"Content-Type": "application/json"},
      body: JSON.stringify({ type_name: CURRENT_TYPE, group_key: groupKey, selections: collectSelectionsMap() })
    })
    .then(r => r.ok ? r.json() : Promise.reject())
    .then(json => { if (json && json.ok) renderBios(groupKey, json.bios || []); })
    .catch(()=>{});
  }

  function collectSelectionsMap() {
    const map = {};
    qsa("input.group-selection-tracker[id^='input_']").forEach(inp => {
      const key  = uns(inp.id.replace(/^input_/, ""));
      const val  = (inp.value || "").trim();
      if (val) map[key] = val;
    });
    return map;
  }
  function collectCurrentSelectionsList() {
    const arr = [];
    qsa(".group-selection-tracker").forEach(input => {
      const key = (input.name || "").replace(/^selected_id_/, "");
      const id  = (input.value || "").trim();
      if (!id) return;
      const confEl = qs("#confidence_" + safe(key));
      const conf = confEl ? parseInt(confEl.value || "100", 10) : 100;
      arr.push({ label_type: key.split("/").pop(), id, confidence: conf });
    });
    return arr;
  }

  function filterLabels(input, groupKey){
    const q = (input.value||"").toLowerCase();
    let shown = 0;
    qsa(`.label-card[data-group="${groupKey}"]`).forEach(card=>{
      const t = card.innerText.toLowerCase();
      const match = t.includes(q);
      if (match && shown < 12){ card.style.display='flex'; shown++; }
      else { card.style.display='none'; }
    });
  }

  function toggleBioSelection(card, hiddenId){
    const hidden = qs("#" + hiddenId);
    if(!hidden) return;
    const val   = card.getAttribute("data-value");
    const group = card.getAttribute("data-group");
    const cards = qsa(`.label-card[data-group="${group}"]`);

    if(hidden.value === val){
      hidden.value = "";
      card.classList.remove("selected");
    } else {
      cards.forEach(c=>c.classList.remove("selected"));
      hidden.value = val;
      card.classList.add("selected");
    }
    updateSaveButtonState();
  }

  function updateSaveButtonState(){
    const trackers = document.querySelectorAll('.group-selection-tracker');
    const gptEl = document.getElementById('gpt_selected_labels_json');
    const btn = document.getElementById('saveButton');

    const hasManual = Array.from(trackers).some(i => (i.value||'').trim() !== '');
    let hasGPT = false;
    try {
      const arr = JSON.parse(gptEl?.value || '[]');
      hasGPT = Array.isArray(arr) && arr.length > 0;
    } catch(_) {}

    if(!btn) return;
    if(hasManual || hasGPT){
      btn.textContent = '‚úÖ Save All Selections';
      btn.style.backgroundColor = '#4CAF50';
    }else{
      btn.textContent = '‚û°Ô∏è Move to next page with no labels selected';
      btn.style.backgroundColor = '#6c63ff';
    }
  }

  function renderGptSuggestions(items) {
    const wrap = document.getElementById('gptSuggestions');
    if (!wrap) return;

    wrap.innerHTML = '';
    const chosen = new Map();

    function syncHidden() {
      const arr = Array.from(chosen.values());
      document.getElementById('gpt_selected_labels_json').value = JSON.stringify(arr);
      updateSaveButtonState?.();
    }

    (items || []).forEach(s => {
      const sug = {
        id: s.id,
        label_type: s.label_type || s.group_key || s.type || '',
        confidence: Number.isFinite(s.confidence) ? s.confidence : 100,
        display: s.display || s.id,
        description: s.description || ''
      };

      const card = document.createElement('div');
      card.className = 'sugg-card';
      card.setAttribute('role', 'button');
      card.innerHTML = `
        <div><strong>${sug.display}</strong></div>
        ${sug.description ? `<div class="label-description">${sug.description}</div>` : ''}
      `;

      card.onclick = async () => {
        const key = `${sug.label_type||''}::${sug.id}`;
        const wasSelected = chosen.has(key);
        if (wasSelected) {
          chosen.delete(key);
          card.classList.remove('selected');
        } else {
          chosen.set(key, sug);
          card.classList.add('selected');
          await applySuggestionToGroups(sug);
        }
        syncHidden();
      };

      wrap.appendChild(card);
    });

    document.getElementById('gpt_selected_labels_json').value = '[]';
    updateSaveButtonState?.();
  }

  async function suggestLabels(currentType, groupPrefixes = []) {
    const btn  = qs("#gptSuggestBtn");
    const hint = qs("#gptHint");
    const promptEl = qs("#labelPromptInput");
    const prompt = (promptEl?.value || "").trim();

    if (!prompt) { alert("Tell me a bit about this " + currentType.replaceAll("_"," ") + " first."); return; }

    try {
      if (btn) btn.disabled = true;
      if (hint) hint.style.display = "inline";

      const res = await fetch("/api/suggest_labels", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          type: currentType,
          prompt,
          context: { selections: collectCurrentSelectionsList() },
          group_prefixes: groupPrefixes
        })
      });
      if (!res.ok) throw new Error(await res.text());
      const data = await res.json();
      renderGptSuggestions(Array.isArray(data.labels) ? data.labels : []);
    } catch(e){
      console.error(e);
      alert("Sorry ‚Äî could not get suggestions.");
    } finally {
      if (btn) btn.disabled = false;
      if (hint) hint.style.display = "none";
    }
  }
  window.suggestLabels = suggestLabels;

  async function applySuggestionToGroups(sug) {
    if (!sug || !sug.id) return false;

    let direct = document.querySelector(`.label-card[data-value="${cssEscape(sug.id)}"]`);
    if (direct) { direct.click(); return true; }

    const res = await fetch('/api/labels/resolve_option', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({ type_name: CURRENT_TYPE, option_id: sug.id })
    });
    if (!res.ok) return false;
    const data = await res.json();
    if (!data.ok) return false;

    if (data.parent_id) {
      const rawGroup = data.group_key.split('/').slice(0, -1).join('/') || data.group_key;
      const parentCard = document.querySelector(`#card_${safe(rawGroup)}_${cssEscape(data.parent_id)}`);
      if (parentCard) parentCard.click();

      const targetKey  = data.child_key || data.group_key;
      const targetSafe = safe(targetKey);
      const targetId   = data.child_id || sug.id;

      let tries = 0;
      const t = setInterval(() => {
        const c = document.querySelector(`#card_${targetSafe}_${cssEscape(targetId)}`);
        if (c) { c.click(); clearInterval(t); }
        if (++tries > 20) clearInterval(t);
      }, 100);
      return true;
    }

    if (data.group_key) {
      const card = document.querySelector(`#card_${safe(data.group_key)}_${cssEscape(sug.id)}`);
      if (card) { card.click(); return true; }
    }
    return false;
  }

  async function _postJSON(url, body){
    const res = await fetch(url, {
      method: "POST",
      headers: {"Content-Type":"application/json"},
      body: JSON.stringify(body)
    });
    let data = {};
    try { data = await res.json(); } catch(_){}
    if(!res.ok || !data.ok){ throw new Error(data.error || res.statusText); }
    return data;
  }
  function _msg(s, ok=true){
    const el = document.getElementById("adminStatus");
    if(!el) return;
    el.textContent = s;
    el.style.color = ok ? "green" : "crimson";
  }

  document.addEventListener('change', (e) => {
    if (e.target && e.target.classList.contains('auto-link-toggle')) {
      const g = e.target.getAttribute('data-group').replace(/__/g,'/');
      AUTO_LINK[g] = !!e.target.checked;
      // Re-run auto-link attempt for current list
      try { _tryAutoLink(g); } catch(_) {}
    }
  });

</script>

</body>
</html>