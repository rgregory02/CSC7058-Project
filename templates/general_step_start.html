<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>Start General Wizard</title>
  <link rel="stylesheet" href="/static/styles.css">
  <style>
    :root{
      --bg:#f6f7fb; --card:#fff; --muted:#6b7280; --line:#e5e7eb; --ink:#111827;
      --pill:#eef0f7; --pill-ink:#374151; --accent:#6c63ff;
    }
    body{background:var(--bg); font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
    .box{max-width:860px;margin:36px auto;background:var(--card);padding:28px;border-radius:14px;box-shadow:0 8px 24px rgba(0,0,0,.06)}
    h1{margin:0 0 4px}
    .hint{color:var(--muted);margin-bottom:16px}
    .row{margin:14px 0}
    .label{font-weight:700;display:block;margin-bottom:6px}
    select,input[type="text"]{width:100%;max-width:560px;padding:10px;border:1px solid var(--line);border-radius:10px}
    .stack{display:grid;gap:10px;max-width:560px}
    .chips{display:flex;gap:8px;align-items:center;color:var(--muted);font-size:.92em}
    .chip{background:var(--pill);color:var(--pill-ink);padding:4px 10px;border-radius:999px}
    .toolbar{display:flex;gap:8px;align-items:center}
    .btn{display:inline-block;padding:10px 14px;border-radius:10px;background:var(--pill);color:#333;text-decoration:none;border:1px solid var(--line);font-weight:600}
    .btn.primary{background:var(--accent);border-color:var(--accent);color:#fff}
    .btn:disabled{opacity:.6;cursor:not-allowed}
    .search{display:none}
    .search input{width:100%;max-width:560px;padding:10px;border:1px solid var(--line);border-radius:10px}
    .small{color:var(--muted);font-size:.9em}
    .list{max-height:260px;overflow:auto;border:1px solid var(--line);border-radius:10px;padding:6px 6px 2px 6px;display:none}
    .list button{display:block;width:100%;text-align:left;padding:8px 10px;border:0;background:#fff;border-radius:8px;margin:4px 0}
    .list button:hover{background:#f8f9ff}
    .muted{color:var(--muted)}
    .sr-only{position:absolute;left:-10000px;top:auto;width:1px;height:1px;overflow:hidden}
  </style>
</head>
{% set EMBED = request.args.get('embed') in ('1','true','True') %}
{% if EMBED %}<base target="_top">{% endif %}
<body data-embed="{{ '1' if EMBED else '0' }}">

  <div class="box">
    <h1>ðŸ§© Start General Wizard</h1>
    <div class="hint">Pick a <strong>type</strong>, then either select an existing biography or create a new one.</div>

    <form method="POST" id="startForm">
      <div class="row">
        <label class="label">Type</label>
        <div class="stack">
          <select id="typeSelect" name="type_name" required>
            <option value="" disabled {{ '' if preselected_type else 'selected' }}>Choose a typeâ€¦</option>
            {% for t in types %}
              <option value="{{ t }}" {{ 'selected' if preselected_type==t else '' }}>
                {{ t|replace('_',' ')|title }}
              </option>
            {% endfor %}
          </select>
          <div class="chips small">
            <span class="chip">Only bios for the selected type will be shown</span>
          </div>
        </div>
      </div>

      <div class="row">
  <label class="label">Choose existing biography (optional)</label>
  <div class="stack">
    <!-- Keep a control named 'bio_id' for form POST, but hide it -->
    <select id="bioSelect" name="bio_id" class="sr-only" aria-hidden="true" tabindex="-1">
      <option value="">â€” none â€”</option>
    </select>

    <!-- Search only appears when expanded -->
    <div class="search" id="bioSearchWrap" style="display:none">
      <input id="bioSearch" type="text" placeholder="Search biosâ€¦">
    </div>

    <!-- Quick buttons list (first 3, or all when expanded) -->
    <div class="list" id="bioQuickList" style="display:none"></div>

    <!-- Toolbar for show more/fewer + clear -->
    <div class="toolbar" id="bioMoreToolbar" style="display:none">
      <button type="button" class="btn link" id="toggleMoreBtn">Show more</button>
      <button type="button" class="btn link" id="clearBioBtn">Clear</button>
    </div>

    <div class="small muted" id="bioEmptyMsg" style="display:none">No biographies for this type yet.</div>
  </div>
</div>

      <div class="row">
        <label class="label">â€¦or create new biography</label>
        <input type="text" name="new_bio_name" id="newBioName" placeholder="e.g., Royal Victoria Hospital">
        <div class="small muted">Leave blank if youâ€™re selecting an existing biography above.</div>
      </div>

      <div class="row toolbar">
        <button type="submit" class="btn primary">Continue</button>
        <a class="btn" href="{{ url_for('dashboard') }}">Cancel</a>
      </div>
    </form>
  </div>

<script>
(function(){
  const typeSel     = document.getElementById('typeSelect');
  const bioSel      = document.getElementById('bioSelect');         // hidden select used for POST
  const searchWrap  = document.getElementById('bioSearchWrap');
  const searchInput = document.getElementById('bioSearch');
  const quickList   = document.getElementById('bioQuickList');
  const emptyMsg    = document.getElementById('bioEmptyMsg');
  const moreBar     = document.getElementById('bioMoreToolbar');     // toolbar container
  const toggleBtn   = document.getElementById('toggleMoreBtn');      // "Show more" / "Show fewer"
  const clearBtn    = document.getElementById('clearBioBtn');        // Clear

  const COLLAPSE_COUNT = 3;

  let biosAll    = [];
  let expanded   = false;
  let selectedId = "";

  function setSelected(id){
    selectedId = id || "";
    // reflect into the hidden select used for form submit
    if (!bioSel.querySelector(`option[value="${CSS.escape(selectedId)}"]`)) {
      const opt = document.createElement('option');
      opt.value = selectedId;
      opt.textContent = selectedId;
      bioSel.appendChild(opt);
    }
    bioSel.value = selectedId;

    // update highlight in quick list
    [...quickList.querySelectorAll('button[data-id]')].forEach(b=>{
      b.classList.toggle('selected', b.getAttribute('data-id') === selectedId);
    });
  }

  function render(){
    const q = (searchInput.value || "").trim().toLowerCase();
    const base = q ? biosAll.filter(b => (b.name||b.id).toLowerCase().includes(q)) : biosAll;

    const items = expanded ? base : base.slice(0, COLLAPSE_COUNT);
    quickList.innerHTML = items.map(it => `
      <button type="button" data-id="${it.id}" class="${it.id===selectedId?'selected':''}">
        ${(it.name || it.id)}
      </button>
    `).join("");

    quickList.style.display = items.length ? 'block' : 'none';
    emptyMsg.style.display  = biosAll.length ? 'none' : 'block';

    // Toggle / counts
    const remaining = Math.max(0, base.length - COLLAPSE_COUNT);
    if (base.length > COLLAPSE_COUNT) {
      moreBar.style.display = 'flex';
      toggleBtn.textContent = expanded ? 'Show fewer' : `Show more (${remaining})`;
    } else {
      moreBar.style.display = 'none';
    }

    // Search only when expanded and useful
    searchWrap.style.display = (expanded && biosAll.length > COLLAPSE_COUNT) ? 'block' : 'none';
  }

  async function loadBiosForType(t){
    // reset UI
    biosAll = [];
    expanded = false;
    selectedId = "";
    bioSel.innerHTML = '<option value="">â€” none â€”</option>';
    searchInput.value = "";
    quickList.innerHTML = "";
    quickList.style.display = 'none';
    moreBar.style.display = 'none';
    searchWrap.style.display = 'none';
    emptyMsg.style.display = 'none';

    if (!t) return;

    try{
      const res = await fetch(`/api/bios/list?type=${encodeURIComponent(t)}`);
      const data = await res.json();
      if(!data.ok) throw new Error(data.error || 'Failed');
      biosAll = data.items || [];
    }catch(e){
      console.error(e);
      biosAll = [];
    }
    render();
  }

  // Events
  typeSel.addEventListener('change', ()=> loadBiosForType(typeSel.value));

  quickList.addEventListener('click', e=>{
    const btn = e.target.closest('button[data-id]');
    if (!btn) return;
    setSelected(btn.getAttribute('data-id'));
  });

  toggleBtn?.addEventListener('click', ()=>{
    expanded = !expanded;
    render();
  });

  clearBtn?.addEventListener('click', ()=>{
    setSelected("");
  });

  searchInput?.addEventListener('input', render);

  // initial load if a type is preselected
  if (typeSel.value) loadBiosForType(typeSel.value);
})();
</script>

</body>
</html>