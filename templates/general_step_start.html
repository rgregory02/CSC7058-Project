<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>Start General Wizard</title>
  <link rel="stylesheet" href="/static/styles.css">
  <style>
    :root{
      --bg:#f6f7fb; --card:#fff; --muted:#6b7280; --line:#e5e7eb; --ink:#111827;
      --pill:#eef0f7; --pill-ink:#374151; --accent:#6c63ff;
    }
    body{background:var(--bg); font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
    .box{max-width:860px;margin:36px auto;background:var(--card);padding:28px;border-radius:14px;box-shadow:0 8px 24px rgba(0,0,0,.06)}
    h1{margin:0 0 4px}
    .hint{color:var(--muted);margin-bottom:16px}
    .row{margin:14px 0}
    .label{font-weight:700;display:block;margin-bottom:6px}
    select,input[type="text"]{width:100%;max-width:560px;padding:10px;border:1px solid var(--line);border-radius:10px}
    .stack{display:grid;gap:10px;max-width:560px}
    .chips{display:flex;gap:8px;align-items:center;color:var(--muted);font-size:.92em}
    .chip{background:var(--pill);color:var(--pill-ink);padding:4px 10px;border-radius:999px}
    .toolbar{display:flex;gap:8px;align-items:center}
    .btn{display:inline-block;padding:10px 14px;border-radius:10px;background:var(--pill);color:#333;text-decoration:none;border:1px solid var(--line);font-weight:600}
    .btn.primary{background:var(--accent);border-color:var(--accent);color:#fff}
    .btn.link{background:transparent;border:0;color:var(--accent);padding:6px 8px}
    .btn:disabled{opacity:.6;cursor:not-allowed}
    .search{display:none}
    .search input{width:100%;max-width:560px;padding:10px;border:1px solid var(--line);border-radius:10px}
    .small{color:var(--muted);font-size:.9em}
    .list{max-height:260px;overflow:auto;border:1px solid var(--line);border-radius:10px;padding:6px;display:none}
    .list button{
      display:block;width:100%;text-align:left;padding:10px 12px;border:0;background:#fff;border-radius:8px;margin:4px 0
    }
    .list button:hover{background:#f8f9ff}
    .list button.selected{outline:2px solid var(--accent);background:#f5f6ff}
    .muted{color:var(--muted)}
    .sr-only{position:absolute;left:-10000px;top:auto;width:1px;height:1px;overflow:hidden}
    .sub{display:block;font-size:.85em;color:#6b7280;margin-top:2px}
  </style>
</head>
{% set EMBED = request.args.get('embed') in ('1','true','True') %}
{% if EMBED %}<base target="_top">{% endif %}
<body data-embed="{{ '1' if EMBED else '0' }}">

  <div class="box">
    <h1>üß© Start General Wizard</h1>
    <div class="hint">Pick a <strong>type</strong>, then either select an existing biography or create a new one.</div>

    <form method="POST" id="startForm">
      <div class="row">
        <label class="label">Type</label>
        <div class="stack">
          <select id="typeSelect" name="type_name" required>
            <option value="" disabled {{ '' if preselected_type else 'selected' }}>Choose a type‚Ä¶</option>
            {% for t in types %}
              <option value="{{ t }}" {{ 'selected' if preselected_type==t else '' }}>
                {{ t|replace('_',' ')|title }}
              </option>
            {% endfor %}
          </select>
          <div class="chips small">
            <span class="chip">Only bios for the selected type will be shown</span>
          </div>
        </div>
      </div>

      <div class="row">
        <label class="label">Choose existing biography (optional)</label>
        <div class="stack">
          <!-- Hidden select used for POST. Value must be the full key (supports nested). -->
          <select id="bioSelect" name="bio_id" class="sr-only" aria-hidden="true" tabindex="-1">
            <option value="">‚Äî none ‚Äî</option>
          </select>

          <!-- Search appears when expanded -->
          <div class="search" id="bioSearchWrap">
            <input id="bioSearch" type="text" placeholder="Search bios‚Ä¶">
          </div>

          <!-- Quick list -->
          <div class="list" id="bioQuickList"></div>

          <!-- Toolbar -->
          <div class="toolbar" id="bioMoreToolbar" style="display:none">
            <button type="button" class="btn link" id="toggleMoreBtn">Show more</button>
            <button type="button" class="btn link" id="clearBioBtn">Clear</button>
          </div>

          <div class="small muted" id="bioEmptyMsg" style="display:none">No biographies for this type yet.</div>
        </div>
      </div>

      <div class="row">
        <label class="label">‚Ä¶or create new biography</label>
        <input type="text" name="new_bio_name" id="newBioName" placeholder="e.g., Royal Victoria Hospital">
        <div class="small muted">Leave blank if you‚Äôre selecting an existing biography above.</div>
      </div>

      <div class="row toolbar">
        <button type="submit" class="btn primary">Continue</button>
        <a class="btn" href="{{ url_for('dashboard') }}">Cancel</a>
      </div>
    </form>
  </div>

<script>
(function(){
  const typeSel     = document.getElementById('typeSelect');
  const bioSel      = document.getElementById('bioSelect');         // hidden select used for POST
  const searchWrap  = document.getElementById('bioSearchWrap');
  const searchInput = document.getElementById('bioSearch');
  const quickList   = document.getElementById('bioQuickList');
  const emptyMsg    = document.getElementById('bioEmptyMsg');
  const moreBar     = document.getElementById('bioMoreToolbar');
  const toggleBtn   = document.getElementById('toggleMoreBtn');
  const clearBtn    = document.getElementById('clearBioBtn');
  const newNameInp  = document.getElementById('newBioName');

  const COLLAPSE_COUNT = 3;

  let biosAll    = [];
  let expanded   = false;
  let selectedKey = "";

  function ensureOption(val, label){
    if (!bioSel.querySelector(`option[value="${CSS.escape(val)}"]`)) {
      const opt = document.createElement('option');
      opt.value = val;
      opt.textContent = label || val;
      bioSel.appendChild(opt);
    }
  }

  function setSelected(key){
    selectedKey = key || "";
    ensureOption(selectedKey, selectedKey);
    bioSel.value = selectedKey;

    // UX: if selecting an existing bio, clear the "new name" field to avoid ambiguity
    if (selectedKey && newNameInp) newNameInp.value = "";

    // update highlight in quick list
    [...quickList.querySelectorAll('button[data-key]')].forEach(b=>{
      b.classList.toggle('selected', b.getAttribute('data-key') === selectedKey);
    });
  }

  function displayName(it){
    const name = it.name || it.key || it.id || '';
    const key  = it.key || it.id || '';
    if (!key.includes('/')) return name; // flat
    // Show parent path subtly for nested items
    const parent = key.split('/').slice(0,-1).join(' / ');
    const leaf   = key.split('/').slice(-1)[0];
    return `${name}<span class="sub">üìÅ ${parent} / <strong>${leaf}</strong></span>`;
  }

  function render(){
    const q = (searchInput.value || "").trim().toLowerCase();
    const base = q
      ? biosAll.filter(b => ((b.name||'') + ' ' + (b.key||b.id||'')).toLowerCase().includes(q))
      : biosAll;

    const items = expanded ? base : base.slice(0, COLLAPSE_COUNT);

    quickList.innerHTML = items.map(it => {
      const key = it.key || it.id;               // always prefer key
      const html = displayName(it);
      return `<button type="button" data-key="${key}" class="${key===selectedKey?'selected':''}">${html}</button>`;
    }).join("");

    quickList.style.display = items.length ? 'block' : 'none';
    emptyMsg.style.display  = biosAll.length ? 'none' : 'block';

    // Toggle / counts
    const remaining = Math.max(0, base.length - COLLAPSE_COUNT);
    if (base.length > COLLAPSE_COUNT) {
      moreBar.style.display = 'flex';
      toggleBtn.textContent = expanded ? 'Show fewer' : `Show more (${remaining})`;
    } else {
      moreBar.style.display = 'none';
    }

    // Search only when expanded and there‚Äôs something to search
    searchWrap.style.display = (expanded && biosAll.length > COLLAPSE_COUNT) ? 'block' : 'none';
  }

  async function loadBiosForType(t){
    // reset UI
    biosAll = [];
    expanded = false;
    selectedKey = "";
    bioSel.innerHTML = '<option value="">‚Äî none ‚Äî</option>';
    if (searchInput) searchInput.value = "";
    quickList.innerHTML = "";
    quickList.style.display = 'none';
    moreBar.style.display = 'none';
    searchWrap.style.display = 'none';
    emptyMsg.style.display = 'none';

    if (!t) return;

    try{
      const res = await fetch(`/api/bios/list?type=${encodeURIComponent(t)}&recursive=1&limit=500`);
      const data = await res.json();
      if(!data.ok) throw new Error(data.error || 'Failed');
      // normalise: ensure we have key for each item
      biosAll = (data.items || []).map(x => ({...x, key: x.key || x.id}));
    }catch(e){
      console.error(e);
      biosAll = [];
    }
    render();
  }

  // Events
  typeSel.addEventListener('change', ()=> loadBiosForType(typeSel.value));

  quickList.addEventListener('click', e=>{
    const btn = e.target.closest('button[data-key]');
    if (!btn) return;
    setSelected(btn.getAttribute('data-key'));
  });

  toggleBtn?.addEventListener('click', ()=>{
    expanded = !expanded;
    render();
  });

  clearBtn?.addEventListener('click', ()=>{
    setSelected("");
  });

  searchInput?.addEventListener('input', render);

  // initial load if a type is preselected
  if (typeSel.value) loadBiosForType(typeSel.value);
})();
</script>

</body>
</html>